From 8309431d3572fb25b6e34731cc1219aeb1d43390 Mon Sep 17 00:00:00 2001
From: MengLi <meng.li@windriver.com>
Date: Wed, 26 Jun 2019 15:37:12 +0800
Subject: [PATCH 905/909] ASoC: Modify check condition of multiple bindings of
 components

commit e27c2e3bb765958c217e46429776a0386c5b089f from
https://github.com/CogentEmbedded/meta-rcar.git

https://patchwork.kernel.org/patch/7385501/
...and some more hacks to bind one component (with several DAIs)
to more than one sound card.

KF has 4 sound cards (pcm3168a, ak4613, radio, wl18xx) and just one
compinent ec500000.sound that can not be bound to all 4 cards.
This is a lack of current implementation of sound/soc/sh/rcar/* ASoC stack
The ec500000.sound resources (PCM/DMA, dais) needs to be shared between
all 4 sound cards if we want all cards work runtime.
Or we have to enable only one of them in dts file as it is designed.

Signed-off-by: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 include/sound/soc.h  |  1 +
 sound/soc/soc-core.c | 10 +++++++---
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/include/sound/soc.h b/include/sound/soc.h
index 1378dcd2128a..a02505fb1611 100644
--- a/include/sound/soc.h
+++ b/include/sound/soc.h
@@ -817,6 +817,7 @@ struct snd_soc_component {
 
 	unsigned int active;
 
+	unsigned int registered_as_component:1;
 	unsigned int suspended:1; /* is in suspend PM state */
 
 	struct list_head list;
diff --git a/sound/soc/soc-core.c b/sound/soc/soc-core.c
index 89f8da52ddc6..d39c2d3c4483 100644
--- a/sound/soc/soc-core.c
+++ b/sound/soc/soc-core.c
@@ -1230,7 +1230,8 @@ static int soc_probe_component(struct snd_soc_card *card,
 		return 0;
 
 	if (component->card) {
-		if (component->card != card) {
+		if (component->card != card &&
+			component->registered_as_component) {
 			dev_err(component->dev,
 				"Trying to bind component to card \"%s\" but is already bound to card \"%s\"\n",
 				card->name, component->card->name);
@@ -1362,7 +1363,6 @@ static int soc_probe_link_components(struct snd_soc_card *card,
 
 	for_each_rtdcom(rtd, rtdcom) {
 		component = rtdcom->component;
-
 		if (component->driver->probe_order == order) {
 			ret = soc_probe_component(card, component);
 			if (ret < 0)
@@ -3039,6 +3039,9 @@ int snd_soc_add_component(struct device *dev,
 	if (ret)
 		goto err_free;
 
+	if (num_dai == 1)
+		component->registered_as_component = true;
+
 	if (component_driver->endianness) {
 		for (i = 0; i < num_dai; i++) {
 			convert_endianness_formats(&dai_drv[i].playback);
@@ -3092,7 +3095,8 @@ static int __snd_soc_unregister_component(struct device *dev)
 
 	mutex_lock(&client_mutex);
 	list_for_each_entry(component, &component_list, list) {
-		if (dev != component->dev)
+		if (dev != component->dev ||
+			!component->registered_as_component)
 			continue;
 
 		snd_soc_tplg_component_remove(component, SND_SOC_TPLG_INDEX_ALL);
-- 
2.17.1

