From 7cc0e2dbb57d93f8856a814fc30c8594aa772610 Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Thu, 12 Apr 2018 14:51:07 +0900
Subject: [PATCH 330/909] drm: bridge/dw-hdmi: Add re-write of vsync pulse
 width

commit 50d9b1ce91cf928c99a6a25129e5fd2c678c1809 from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

According to H/W manual in R-Car, vsync pulse width must
be set again after setting tmdsclk_disable to 0.
If it is not written again, the noise may be occurred in a monitor.
This patch corrects it.

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/bridge/synopsys/dw-hdmi.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/gpu/drm/bridge/synopsys/dw-hdmi.c b/drivers/gpu/drm/bridge/synopsys/dw-hdmi.c
index 15ea549874f1..16c45305fe7f 100644
--- a/drivers/gpu/drm/bridge/synopsys/dw-hdmi.c
+++ b/drivers/gpu/drm/bridge/synopsys/dw-hdmi.c
@@ -1650,6 +1650,18 @@ static void hdmi_av_composer(struct dw_hdmi *hdmi,
 	hdmi_writeb(hdmi, vsync_len, HDMI_FC_VSYNCINWIDTH);
 }
 
+static void hdmi_vsync_in_width(struct dw_hdmi *hdmi,
+				const struct drm_display_mode *mode)
+{
+	int vsync_len = mode->vsync_end - mode->vsync_start;
+
+	if (mode->flags & DRM_MODE_FLAG_INTERLACE)
+		vsync_len /= 2;
+
+	/* Set up VSYNC active edge delay (in lines) */
+	hdmi_writeb(hdmi, vsync_len, HDMI_FC_VSYNCINWIDTH);
+}
+
 /* HDMI Initialization Step B.4 */
 static void dw_hdmi_enable_video_path(struct dw_hdmi *hdmi)
 {
@@ -1803,6 +1815,10 @@ static int dw_hdmi_setup(struct dw_hdmi *hdmi, struct drm_display_mode *mode)
 	/* HDMI Initialization Step B.3 */
 	dw_hdmi_enable_video_path(hdmi);
 
+	/* Rewrite Vsync width */
+	if (hdmi->plat_data->dev_type == RCAR_HDMI)
+		hdmi_vsync_in_width(hdmi, mode);
+
 	if (hdmi->sink_has_audio) {
 		dev_dbg(hdmi->dev, "sink has audio support\n");
 
-- 
2.17.1

