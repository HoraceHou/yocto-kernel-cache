From e0e8e10526b354bbc3a0ffa5f7e97158de410469 Mon Sep 17 00:00:00 2001
From: Masaharu Hayakawa <masaharu.hayakawa.ry@renesas.com>
Date: Wed, 22 Nov 2017 12:05:18 +0900
Subject: [PATCH 208/909] mmc: renesas_sdhi: Add data timeout error detection

commit 1714239a51dc068b1f1603fcfc83fd6621bcc1c8 from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

SDHI HW manual rev.0.18, timeout is added to the re-tuning condition.
The difference in re-tuning conditions is as follows.

Before: CMD, CRC, END error
After : CMD, CRC, END, Timeout error

Currently, timeout is not checked for data transfer command.
If the temperature condition changes, the data cannot be acquired
correctly and timeout may occur.
Therefore, this adds timeout error check.

Signed-off-by: Masaharu Hayakawa <masaharu.hayakawa.ry@renesas.com>
[saito: rework commit message.]
Signed-off-by: Takeshi Saito <takeshi.saito.xv@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mmc/host/renesas_sdhi_internal_dmac.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/mmc/host/renesas_sdhi_internal_dmac.c b/drivers/mmc/host/renesas_sdhi_internal_dmac.c
index 7b1e51c99342..2c3168ab9c9b 100644
--- a/drivers/mmc/host/renesas_sdhi_internal_dmac.c
+++ b/drivers/mmc/host/renesas_sdhi_internal_dmac.c
@@ -211,7 +211,8 @@ static void renesas_sdhi_internal_dmac_issue_tasklet_fn(unsigned long arg)
 {
 	struct tmio_mmc_host *host = (struct tmio_mmc_host *)arg;
 
-	tmio_mmc_enable_mmc_irqs(host, TMIO_STAT_DATAEND);
+	tmio_mmc_enable_mmc_irqs(host, TMIO_STAT_DATAEND |
+				 TMIO_STAT_DATATIMEOUT);
 
 	/* start the DMAC */
 	renesas_sdhi_internal_dmac_dm_write(host, DM_CM_DTRAN_CTRL,
-- 
2.17.1

