From e482d230b466874440a2f067f3ba4ab84c7f4fb9 Mon Sep 17 00:00:00 2001
From: Hiromitsu Yamasaki <hiromitsu.yamasaki.ym@renesas.com>
Date: Fri, 15 Dec 2017 11:40:54 +0900
Subject: [PATCH 178/909] serial: sh-sci: Fix transfer sequence of unsupport
 DMA transfer

commit 7e52a3e6a91194e99a2bca9b4e7bc915b8b2410e from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

This patchs was created based on commit e9bad4f9ec44 ("serial: sh-sci:
Fix transfer sequence of unsupport DMA transfer")

In several R-Car SoC, the channel which is supporting the DMA transfer,
and the channel which is not supporting the DMA transfer are present in
(H)SCIx device.

On this SoC, when a DMA transfer of (H)SCIx device is enabled,
the following errors occur frequently:

    sh-sci xxx: dma_request_slave_channel failed

Signed-off-by: Hiromitsu Yamasaki <hiromitsu.yamasaki.ym@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/tty/serial/sh-sci.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/tty/serial/sh-sci.c b/drivers/tty/serial/sh-sci.c
index d9a5d8f2aaa6..8c9707cc5a5c 100644
--- a/drivers/tty/serial/sh-sci.c
+++ b/drivers/tty/serial/sh-sci.c
@@ -155,6 +155,8 @@ struct sci_port {
 
 	bool has_rtscts;
 	bool autorts;
+
+	bool				use_dma;
 };
 
 #define SCI_NPORTS CONFIG_SERIAL_SH_SCI_NR_UARTS
@@ -2047,7 +2049,8 @@ static int sci_startup(struct uart_port *port)
 
 	dev_dbg(port->dev, "%s(%d)\n", __func__, port->line);
 
-	sci_request_dma(port);
+	if (s->use_dma)
+		sci_request_dma(port);
 
 	ret = sci_request_irq(s);
 	if (unlikely(ret < 0)) {
@@ -3138,6 +3141,7 @@ static struct plat_sci_port *sci_parse_dt(struct platform_device *pdev,
 	p->regtype = SCI_OF_REGTYPE(data);
 
 	sp->has_rtscts = of_property_read_bool(np, "uart-has-rtscts");
+	sp->use_dma = of_property_read_bool(np, "dmas");
 
 	return p;
 }
-- 
2.17.1

