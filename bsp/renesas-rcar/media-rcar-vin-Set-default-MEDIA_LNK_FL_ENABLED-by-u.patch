From 0daa32ebc6d563c386a59023c8459552fb1c3cc4 Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Wed, 5 Sep 2018 12:15:08 +0900
Subject: [PATCH 343/909] media: rcar-vin: Set default MEDIA_LNK_FL_ENABLED by
 using rvin_get_chsel

commit 568bb566bf5300eb92a97139faefaf2122886645 from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

If MEDIA_LNK_FL_ENABLED is not set to the pad side, it will return
an error with media_entity_remote_pad (). This patch adds processing
to set flags by using rvin_get_chsel.

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/media/platform/rcar-vin/rcar-core.c | 14 +++++++++++++-
 drivers/media/platform/rcar-vin/rcar-dma.c  | 16 ++++++++++++++++
 drivers/media/platform/rcar-vin/rcar-vin.h  |  1 +
 3 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/drivers/media/platform/rcar-vin/rcar-core.c b/drivers/media/platform/rcar-vin/rcar-core.c
index 6d02ac649527..ce7dfd851253 100644
--- a/drivers/media/platform/rcar-vin/rcar-core.c
+++ b/drivers/media/platform/rcar-vin/rcar-core.c
@@ -613,6 +613,8 @@ static int rvin_group_notify_complete(struct v4l2_async_notifier *notifier)
 		struct media_pad *source_pad, *sink_pad;
 		struct media_entity *source, *sink;
 		unsigned int source_idx;
+		struct rvin_dev *vin_master;
+		u32 flags;
 
 		/* Check that VIN is part of the group. */
 		if (!vin->group->vin[route->vin])
@@ -637,7 +639,17 @@ static int rvin_group_notify_complete(struct v4l2_async_notifier *notifier)
 		if (media_entity_find_link(source_pad, sink_pad))
 			continue;
 
-		ret = media_create_pad_link(source, source_idx, sink, 0, 0);
+		vin_master =
+			vin->group->vin[rvin_group_id_to_master(route->vin)];
+
+		/* Set default channel */
+		if (route->mask & (0x01 << rvin_get_chsel(vin_master)))
+			flags = MEDIA_LNK_FL_ENABLED;
+		else
+			flags = 0;
+
+		ret = media_create_pad_link(source, source_idx, sink, 0,
+					    flags);
 		if (ret) {
 			vin_err(vin, "Error adding link from %s to %s\n",
 				source->name, sink->name);
diff --git a/drivers/media/platform/rcar-vin/rcar-dma.c b/drivers/media/platform/rcar-vin/rcar-dma.c
index a533ab61dc5b..15541ee0aff2 100644
--- a/drivers/media/platform/rcar-vin/rcar-dma.c
+++ b/drivers/media/platform/rcar-vin/rcar-dma.c
@@ -1422,3 +1422,19 @@ int rvin_set_channel_routing(struct rvin_dev *vin, u8 chsel)
 
 	return ret;
 }
+
+u32 rvin_get_chsel(struct rvin_dev *vin)
+{
+	u32 chsel;
+	int ret;
+
+	ret = pm_runtime_get_sync(vin->dev);
+	if (ret < 0)
+		return ret;
+
+	chsel = rvin_read(vin, VNCSI_IFMD_REG) & VNCSI_IFMD_CSI_CHSEL_MASK;
+
+	pm_runtime_put(vin->dev);
+
+	return chsel;
+}
diff --git a/drivers/media/platform/rcar-vin/rcar-vin.h b/drivers/media/platform/rcar-vin/rcar-vin.h
index e602e81bb6be..4f2658830566 100644
--- a/drivers/media/platform/rcar-vin/rcar-vin.h
+++ b/drivers/media/platform/rcar-vin/rcar-vin.h
@@ -270,5 +270,6 @@ void rvin_v4l2_unregister(struct rvin_dev *vin);
 const struct rvin_video_format *rvin_format_from_pixel(u32 pixelformat);
 
 int rvin_set_channel_routing(struct rvin_dev *vin, u8 chsel);
+u32 rvin_get_chsel(struct rvin_dev *vin);
 
 #endif
-- 
2.17.1

