From 03f27f51e0f27ae4e45db3e19b370d231fecb014 Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Thu, 23 Aug 2018 16:46:49 +0900
Subject: [PATCH 287/909] v4l: vsp1: Fix YCbCr planar formats format

commit f78ef81f5e0c64ef32c371ce55e929a928c9209c from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

Fix mistake of pitch calculation about YCbCr planar formats.

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/media/platform/vsp1/vsp1_drm.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/media/platform/vsp1/vsp1_drm.c b/drivers/media/platform/vsp1/vsp1_drm.c
index a99fc0ced7a7..7243cc99026c 100644
--- a/drivers/media/platform/vsp1/vsp1_drm.c
+++ b/drivers/media/platform/vsp1/vsp1_drm.c
@@ -2,7 +2,7 @@
 /*
  * vsp1_drm.c  --  R-Car VSP1 DRM/KMS Interface
  *
- * Copyright (C) 2015 Renesas Electronics Corporation
+ * Copyright (C) 2015-2018 Renesas Electronics Corporation
  *
  * Contact: Laurent Pinchart (laurent.pinchart@ideasonboard.com)
  */
@@ -811,7 +811,13 @@ int vsp1_du_atomic_update(struct device *dev, unsigned int pipe_index,
 	rpf->fmtinfo = fmtinfo;
 	rpf->format.num_planes = fmtinfo->planes;
 	rpf->format.plane_fmt[0].bytesperline = cfg->pitch;
-	rpf->format.plane_fmt[1].bytesperline = cfg->pitch;
+	if (rpf->fmtinfo->fourcc == V4L2_PIX_FMT_YUV420M ||
+	    rpf->fmtinfo->fourcc == V4L2_PIX_FMT_YVU420M ||
+	    rpf->fmtinfo->fourcc == V4L2_PIX_FMT_YUV422M ||
+	    rpf->fmtinfo->fourcc == V4L2_PIX_FMT_YVU422M)
+		rpf->format.plane_fmt[1].bytesperline = cfg->pitch / 2;
+	else
+		rpf->format.plane_fmt[1].bytesperline = cfg->pitch;
 	rpf->alpha = cfg->alpha;
 
 	rpf->mem.addr[0] = cfg->mem[0];
-- 
2.17.1

