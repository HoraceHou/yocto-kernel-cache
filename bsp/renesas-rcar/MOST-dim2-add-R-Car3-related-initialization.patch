From 0de31adbf3ad42f67f6f88c5d7d45cc52306ac67 Mon Sep 17 00:00:00 2001
From: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Date: Fri, 7 Jul 2017 20:43:33 +0300
Subject: [PATCH 840/909] MOST: dim2: add R-Car3 related initialization

commit acc636a3603d2c541bfc758eea3dfa245a13cc46 from
https://github.com/CogentEmbedded/meta-rcar.git

Signed-off-by: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/staging/most/dim2/dim2.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/staging/most/dim2/dim2.c b/drivers/staging/most/dim2/dim2.c
index fe90a7cb56f7..28e915b60327 100644
--- a/drivers/staging/most/dim2/dim2.c
+++ b/drivers/staging/most/dim2/dim2.c
@@ -20,6 +20,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/sched.h>
 #include <linux/kthread.h>
+#include <linux/delay.h>
 
 #include "most/core.h"
 #include "hal.h"
@@ -159,6 +160,26 @@ void dimcb_on_error(u8 error_id, const char *error_message)
 	       error_message);
 }
 
+static int dim_rcar_init(struct dim2_hdm *dev)
+{
+        /* PLL */
+	__raw_writel(0x04, dev->io_base + 0x600);
+
+	/* 512FS Enable Register */
+	if (dev->clk_speed == CLK_512FS)
+		__raw_writel(0x01, dev->io_base + 0x604);
+	else
+		__raw_writel(0x00, dev->io_base + 0x604);
+
+	udelay(200);
+
+	/* BBCR  = 0b11 */
+	__raw_writel(0x03, dev->io_base + 0x500);
+	__raw_writel(0x0002FF02, dev->io_base + 0x508);
+
+	return 0;
+}
+
 /**
  * try_start_dim_transfer - try to transfer a buffer on a channel
  * @hdm_ch: channel specific data
@@ -787,6 +808,10 @@ static int dim2_probe(struct platform_device *pdev)
 
 	dev->disable_platform = pdata ? pdata->disable : 0;
 
+	if (1 /* renesas */) {
+		dim_rcar_init(dev);
+	}
+
 	dev_info(&pdev->dev, "sync: num of frames per sub-buffer: %u\n", fcnt);
 	hal_ret = dim_startup(dev->io_base, dev->clk_speed, fcnt);
 	if (hal_ret != DIM_NO_ERROR) {
-- 
2.17.1

