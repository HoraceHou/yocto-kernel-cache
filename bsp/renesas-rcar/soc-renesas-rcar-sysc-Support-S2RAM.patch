From 5dffabaf2a60103d49d06b78336ebe08255a40c0 Mon Sep 17 00:00:00 2001
From: Dien Pham <dien.pham.ry@renesas.com>
Date: Mon, 20 Nov 2017 10:26:00 +0700
Subject: [PATCH 028/909] soc: renesas: rcar-sysc: Support S2RAM

commit a4ca2ff27136c78caaa95e6dfe86e5b0c8c785d8 from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

Signed-off-by: Dien Pham <dien.pham.ry@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/soc/renesas/rcar-sysc.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/soc/renesas/rcar-sysc.c b/drivers/soc/renesas/rcar-sysc.c
index f7d12204f891..e06bcea8e7f7 100644
--- a/drivers/soc/renesas/rcar-sysc.c
+++ b/drivers/soc/renesas/rcar-sysc.c
@@ -19,6 +19,7 @@
 #include <linux/spinlock.h>
 #include <linux/io.h>
 #include <linux/soc/renesas/rcar-sysc.h>
+#include <linux/syscore_ops.h>
 
 #include "rcar-sysc.h"
 
@@ -273,6 +274,22 @@ static int __init rcar_sysc_pd_setup(struct rcar_sysc_pd *pd)
 	return error;
 }
 
+static u32 syscier_val, syscimr_val;
+#ifdef CONFIG_PM_SLEEP
+static void rcar_sysc_resume(void)
+{
+	pr_debug("%s\n", __func__);
+
+	/* Re-enable interrupts as init */
+	iowrite32(syscimr_val, rcar_sysc_base + SYSCIMR);
+	iowrite32(syscier_val, rcar_sysc_base + SYSCIER);
+}
+
+static struct syscore_ops rcar_sysc_syscore_ops = {
+	.resume = rcar_sysc_resume,
+};
+#endif
+
 static const struct of_device_id rcar_sysc_matches[] __initconst = {
 #ifdef CONFIG_SYSC_R8A7743
 	{ .compatible = "renesas,r8a7743-sysc", .data = &r8a7743_sysc_info },
@@ -394,6 +411,9 @@ static int __init rcar_sysc_pd_init(void)
 	pr_debug("%pOF: syscier = 0x%08x\n", np, syscier);
 	iowrite32(syscier, base + SYSCIER);
 
+	syscier_val = syscier;
+	syscimr_val = syscimr;
+
 	/*
 	 * First, create all PM domains
 	 */
@@ -444,6 +464,11 @@ static int __init rcar_sysc_pd_init(void)
 
 	error = of_genpd_add_provider_onecell(np, &domains->onecell_data);
 
+#ifdef CONFIG_PM_SLEEP
+	if (!error)
+		register_syscore_ops(&rcar_sysc_syscore_ops);
+#endif
+
 out_put:
 	of_node_put(np);
 	return error;
-- 
2.17.1

