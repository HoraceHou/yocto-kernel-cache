From 38602230eb81a4e537b744be500c188fe69eab02 Mon Sep 17 00:00:00 2001
From: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Date: Mon, 25 Sep 2017 07:13:29 +0300
Subject: [PATCH 841/909] MOST: dim2: add timeouts

commit 19b051580b0d5665ff2ac66cd753b2e7b6bd05b9 from
https://github.com/CogentEmbedded/meta-rcar.git

Get rid from loop hang if device not functional

Signed-off-by: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Signed-off-by: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/staging/most/dim2/hal.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/most/dim2/hal.c b/drivers/staging/most/dim2/hal.c
index 699e02f83bd4..8755b0206b0e 100644
--- a/drivers/staging/most/dim2/hal.c
+++ b/drivers/staging/most/dim2/hal.c
@@ -13,6 +13,7 @@
 #include "reg.h"
 #include <linux/stddef.h>
 #include <linux/kernel.h>
+#include <linux/delay.h>
 
 /*
  * Size factor for isochronous DBR buffer.
@@ -143,11 +144,16 @@ static void free_dbr(int offs, int size)
 
 static void dim2_transfer_madr(u32 val)
 {
+	int timeout = 1000;
 	dimcb_io_write(&g.dim2->MADR, val);
 
 	/* wait for transfer completion */
-	while ((dimcb_io_read(&g.dim2->MCTL) & 1) != 1)
+	while ((dimcb_io_read(&g.dim2->MCTL) & 1) != 1) {
+		if (--timeout == 0)
+			break;
+		udelay(1);
 		continue;
+	}
 
 	dimcb_io_write(&g.dim2->MCTL, 0);   /* clear transfer complete */
 }
-- 
2.17.1

