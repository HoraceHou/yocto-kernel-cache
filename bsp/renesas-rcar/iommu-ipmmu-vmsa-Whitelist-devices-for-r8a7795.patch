From 7239454fc35ac09760652e6cb6bc2995b46f20f7 Mon Sep 17 00:00:00 2001
From: Hai Nguyen Pham <hai.pham.ud@renesas.com>
Date: Mon, 26 Nov 2018 14:37:44 +0700
Subject: [PATCH 405/909] iommu/ipmmu-vmsa: Whitelist devices for r8a7795

commit 950208b5b16963813d5d15c208ab87e260e2d47d from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git

This adds whitelist devices support for r8a7795 (R-Car H3)

- For unsupported R-Car Gen3 SoCs, IPMMU will probe error.
- For unsupported IPMMU cache devices or unsupported master devices,
IPMMU will not do address translation.

Signed-off-by: Hai Nguyen Pham <hai.pham.ud@renesas.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/iommu/ipmmu-vmsa-whitelist.h | 50 +++++++++++++++++++++++
 drivers/iommu/ipmmu-vmsa.c           | 61 +++++++++++++++++++++++++++-
 2 files changed, 110 insertions(+), 1 deletion(-)

diff --git a/drivers/iommu/ipmmu-vmsa-whitelist.h b/drivers/iommu/ipmmu-vmsa-whitelist.h
index 98ff3bd238f4..d8623b62dba9 100644
--- a/drivers/iommu/ipmmu-vmsa-whitelist.h
+++ b/drivers/iommu/ipmmu-vmsa-whitelist.h
@@ -136,6 +136,56 @@
 #define M_SDHI2		BIT(34)
 #define M_SDHI3		BIT(35)
 
+/* Support masters for r8a7795 */
+#define H3_IPMMU_VI0_MASTER	(M_VIN_0_3 | M_FCPVD_0 | M_FCPVD_1)
+#define H3_IPMMU_VI1_MASTER	(M_VIN_4_7 | M_FCPVD_2)
+#define H3_IPMMU_HC_MASTER	(M_PCIE_0 | M_PCIE_1 | M_SATA | M_USB2H_0 | \
+				 M_USB2H_1 | M_USB2H_2 | M_USB2H_3 | \
+				 M_USB_DMAC_0 | M_USB_DMAC_1 | M_USB3H_0 | \
+				 M_USB3F_0 | M_USB_DMAC_2 | M_USB_DMAC_3)
+#define H3_IPMMU_MP_MASTER	(M_AUDIO_DMAC_0 | M_AUDIO_DMAC_1 | \
+				 M_AUDIO_DMAC_2 | M_AUDIO_DMAC_3 | \
+				 M_AUDIO_DMAC_4 | M_AUDIO_DMAC_5 | \
+				 M_AUDIO_DMAC_6 | M_AUDIO_DMAC_7 | \
+				 M_AUDIO_DMAC_8 | M_AUDIO_DMAC_9 | \
+				 M_AUDIO_DMAC_10 | M_AUDIO_DMAC_11 | \
+				 M_AUDIO_DMAC_12 | M_AUDIO_DMAC_13 | \
+				 M_AUDIO_DMAC_14 | M_AUDIO_DMAC_15 | \
+				 M_AUDIO_DMAC_16 | M_AUDIO_DMAC_17 | \
+				 M_AUDIO_DMAC_18 | M_AUDIO_DMAC_19 | \
+				 M_AUDIO_DMAC_20 | M_AUDIO_DMAC_21 | \
+				 M_AUDIO_DMAC_22 | M_AUDIO_DMAC_23 | \
+				 M_AUDIO_DMAC_24 | M_AUDIO_DMAC_25 | \
+				 M_AUDIO_DMAC_16 | M_AUDIO_DMAC_27 | \
+				 M_AUDIO_DMAC_28 | M_AUDIO_DMAC_29 | \
+				 M_AUDIO_DMAC_30 | M_AUDIO_DMAC_31)
+#define H3_IPMMU_DS0_MASTER	(M_SYS_DMAC_0 | M_SYS_DMAC_1 | \
+				 M_SYS_DMAC_2 | M_SYS_DMAC_3 | \
+				 M_SYS_DMAC_4 | M_SYS_DMAC_5 | \
+				 M_SYS_DMAC_6 | M_SYS_DMAC_7 | \
+				 M_SYS_DMAC_8 | M_SYS_DMAC_9 | \
+				 M_SYS_DMAC_10 | M_SYS_DMAC_11 | \
+				 M_SYS_DMAC_12 | M_SYS_DMAC_13 | \
+				 M_SYS_DMAC_14 | M_SYS_DMAC_15 | \
+				 M_ETHERNET)
+#define H3_IPMMU_DS1_MASTER	(M_SYS_DMAC_16 | M_SYS_DMAC_17 | \
+				 M_SYS_DMAC_18 | M_SYS_DMAC_19 | \
+				 M_SYS_DMAC_20 | M_SYS_DMAC_21 | \
+				 M_SYS_DMAC_22 | M_SYS_DMAC_23 | \
+				 M_SYS_DMAC_24 | M_SYS_DMAC_25 | \
+				 M_SYS_DMAC_26 | M_SYS_DMAC_27 | \
+				 M_SYS_DMAC_28 | M_SYS_DMAC_29 | \
+				 M_SYS_DMAC_30 | M_SYS_DMAC_31 | \
+				 M_SYS_DMAC_32 | M_SYS_DMAC_33 | \
+				 M_SYS_DMAC_34 | M_SYS_DMAC_35 | \
+				 M_SYS_DMAC_36 | M_SYS_DMAC_37 | \
+				 M_SYS_DMAC_38 | M_SYS_DMAC_39 | \
+				 M_SYS_DMAC_40 | M_SYS_DMAC_41 | \
+				 M_SYS_DMAC_42 | M_SYS_DMAC_43 | \
+				 M_SYS_DMAC_44 | M_SYS_DMAC_45 | \
+				 M_SYS_DMAC_46 | M_SYS_DMAC_47 | \
+				 M_SDHI0 | M_SDHI1 | M_SDHI2 | M_SDHI3)
+
 struct ipmmu_whitelist {
 	 const char *ipmmu_name;
 	 unsigned int base_addr;
diff --git a/drivers/iommu/ipmmu-vmsa.c b/drivers/iommu/ipmmu-vmsa.c
index 4151e1be3fb2..b403b45442ae 100644
--- a/drivers/iommu/ipmmu-vmsa.c
+++ b/drivers/iommu/ipmmu-vmsa.c
@@ -120,6 +120,55 @@ static struct ipmmu_vmsa_device *to_ipmmu(struct device *dev)
 	return dev->iommu_fwspec ? dev->iommu_fwspec->iommu_priv : NULL;
 }
 
+#ifdef CONFIG_IPMMU_VMSA_WHITELIST
+/* R-Car H3 (R8A7795) */
+static struct ipmmu_whitelist r8a7795_ipmmu_vi0 = {
+	.ipmmu_name	= "febd0000.mmu",
+	.base_addr	= IPMMU_VI0_BASE,
+	.ip_masters	= H3_IPMMU_VI0_MASTER,
+};
+
+static struct ipmmu_whitelist r8a7795_ipmmu_vi1 = {
+	.ipmmu_name	= "febe0000.mmu",
+	.base_addr	= IPMMU_VI1_BASE,
+	.ip_masters	= H3_IPMMU_VI1_MASTER,
+};
+
+static struct ipmmu_whitelist r8a7795_ipmmu_hc = {
+	.ipmmu_name	= "e6570000.mmu",
+	.base_addr	= IPMMU_HC_BASE,
+	.ip_masters	= H3_IPMMU_HC_MASTER,
+};
+
+static struct ipmmu_whitelist r8a7795_ipmmu_mp = {
+	.ipmmu_name	= "ec670000.mmu",
+	.base_addr	= IPMMU_MP_BASE,
+	.ip_masters	= H3_IPMMU_MP_MASTER,
+};
+
+static struct ipmmu_whitelist r8a7795_ipmmu_ds0 = {
+	.ipmmu_name	= "e6740000.mmu",
+	.base_addr	= IPMMU_DS0_BASE,
+	.ip_masters	= H3_IPMMU_DS0_MASTER,
+};
+
+static struct ipmmu_whitelist r8a7795_ipmmu_ds1 = {
+	.ipmmu_name	= "e7740000.mmu",
+	.base_addr	= IPMMU_DS1_BASE,
+	.ip_masters	= H3_IPMMU_DS1_MASTER,
+};
+
+static struct ipmmu_whitelist *r8a7795_whitelist[] = {
+	&r8a7795_ipmmu_vi0,
+	&r8a7795_ipmmu_vi1,
+	&r8a7795_ipmmu_hc,
+	&r8a7795_ipmmu_mp,
+	&r8a7795_ipmmu_ds0,
+	&r8a7795_ipmmu_ds1,
+	NULL, /* Terminator */
+};
+#endif /* CONFIG_IPMMU_VMSA_WHITELIST */
+
 #define TLB_LOOP_TIMEOUT		100	/* 100us */
 
 /* -----------------------------------------------------------------------------
@@ -961,6 +1010,13 @@ static const struct soc_device_attribute soc_rcar_gen3[] = {
 	{ /* sentinel */ }
 };
 
+#ifdef CONFIG_IPMMU_VMSA_WHITELIST
+static const struct soc_device_attribute r8a7795[]  = {
+	{ .soc_id = "r8a7795" },
+	{ /* sentinel */ }
+};
+#endif /* CONFIG_IPMMU_VMSA_WHITELIST */
+
 static int ipmmu_of_xlate(struct device *dev,
 			  struct of_phandle_args *spec)
 {
@@ -1252,7 +1308,10 @@ static int ipmmu_whitelist_init(struct ipmmu_vmsa_device *mmu)
 {
 	/* Whitelist set up depend per SoC */
 
-	mmu->whitelist = NULL;
+	if (soc_device_match(r8a7795))
+		mmu->whitelist = r8a7795_whitelist;
+	else
+		mmu->whitelist = NULL;
 
 	if (!mmu->whitelist[0])
 		return -1;
-- 
2.17.1

