From 47d3543127b41da62924e0b12bb9a63331eec082 Mon Sep 17 00:00:00 2001
From: Lukasz Bartosik <lbartosik@marvell.com>
Date: Wed, 24 Apr 2019 15:39:46 +0200
Subject: [PATCH 187/386] crypto: cpt - add validation of ucode size

Change-Id: I8477903bd39c7580e3b7b400a15b3ae71e9def68
Signed-off-by: Lukasz Bartosik <lbartosik@marvell.com>
Reviewed-on: https://sj1git1.cavium.com/8058
Tested-by: sa_ip-sw-jenkins <sa_ip-sw-jenkins@marvell.com>
Reviewed-by: Srujana Challa <schalla@cavium.com>
[RH: Original patch taken from marvell 88F3720 board support SDK 10.0-PR2003]
Signed-off-by: Ruiqiang Hao <Ruiqiang.Hao@windriver.com>
---
 drivers/crypto/cavium/cpt/common/cpt_ucode.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/crypto/cavium/cpt/common/cpt_ucode.c b/drivers/crypto/cavium/cpt/common/cpt_ucode.c
index 747d9036b6e4..c40fcfba215d 100644
--- a/drivers/crypto/cavium/cpt/common/cpt_ucode.c
+++ b/drivers/crypto/cavium/cpt/common/cpt_ucode.c
@@ -166,8 +166,8 @@ static int process_tar_file(struct device *dev,
 		return 0;
 
 	ucode_size = ntohl(ucode_hdr->code_length) * 2;
-	if (size < ROUNDUP16(ucode_size) + sizeof(struct microcode_hdr)
-	    + CPT_UCODE_SIGN_LEN) {
+	if (!ucode_size || (size < ROUNDUP16(ucode_size) +
+	    sizeof(struct microcode_hdr) + CPT_UCODE_SIGN_LEN)) {
 		dev_err(dev, "Ucode %s invalid size", filename);
 		return -EINVAL;
 	}
@@ -804,7 +804,9 @@ static int ucode_load(struct device *dev, struct microcode *ucode,
 	memcpy(ucode->ver_str, ucode_hdr->ver_str, CPT_UCODE_VER_STR_SZ);
 	ucode->ver_num = ucode_hdr->ver_num;
 	ucode->size = ntohl(ucode_hdr->code_length) * 2;
-	if (!ucode->size) {
+	if (!ucode->size || (fw->size < ROUNDUP16(ucode->size)
+	    + sizeof(struct microcode_hdr) + CPT_UCODE_SIGN_LEN)) {
+		dev_err(dev, "Ucode %s invalid size", ucode_filename);
 		ret = -EINVAL;
 		goto err;
 	}
-- 
2.17.1

