From a59334d11d6ff18e5f11838a75adfce56311aa4d Mon Sep 17 00:00:00 2001
From: Catalin Horghidan <catalin.horghidan@nxp.com>
Date: Tue, 14 Nov 2017 18:11:34 +0200
Subject: [PATCH 087/706] enetc: Fix MSI naming and error logging on probe

Signed-off-by: Catalin Horghidan <catalin.horghidan@nxp.com>
Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 14a4cb2ca5888f368a461b1180ede9e67697dccd)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index 6f160198ca14..e96d4b454b80 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -1477,8 +1477,10 @@ static int enetc_alloc_msix(struct enetc_ndev_priv *priv)
 
 	priv->int_vector = kcalloc(priv->bdr_int_num,
 				   sizeof(struct enetc_int_vector), GFP_KERNEL);
-	if (!priv->int_vector)
+	if (!priv->int_vector) {
+		pci_free_irq_vectors(pdev);
 		return -ENOMEM;
+	}
 
 	for (i = 0; i < priv->bdr_int_num; i++) {
 		struct enetc_int_vector *v = &priv->int_vector[i];
@@ -1638,18 +1640,18 @@ static int enetc_pci_probe(struct pci_dev *pdev,
 
 	err = enetc_alloc_msix(priv);
 	if (err) {
-		netif_err(priv, probe, ndev, "MSIX allocation failed\n");
+		dev_err(&pdev->dev, "MSIX allocation failed\n");
 		goto err_alloc_msix;
 	}
 
-	err = enetc_setup_irqs(priv);
-	if (err)
-		goto err_setup_irq;
-
 	err = register_netdev(ndev);
 	if (err)
 		goto err_reg_netdev;
 
+	err = enetc_setup_irqs(priv);
+	if (err)
+		goto err_setup_irq;
+
 	netif_carrier_off(ndev);
 
 	netif_info(priv, probe, ndev, "%s v%s\n",
@@ -1657,9 +1659,9 @@ static int enetc_pci_probe(struct pci_dev *pdev,
 
 	return 0;
 
-err_reg_netdev:
-	enetc_free_irqs(priv);
 err_setup_irq:
+	unregister_netdev(ndev);
+err_reg_netdev:
 	enetc_free_msix(priv);
 err_alloc_msix:
 	enetc_free_si_resources(priv);
-- 
2.17.1

