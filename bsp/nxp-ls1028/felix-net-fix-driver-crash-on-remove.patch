From 870fd508ccc18ef4add72cdf5259ed8e03453198 Mon Sep 17 00:00:00 2001
From: Catalin Horghidan <catalin.horghidan@nxp.com>
Date: Mon, 1 Oct 2018 14:02:41 +0300
Subject: [PATCH 310/706] felix: net: fix driver crash on remove

Signed-off-by: Catalin Horghidan <catalin.horghidan@nxp.com>
(cherry picked from commit 6a33efedf29a4a9c8eef7b792b829d0bd7f8ceca)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c | 8 ++++++--
 drivers/net/ethernet/mscc/ocelot.c      | 1 +
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index 69990165e682..d37b3e884f7e 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -363,11 +363,15 @@ static void felix_pci_remove(struct pci_dev *pdev)
 {
 	struct ocelot *ocelot;
 
-	unregister_netdevice_notifier(&ocelot_netdevice_nb);
-
 	ocelot = pci_get_drvdata(pdev);
 
+	/* stop workqueue thread */
 	ocelot_deinit(ocelot);
+
+	unregister_netdevice_notifier(&ocelot_netdevice_nb);
+
+	felix_release_ports(ocelot->ports);
+
 	pci_iounmap(pdev, regs);
 	kfree(ocelot);
 	pci_disable_device(pdev);
diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.c
index 142ba073fa80..f83761c61f51 100644
--- a/drivers/net/ethernet/mscc/ocelot.c
+++ b/drivers/net/ethernet/mscc/ocelot.c
@@ -1778,6 +1778,7 @@ EXPORT_SYMBOL(ocelot_init);
 
 void ocelot_deinit(struct ocelot *ocelot)
 {
+	cancel_delayed_work(&ocelot->stats_work);
 	destroy_workqueue(ocelot->stats_queue);
 	mutex_destroy(&ocelot->stats_lock);
 }
-- 
2.17.1

