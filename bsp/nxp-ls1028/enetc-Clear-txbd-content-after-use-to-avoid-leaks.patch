From e8e90b49353ee3fb53fb0c6102911db7ec875abe Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Wed, 12 Dec 2018 12:10:30 +0200
Subject: [PATCH 453/706] enetc: Clear txbd content after use to avoid leaks

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit f4079c9d48e7881eede224de8cabb2ad114cd8f1)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c    | 11 ++++++++---
 drivers/net/ethernet/freescale/enetc/enetc_hw.h |  1 +
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index 06791de61f08..d5d37acd4d7e 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -345,6 +345,7 @@ static int enetc_clean_tx_ring(struct enetc_bdr *tx_ring)
 	int tx_frm_cnt = 0, tx_byte_cnt = 0;
 	struct enetc_tx_swbd *tx_swbd;
 	struct enetc_ndev_priv *priv;
+	union enetc_tx_bd *txbd;
 	int i, bds_to_clean;
 	bool do_tstamp, first;
 	u64 tstamp = 0;
@@ -354,6 +355,7 @@ static int enetc_clean_tx_ring(struct enetc_bdr *tx_ring)
 
 	i = tx_ring->next_to_clean;
 	tx_swbd = &tx_ring->tx_swbd[i];
+	txbd = ENETC_TXBD(*tx_ring, i);
 	first = true;
 	bds_to_clean = enetc_bd_ready_count(tx_ring, i);
 
@@ -362,9 +364,6 @@ static int enetc_clean_tx_ring(struct enetc_bdr *tx_ring)
 
 		if (unlikely(do_tstamp)) {
 			if (unlikely(first)) {
-				union enetc_tx_bd *txbd;
-
-				txbd = ENETC_TXBD(*tx_ring, i);
 				enetc_get_tx_tstamp(&priv->si->hw, txbd,
 						    &tstamp);
 
@@ -374,14 +373,20 @@ static int enetc_clean_tx_ring(struct enetc_bdr *tx_ring)
 		}
 
 		enetc_unmap_tx_buff(tx_ring, tx_swbd);
+		/* clear BD fields that may leak */
+		txbd->frm_len = 0;
+		txbd->buf_len = 0;
+		txbd->lstatus = 0;
 		tx_byte_cnt += tx_swbd->len;
 
 		bds_to_clean--;
 		tx_swbd++;
+		txbd++;
 		i++;
 		if (unlikely(i == tx_ring->bd_count)) {
 			i = 0;
 			tx_swbd = tx_ring->tx_swbd;
+			txbd = ENETC_TXBD(*tx_ring, 0);
 		}
 
 		/* BD iteration loop end */
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index c83518410ce0..c1bf499c8bcd 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -338,6 +338,7 @@ union enetc_tx_bd {
 				u8 l4_csoff;
 				u8 flags;
 			}; /* default layout */
+			__le32 lstatus;
 		};
 	};
 	struct {
-- 
2.17.1

