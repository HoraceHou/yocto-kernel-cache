From 1c273259992d4f5432b4fe3fa0c498b70fba814c Mon Sep 17 00:00:00 2001
From: Alex Marginean <alexandru.marginean@freescale.com>
Date: Mon, 11 Sep 2017 16:00:49 +0300
Subject: [PATCH 056/706] enetc: VF support

Signed-off-by: Alex Marginean <alexandru.marginean@freescale.com>
Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 134bfe6cd5957be39ec1dc6c0c8d51b835733340)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c  | 26 +++++++++++++++----
 .../net/ethernet/freescale/enetc/enetc_hw.h   |  3 +++
 2 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index df2aa2d16cc3..b40fb461571e 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -1020,7 +1020,15 @@ static const struct net_device_ops enetc_ndev_ops = {
 	.ndo_set_rx_mode	= enetc_set_rx_mode,
 };
 
-static void enetc_netdev_setup(struct enetc_si *si, struct net_device *ndev)
+static const struct net_device_ops enetc_ndev_vf_ops = {
+	.ndo_open		= enetc_open,
+	.ndo_stop		= enetc_close,
+	.ndo_start_xmit		= enetc_xmit,
+	.ndo_get_stats		= enetc_get_stats,
+};
+
+static void enetc_netdev_setup(struct enetc_si *si, struct net_device *ndev,
+			       const struct net_device_ops *ndev_ops)
 {
 	struct enetc_ndev_priv *priv = netdev_priv(ndev);
 
@@ -1031,7 +1039,7 @@ static void enetc_netdev_setup(struct enetc_si *si, struct net_device *ndev)
 	si->ndev = ndev;
 
 	priv->msg_enable = (NETIF_MSG_IFUP << 1) - 1; //TODO: netif_msg_init()
-	ndev->netdev_ops = &enetc_ndev_ops;
+	ndev->netdev_ops = ndev_ops;
 	enetc_set_ethtool_ops(ndev);
 	ndev->watchdog_timeo = 5 * HZ;
 
@@ -1204,11 +1212,18 @@ static int enetc_pci_probe(struct pci_dev *pdev,
 	}
 
 	priv = netdev_priv(ndev);
-	enetc_netdev_setup(si, ndev);
 
-	enetc_sw_init(priv);
+	if (pdev->device == ENETC_DEV_ID_VF) {
+		/* VFs have a different set of ndos and can't touch the port */
+		enetc_netdev_setup(si, ndev, &enetc_ndev_vf_ops);
+		enetc_sw_init(priv);
+
+	} else {
+		enetc_netdev_setup(si, ndev, &enetc_ndev_ops);
+		enetc_sw_init(priv);
 
-	enetc_configure_port(priv);
+		enetc_configure_port(priv);
+	}
 	enetc_configure_si(priv);
 
 	err = enetc_alloc_msix(priv);
@@ -1288,6 +1303,7 @@ static int enetc_sriov_configure(struct pci_dev *dev, int num_vfs)
 
 static const struct pci_device_id enetc_id_table[] = {
 	{ PCI_DEVICE(PCI_VENDOR_ID_FREESCALE, 0xe100) },
+	{ PCI_DEVICE(PCI_VENDOR_ID_FREESCALE, ENETC_DEV_ID_VF) },
 	{ 0, } /* End of table. */
 };
 MODULE_DEVICE_TABLE(pci, enetc_id_table);
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index a964ab1f2a1d..b74233b56cf3 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -1,5 +1,8 @@
 #include <linux/bitops.h>
 
+/* ENETC device IDs */
+#define ENETC_DEV_ID_VF	0xef00
+
 /* ENETC register block BAR */
 #define ENETC_BAR_REGS	0
 
-- 
2.17.1

