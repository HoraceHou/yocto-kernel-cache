From e31834b743766fb68e936bcaf1ae5db29d2ac599 Mon Sep 17 00:00:00 2001
From: Alex Marginean <alexandru.marginean@freescale.com>
Date: Thu, 14 Sep 2017 17:38:53 +0300
Subject: [PATCH 059/706] enetc: added ip link set vf vlan command support

Signed-off-by: Alex Marginean <alexandru.marginean@freescale.com>
(cherry picked from commit a55fd903e88c7501d929fc586ce613a9315969a5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c  | 26 +++++++++++++++++++
 .../net/ethernet/freescale/enetc/enetc_hw.h   |  3 +++
 2 files changed, 29 insertions(+)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index d353b5547d4b..20c5cfe33af1 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -965,6 +965,15 @@ static int enetc_set_mac_addr(struct net_device *ndev, void *addr)
 	return 0;
 }
 
+static void enetc_set_isol_vlan(struct enetc_hw *hw, int si, u16 vlan, u8 qos)
+{
+	u32 val = 0;
+
+	if (vlan)
+		val = ENETC_PSIIVLAN_EN | ENETC_PSIIVLAN_SET_QOS(qos) | vlan;
+	enetc_port_wr(hw, ENETC_PSIIVLANR(si), val);
+}
+
 static void enetc_set_rx_mode(struct net_device *ndev)
 {
 	struct enetc_ndev_priv *priv = netdev_priv(ndev);
@@ -1023,6 +1032,22 @@ static int enetc_set_vf_mac(struct net_device *ndev, int vf, u8 *mac)
 	return 0;
 }
 
+static int enetc_set_vf_vlan(struct net_device *ndev, int vf, u16 vlan,
+			     u8 qos, __be16 proto)
+{
+	struct enetc_ndev_priv *priv = netdev_priv(ndev);
+
+	if (vf > priv->si->num_vfs)
+		return -EINVAL;
+
+	if (proto != htons(0x8100))
+		/* only C-tags supported for now */
+		return -EPROTONOSUPPORT;
+
+	enetc_set_isol_vlan(&priv->si->hw, vf + 1, vlan, qos);
+	return 0;
+}
+
 static const struct net_device_ops enetc_ndev_ops = {
 	.ndo_open		= enetc_open,
 	.ndo_stop		= enetc_close,
@@ -1031,6 +1056,7 @@ static const struct net_device_ops enetc_ndev_ops = {
 	.ndo_set_mac_address	= enetc_set_mac_addr,
 	.ndo_set_rx_mode	= enetc_set_rx_mode,
 	.ndo_set_vf_mac		= enetc_set_vf_mac,
+	.ndo_set_vf_vlan	= enetc_set_vf_vlan,
 };
 
 static const struct net_device_ops enetc_ndev_vf_ops = {
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index b74233b56cf3..b6ac018f3082 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -68,6 +68,9 @@ enum enetc_bdr_type {TX, RX};
 #define ENETC_PSIPMR_SET_MP(n)	(0x1 << ((n) + 8))
 #define ENETC_PSIPMAR0(n)	(0x00100 + (n) * 0x20) /* n = SI index */
 #define ENETC_PSIPMAR1(n)	(0x00104 + (n) * 0x20)
+#define ENETC_PSIIVLANR(n)	(0x00210 + (n) * 4) /* n = SI index */
+#define ENETC_PSIIVLAN_EN	BIT(31)
+#define ENETC_PSIIVLAN_SET_QOS(val)	((u32)(val) << 12)
 #define ENETC_PCAPR0	0x00900
 #define ENETC_PCAPR1	0x00904
 
-- 
2.17.1

