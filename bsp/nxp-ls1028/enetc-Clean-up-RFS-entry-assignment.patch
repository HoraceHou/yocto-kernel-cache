From 5245c411d9c3408735b3c38afc7f7b56c752eeff Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Thu, 8 Nov 2018 11:53:25 +0200
Subject: [PATCH 473/706] enetc: Clean up RFS entry assignment

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 470f7f74d09d5f7a6b5b3c9e47068f00a3c194f4)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc_hw.h | 1 +
 drivers/net/ethernet/freescale/enetc/enetc_pf.c | 9 +++++----
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index a5be329f3cab..9718b38c2c38 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -186,6 +186,7 @@ enum enetc_bdr_type {TX, RX};
 #define ENETC_PRFSMR		0x1800
 #define ENETC_PRFSMR_RFSE	BIT(31)
 #define ENETC_PRFSCAPR		0x1804
+#define ENETC_PRFSCAPR_GET_NUM_RFS(val)	((((val) & 0xf) + 1) * 16)
 #define ENETC_PSIRFSCFGR(n)	(0x1814 + (n) * 4) /* n = SI index */
 #define ENETC_PFPMR		0x1900
 #define ENETC_PFPMR_PMACE	BIT(1)
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_pf.c b/drivers/net/ethernet/freescale/enetc/enetc_pf.c
index d35bfa9853a0..6f89aabc465d 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_pf.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc_pf.c
@@ -432,15 +432,16 @@ static void enetc_port_setup_primary_mac_address(struct enetc_si *si)
 	}
 }
 
-static void enetc_port_alloc_rfs(struct enetc_si *si)
+static void enetc_port_assign_rfs_entries(struct enetc_si *si)
 {
 	struct enetc_pf *pf = enetc_si_priv(si);
 	struct enetc_hw *hw = &si->hw;
 	int num_entries, vf_entries, i;
+	u32 val;
 
 	/* split RFS entries between functions */
-	num_entries = enetc_port_rd(hw, ENETC_PRFSCAPR) & 0xf;
-	num_entries = 16 * (1 + num_entries);
+	val = enetc_port_rd(hw, ENETC_PRFSCAPR);
+	num_entries = ENETC_PRFSCAPR_GET_NUM_RFS(val);
 	vf_entries = num_entries / (pf->total_vfs + 1);
 
 	for (i = 0; i < pf->total_vfs; i++)
@@ -552,7 +553,7 @@ static void enetc_configure_port(struct enetc_pf *pf)
 	enetc_set_rss_key(hw, hash_key);
 
 	/* split up RFS entries */
-	enetc_port_alloc_rfs(pf->si);
+	enetc_port_assign_rfs_entries(pf->si);
 
 	/* fix-up primary MAC addresses, if not set already */
 	enetc_port_setup_primary_mac_address(pf->si);
-- 
2.17.1

