From abd86af4a0409d1f478451e5f87d589a3db3da3b Mon Sep 17 00:00:00 2001
From: Catalin Horghidan <catalin.horghidan@nxp.com>
Date: Tue, 29 Jan 2019 17:37:45 +0200
Subject: [PATCH 622/706] mscc: felix: use fixed 1G speed for switch port MAC

Signed-off-by: Catalin Horghidan <catalin.horghidan@nxp.com>
(cherry picked from commit 82750b44ca9c0d1cc51670f33cc43226d983cd76)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c | 11 +++++++++++
 drivers/net/ethernet/mscc/felix_regs.c  | 13 +------------
 2 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index aff7ee41a7dd..fcafbbbc2076 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -465,6 +465,17 @@ static int felix_ports_init(struct pci_dev *pdev)
 			dev_err(ocelot->dev, "failed to probe ports\n");
 			goto release_ports;
 		}
+		/* Only 1G full duplex supported for now */
+		ocelot_port_writel(ocelot->ports[port],
+				   DEV_MAC_MODE_CFG_FDX_ENA |
+				   DEV_MAC_MODE_CFG_GIGA_MODE_ENA,
+				   DEV_MAC_MODE_CFG);
+		/* Take MAC, Port, Phy (intern) and PCS (SGMII/Serdes)
+		 * clock out of reset
+		 */
+		ocelot_port_writel(ocelot->ports[port],
+				   DEV_CLOCK_CFG_LINK_SPEED(OCELOT_SPEED_1000),
+				   DEV_CLOCK_CFG);
 
 #ifdef CONFIG_MSCC_FELIX_SWITCH_TSN
 		tsn_port_register(ocelot->ports[port]->dev, (struct tsn_ops *)&switch_tsn_ops,
diff --git a/drivers/net/ethernet/mscc/felix_regs.c b/drivers/net/ethernet/mscc/felix_regs.c
index 9b7e50bcb490..3366329eaf95 100644
--- a/drivers/net/ethernet/mscc/felix_regs.c
+++ b/drivers/net/ethernet/mscc/felix_regs.c
@@ -488,7 +488,7 @@ void felix_port_adjust_link(struct net_device *dev)
 	struct ocelot_port *port = netdev_priv(dev);
 	struct ocelot *ocelot = port->ocelot;
 	u8 p = port->chip_port;
-	int speed, atop_wm, mode = 0;
+	int speed, atop_wm;
 
 	switch (dev->phydev->speed) {
 	case SPEED_10:
@@ -499,11 +499,9 @@ void felix_port_adjust_link(struct net_device *dev)
 		break;
 	case SPEED_1000:
 		speed = OCELOT_SPEED_1000;
-		mode = DEV_MAC_MODE_CFG_GIGA_MODE_ENA;
 		break;
 	case SPEED_2500:
 		speed = OCELOT_SPEED_2500;
-		mode = DEV_MAC_MODE_CFG_GIGA_MODE_ENA;
 		break;
 	default:
 		netdev_err(dev, "Unsupported PHY speed: %d\n",
@@ -517,9 +515,6 @@ void felix_port_adjust_link(struct net_device *dev)
 		return;
 	netdev_err(dev, "DBG %s:%d\n", __func__, __LINE__);
 
-	/* Only full duplex supported for now */
-	ocelot_port_writel(port, DEV_MAC_MODE_CFG_FDX_ENA |
-			   mode, DEV_MAC_MODE_CFG);
 
 	/* Set MAC IFG Gaps
 	 * FDX: TX_IFG = 5, RX_IFG1 = RX_IFG2 = 0
@@ -546,12 +541,6 @@ void felix_port_adjust_link(struct net_device *dev)
 	ocelot_port_writel(port, DEV_MAC_ENA_CFG_RX_ENA |
 			   DEV_MAC_ENA_CFG_TX_ENA, DEV_MAC_ENA_CFG);
 
-	/* Take MAC, Port, Phy (intern) and PCS (SGMII/Serdes) clock out of
-	 * reset
-	 */
-	ocelot_port_writel(port, DEV_CLOCK_CFG_LINK_SPEED(speed),
-			   DEV_CLOCK_CFG);
-
 	/* Set SMAC of Pause frame (00:00:00:00:00:00) */
 	ocelot_port_writel(port, 0, DEV_MAC_FC_MAC_HIGH_CFG);
 	ocelot_port_writel(port, 0, DEV_MAC_FC_MAC_LOW_CFG);
-- 
2.17.1

