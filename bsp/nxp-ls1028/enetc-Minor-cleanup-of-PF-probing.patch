From cbd217bf01e6ed6171f58e6f6d3c2dfb3254b9a9 Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Thu, 5 Oct 2017 18:06:13 +0300
Subject: [PATCH 060/706] enetc: Minor cleanup of PF probing

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 016d74988e0128b50597b537580173b93eedf341)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c   | 18 ++++++++++++------
 .../net/ethernet/freescale/enetc/enetc_hw.h    |  1 +
 2 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index 20c5cfe33af1..aea1334acbc4 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -1252,17 +1252,22 @@ static int enetc_pci_probe(struct pci_dev *pdev,
 
 	priv = netdev_priv(ndev);
 
-	if (pdev->device == ENETC_DEV_ID_VF) {
+	if (pdev->device == ENETC_DEV_ID_PF) {
+		enetc_netdev_setup(si, ndev, &enetc_ndev_ops);
+		enetc_sw_init(priv);
+
+		enetc_configure_port(priv);
+
+	} else if (pdev->device == ENETC_DEV_ID_VF) {
 		/* VFs have a different set of ndos and can't touch the port */
 		enetc_netdev_setup(si, ndev, &enetc_ndev_vf_ops);
 		enetc_sw_init(priv);
 
 	} else {
-		enetc_netdev_setup(si, ndev, &enetc_ndev_ops);
-		enetc_sw_init(priv);
-
-		enetc_configure_port(priv);
+		WARN_ON(1);
+		goto err_si_config;
 	}
+
 	enetc_configure_si(priv);
 
 	err = enetc_alloc_msix(priv);
@@ -1285,6 +1290,7 @@ static int enetc_pci_probe(struct pci_dev *pdev,
 err_reg_netdev:
 	enetc_free_msix(priv);
 err_alloc_msix:
+err_si_config:
 	si->ndev = NULL;
 	free_netdev(ndev);
 err_alloc_netdev:
@@ -1344,7 +1350,7 @@ static int enetc_sriov_configure(struct pci_dev *pdev, int num_vfs)
 #endif
 
 static const struct pci_device_id enetc_id_table[] = {
-	{ PCI_DEVICE(PCI_VENDOR_ID_FREESCALE, 0xe100) },
+	{ PCI_DEVICE(PCI_VENDOR_ID_FREESCALE, ENETC_DEV_ID_PF) },
 	{ PCI_DEVICE(PCI_VENDOR_ID_FREESCALE, ENETC_DEV_ID_VF) },
 	{ 0, } /* End of table. */
 };
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index b6ac018f3082..82734c958e79 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -1,6 +1,7 @@
 #include <linux/bitops.h>
 
 /* ENETC device IDs */
+#define ENETC_DEV_ID_PF	0xe100
 #define ENETC_DEV_ID_VF	0xef00
 
 /* ENETC register block BAR */
-- 
2.17.1

