From 150c736cb824c52644b0bec42d684f60c250ed4c Mon Sep 17 00:00:00 2001
From: Catalin Horghidan <catalin.horghidan@nxp.com>
Date: Tue, 12 Feb 2019 10:01:47 +0200
Subject: [PATCH 633/706] felix: configure the NPI only if the pair eth is
 provided

Signed-off-by: Catalin Horghidan <catalin.horghidan@nxp.com>
(cherry picked from commit a6ee24fea9e716978becaea24d8f7412b53a09a5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c | 28 +++++++++++++++----------
 1 file changed, 17 insertions(+), 11 deletions(-)

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index 507361d328bf..a4cdf1c1547b 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -381,14 +381,23 @@ static int felix_ports_init(struct pci_dev *pdev)
 	struct device_node *phy_node = NULL;
 	struct device_node *portnp = NULL;
 	struct phy_device *phydev = NULL;
+	struct net_device *ndev = NULL;
 	struct resource *felix_res;
 	void __iomem *port_regs;
-	struct net_device *ndev;
 	u32 port, frmt;
 	int err;
 
-	ocelot->num_cpu_ports = 1;
-	ocelot->cpu_port_id = FELIX_EXT_CPU_PORT_ID;
+	if (pair_eth)
+		ndev = dev_get_by_name(&init_net, pair_eth);
+
+	if (ndev) {
+		ocelot->cpu_port_id = FELIX_EXT_CPU_PORT_ID;
+		ocelot->num_cpu_ports = 1;
+	} else {
+		ocelot->cpu_port_id = FELIX_MAX_NUM_PHY_PORTS;
+		ocelot->num_cpu_ports = 0;
+	}
+
 	ocelot->num_phys_ports = FELIX_MAX_NUM_PHY_PORTS;
 	ocelot->ports = devm_kcalloc(ocelot->dev, ocelot->num_phys_ports,
 				     sizeof(struct ocelot_port *), GFP_KERNEL);
@@ -398,10 +407,6 @@ static int felix_ports_init(struct pci_dev *pdev)
 	if (err)
 		return err;
 
-	ndev = NULL;
-	if (pair_eth)
-		ndev = dev_get_by_name(&init_net, pair_eth);
-
 	for_each_available_child_of_node(np, portnp) {
 		if (!portnp || !portnp->name ||
 		    of_node_cmp(portnp->name, "port") ||
@@ -452,7 +457,7 @@ static int felix_ports_init(struct pci_dev *pdev)
 		phy_attached_info(phydev);
 
 		/* expected frame format */
-		if (port == FELIX_EXT_CPU_PORT_ID)
+		if (ndev && port == FELIX_EXT_CPU_PORT_ID)
 			/* short prefix frame tag on tx and long on rx */
 			frmt = SYS_PORT_MODE_INCL_XTR_HDR(3) |
 			      SYS_PORT_MODE_INCL_INJ_HDR(1);
@@ -488,9 +493,10 @@ static int felix_ports_init(struct pci_dev *pdev)
 			felix_register_xmit_handler(ocelot->ports[port], ndev);
 	}
 	/* set port for external CPU frame extraction/injection */
-	ocelot_write(ocelot, QSYS_EXT_CPU_CFG_EXT_CPUQ_MSK_M |
-		     QSYS_EXT_CPU_CFG_EXT_CPU_PORT(FELIX_EXT_CPU_PORT_ID),
-		     QSYS_EXT_CPU_CFG);
+	if (ndev)
+		ocelot_write(ocelot, QSYS_EXT_CPU_CFG_EXT_CPUQ_MSK_M |
+			     QSYS_EXT_CPU_CFG_EXT_CPU_PORT(FELIX_EXT_CPU_PORT_ID),
+			     QSYS_EXT_CPU_CFG);
 
 	return 0;
 
-- 
2.17.1

