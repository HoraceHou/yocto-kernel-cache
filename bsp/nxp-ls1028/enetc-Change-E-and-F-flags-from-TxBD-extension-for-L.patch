From 54e3cc6970d3bd2430397c7c515abdfcd9b30cbd Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Thu, 7 Jun 2018 13:56:18 +0300
Subject: [PATCH 156/706] enetc: Change E and F flags from TxBD extension for
 L2C release

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit e5f3713eefa702b26cb64f739280a3c460e803db)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index ca35f9b9d443..a30c3f047598 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -194,8 +194,9 @@ static int enetc_map_tx_buffs(struct enetc_bdr *tx_ring, struct sk_buff *skb)
 	/* first BD needs frm_len set */
 	txbd->frm_len = cpu_to_le16(skb->len);
 	/* last BD needs 'F' bit set */
-	if (!nr_frags)
+	if (!nr_frags && !(flags & ENETC_TXBD_FLAGS_EX))
 		flags |= ENETC_TXBD_FLAGS_F;
+
 	txbd->flags = flags;
 
 	if (flags & ENETC_TXBD_FLAGS_EX) {
@@ -220,8 +221,9 @@ static int enetc_map_tx_buffs(struct enetc_bdr *tx_ring, struct sk_buff *skb)
 			skb_shinfo(skb)->tx_flags |= SKBTX_IN_PROGRESS;
 		}
 
-		/* set 'F' if last */
-		txbd->ext.flags = flags & ENETC_TXBD_FLAGS_F;
+		if (!nr_frags)
+			txbd->ext.flags = ENETC_TXBD_FLAGS_F;
+
 		count++;
 	}
 
-- 
2.17.1

