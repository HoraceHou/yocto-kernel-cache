From d7bf17fbd621878b2025e8683478d3a9bcd1d591 Mon Sep 17 00:00:00 2001
From: Catalin Horghidan <catalin.horghidan@nxp.com>
Date: Mon, 11 Feb 2019 18:48:08 +0200
Subject: [PATCH 631/706] felix: remove xtr header bytes by using a single pull

Signed-off-by: Catalin Horghidan <catalin.horghidan@nxp.com>
(cherry picked from commit 25ec8fc4d5e1e37c1979bc84cdef4776c008f561)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index fdb4be2943fa..93f5f77a8581 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -216,20 +216,17 @@ static rx_handler_result_t felix_frm_ext_handler(struct sk_buff **pskb)
 	struct net_device *ndev = (*pskb)->dev;
 	struct sk_buff *skb = *pskb;
 	struct ocelot_port *port;
-	void *start = skb->data;
+	char *start = skb->data;
 	struct ocelot *ocelot;
 	u64 *efh;
 	u32 p;
 
-	/* ETH_HLEN bytes were already pulled by receivig driver */
-	efh = skb_pull(skb, 2);
+	/* extraction header offset: assume eth header was consumed */
+	efh = (u64 *)(start + FELIX_XFH_LEN - ETH_HLEN);
 
 	p = felix_get_efh_srcp(efh);
 	/* TODO: use traffic class from header */
 
-	/* pull cpu extraction header */
-	skb_pull(skb, FELIX_XFH_LEN);
-
 	/* don't pass frames with unknown header format back to interface */
 	if (unlikely(p >= FELIX_MAX_NUM_PHY_PORTS)) {
 		kfree_skb(skb);
@@ -243,6 +240,9 @@ static rx_handler_result_t felix_frm_ext_handler(struct sk_buff **pskb)
 		ndev = port->dev;
 	}
 
+	/* pull the rest of extraction header */
+	skb_pull(skb, XFH_LONG_PREFIX_LEN - ETH_HLEN);
+
 	skb->protocol = eth_type_trans(skb, ndev);
 	/* TODO: recompute checksum */
 	skb_reset_transport_header(skb);
-- 
2.17.1

