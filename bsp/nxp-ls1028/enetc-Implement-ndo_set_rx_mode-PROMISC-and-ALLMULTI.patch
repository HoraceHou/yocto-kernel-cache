From 336d6b0a197203e22a34f2521802ee86c47f03ea Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Thu, 7 Sep 2017 17:47:14 +0300
Subject: [PATCH 051/706] enetc: Implement ndo_set_rx_mode, PROMISC and
 ALLMULTI

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 7f8fb8282eb903169e20e4c32058e3a1782dd743)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c  | 20 +++++++++++++++++++
 .../net/ethernet/freescale/enetc/enetc_hw.h   |  2 ++
 2 files changed, 22 insertions(+)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index d3cf5aa9524f..25f667ba418d 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -970,6 +970,25 @@ static int enetc_set_mac_addr(struct net_device *ndev, void *addr)
 	return 0;
 }
 
+static void enetc_set_rx_mode(struct net_device *ndev)
+{
+	struct enetc_ndev_priv *priv = netdev_priv(ndev);
+	struct enetc_hw *hw = &priv->si->hw;
+	u32 psipmr = 0;
+
+	if (ndev->flags & IFF_PROMISC) {
+		/* enable promisc mode for SI0 (PF) */
+		psipmr = ENETC_PSIPMR_SET_UP(0) | ENETC_PSIPMR_SET_MP(0);
+	} else if (ndev->flags & IFF_ALLMULTI) {
+		/* enable multi cast promisc mode for SI0 (PF) */
+		psipmr = ENETC_PSIPMR_SET_MP(0);
+	}
+
+	psipmr |= enetc_rd(hw, ENETC_PSIPMR) &
+		  ~(ENETC_PSIPMR_SET_UP(0) | ENETC_PSIPMR_SET_MP(0));
+	enetc_wr(hw, ENETC_PSIPMR, psipmr);
+}
+
 static struct net_device_stats *enetc_get_stats(struct net_device *ndev)
 {
 	struct enetc_ndev_priv *priv = netdev_priv(ndev);
@@ -1004,6 +1023,7 @@ static const struct net_device_ops enetc_ndev_ops = {
 	.ndo_start_xmit		= enetc_xmit,
 	.ndo_get_stats		= enetc_get_stats,
 	.ndo_set_mac_address	= enetc_set_mac_addr,
+	.ndo_set_rx_mode	= enetc_set_rx_mode,
 };
 
 static void enetc_netdev_setup(struct enetc_si *si, struct net_device *ndev)
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index 589ca580aca8..d57326ff30df 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -57,6 +57,8 @@ enum enetc_bdr_type {TX, RX};
 #define ENETC_PMR_EN	GENMASK(17, 16)
 #define ENETC_PSR	0x10004 /* RO */
 #define ENETC_PSIPMR	0x10018
+#define ENETC_PSIPMR_SET_UP(n)	(0x1 << (n)) /* n = SI index */
+#define ENETC_PSIPMR_SET_MP(n)	(0x1 << ((n) + 8))
 #define ENETC_PSIPMAR0(n)	(0x10100 + (n) * 0x20) /* n = SI index */
 #define ENETC_PSIPMAR1(n)	(0x10104 + (n) * 0x20)
 #define ENETC_PCAPR0	0x10900
-- 
2.17.1

