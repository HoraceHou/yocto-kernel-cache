From 2f88d06ab2f6ec16df16c67e6d241fc9b58a7756 Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@nxp.com>
Date: Fri, 1 Sep 2017 17:45:55 +0300
Subject: [PATCH 049/706] enetc: Port driver to BG v0.9 model

Signed-off-by: Claudiu Manoil <claudiu.manoil@nxp.com>
(cherry picked from commit 9290796d1a489e05ceaa867af96c7c9a795e5a11)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/freescale/enetc/enetc.c     | 16 ++++++++++------
 .../net/ethernet/freescale/enetc/enetc_ethtool.c |  3 +++
 drivers/net/ethernet/freescale/enetc/enetc_hw.h  | 11 +++++++----
 3 files changed, 20 insertions(+), 10 deletions(-)

diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.c
index 227e249ae4bb..0ee968e93f2d 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc.c
@@ -710,10 +710,12 @@ static void enetc_setup_txbdr(struct enetc_hw *hw, struct enetc_bdr *tx_ring)
 	enetc_txbdr_wr(hw, idx, ENETC_TBBAR1,
 		       upper_32_bits(tx_ring->bd_dma_base));
 
-	WARN_ON(tx_ring->bd_count & 0x3f); // must be multiple of 64
+	WARN_ON(tx_ring->bd_count & 0x3f); //FIXME: must be multiple of 64
 
-	tbmr = ENETC_RTBMR_RSIZE(tx_ring->bd_count);
-	tbmr |= ENETC_TBMR_EN;
+	enetc_txbdr_wr(hw, idx, ENETC_TBLENR,
+		       ENETC_RTBLENR_LEN(tx_ring->bd_count));
+
+	tbmr = ENETC_TBMR_EN;
 	/* enable ring */
 	enetc_txbdr_wr(hw, idx, ENETC_TBMR, tbmr);
 
@@ -736,15 +738,17 @@ static void enetc_setup_rxbdr(struct enetc_hw *hw, struct enetc_bdr *rx_ring)
 	enetc_rxbdr_wr(hw, idx, ENETC_RBBAR1,
 		       upper_32_bits(rx_ring->bd_dma_base));
 
-	WARN_ON(rx_ring->bd_count & 0x3f); // must be multiple of 64
+	WARN_ON(rx_ring->bd_count & 0x3f); //FIXME: must be multiple of 64
+
+	enetc_rxbdr_wr(hw, idx, ENETC_RBLENR,
+		       ENETC_RTBLENR_LEN(rx_ring->bd_count));
 
 	enetc_rxbdr_wr(hw, idx, ENETC_RBBSR, ENETC_RXB_DMA_SIZE);
 
 	/* enable Rx ints by setting pkt thr to 1 (BG 0.7) */
 	enetc_rxbdr_wr(hw, idx, ENETC_RBICIR0, ENETC_RBICIR0_ICEN | 0x1);
 
-	rbmr = ENETC_RTBMR_RSIZE(rx_ring->bd_count);
-	rbmr |= ENETC_RBMR_EN;
+	rbmr = ENETC_RBMR_EN;
 	/* enable ring */
 	enetc_rxbdr_wr(hw, idx, ENETC_RBMR, rbmr);
 
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_ethtool.c b/drivers/net/ethernet/freescale/enetc/enetc_ethtool.c
index ee9374205796..66ca6f0c02fd 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_ethtool.c
+++ b/drivers/net/ethernet/freescale/enetc/enetc_ethtool.c
@@ -43,6 +43,7 @@ static void enetc_get_regs(struct net_device *ndev, struct ethtool_regs *regs,
 		PR_BDR_REG(hw, tx, i, TBBAR1);
 		PR_BDR_REG(hw, tx, i, TBCIR);
 		PR_BDR_REG(hw, tx, i, TBCISR);
+		PR_BDR_REG(hw, tx, i, TBLENR);
 		PR_BDR_REG(hw, tx, i, TBIER);
 	}
 	/** Rx BDR dump */
@@ -54,6 +55,7 @@ static void enetc_get_regs(struct net_device *ndev, struct ethtool_regs *regs,
 		PR_BDR_REG(hw, rx, i, RBBAR0);
 		PR_BDR_REG(hw, rx, i, RBBAR1);
 		PR_BDR_REG(hw, rx, i, RBPIR);
+		PR_BDR_REG(hw, rx, i, RBLENR);
 		PR_BDR_REG(hw, rx, i, RBICIR0);
 		PR_BDR_REG(hw, rx, i, RBIER);
 	}
@@ -63,6 +65,7 @@ static void enetc_get_regs(struct net_device *ndev, struct ethtool_regs *regs,
 	PR_REG(hw, PSIPMR);
 	PR_REG(hw, PCAPR0);
 	PR_REG(hw, PCAPR1);
+	PR_REG(hw, PV0CFGR);
 	PR_REG(hw, PM0_CMD_CFG);
 	PR_REG(hw, PM0_MAXFRM);
 
diff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
index 923afbb80187..b4619eb9f8ca 100644
--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h
+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h
@@ -25,6 +25,7 @@ enum enetc_bdr_type {TX, RX};
 #define ENETC_RBBAR0	0x10
 #define ENETC_RBBAR1	0x14
 #define ENETC_RBPIR	0x18
+#define ENETC_RBLENR	0x20
 #define ENETC_RBIER	0xa0
 #define ENETC_RBIER_RXTIE	BIT(0)
 #define ENETC_RBIDR	0xa4
@@ -38,25 +39,27 @@ enum enetc_bdr_type {TX, RX};
 #define ENETC_TBBAR1	0x14
 #define ENETC_TBCIR	0x18
 #define ENETC_TBCISR	0x1c
+#define ENETC_TBLENR	0x20
 #define ENETC_TBCISR_IDX_MASK	0xffff
 #define ENETC_TBIER	0xa0
 #define ENETC_TBIER_TXFIE	BIT(1)
 #define ENETC_TBIDR	0xa4
 
-#define ENETC_RTBMR_RSIZE(n) __ilog2_u32((n) >> 6)
+//FIXME , BG 0.7: #define ENETC_RTBMR_RSIZE(n)  __ilog2_u32((n) >> 6)
+#define ENETC_RTBLENR_LEN(n)	(((n) >> 3) << 7)
 #define ENETC_TBMR_EN	BIT(31)
 
 /* Port regs, offset: 1_0000h */
 #define ENETC_PMR	0x10000
-#define ENETC_PMR_EN	BIT(31)
+#define ENETC_PMR_EN	GENMASK(17, 16)
 #define ENETC_PSR	0x10004 /* RO */
 #define ENETC_PSIPMR	0x10018
 #define ENETC_PCAPR0	0x10900
 #define ENETC_PCAPR1	0x10904
 
 #define ENETC_PV0CFGR	0x10920
-#define ENETC_PVCFGR_SET_TXBDR(val)	((val) & 0xffff)
-#define ENETC_PVCFGR_SET_RXBDR(val)	(((val) & 0xffff) << 8)
+#define ENETC_PVCFGR_SET_TXBDR(val)	((val) & 0xff)
+#define ENETC_PVCFGR_SET_RXBDR(val)	(((val) & 0xff) << 16)
 
 #define ENETC_PM0_CMD_CFG	0x18008
 #define ENETC_PM0_TX_EN		BIT(31)
-- 
2.17.1

