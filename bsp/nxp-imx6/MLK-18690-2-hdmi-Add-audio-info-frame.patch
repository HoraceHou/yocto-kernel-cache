From a76992b137aacb912c96d5b0e81e201241993f04 Mon Sep 17 00:00:00 2001
From: Sandor Yu <Sandor.yu@nxp.com>
Date: Tue, 26 Jun 2018 16:49:04 +0800
Subject: [PATCH 4106/5242] MLK-18690-2: hdmi: Add audio info frame

commit  67622bfcf81d3da0f1471a36bbc098befd60f72b from
https://source.codeaurora.org/external/imx/linux-imx.git

Add audio info frame for hdp hdmi driver.

Signed-off-by: Sandor Yu <Sandor.yu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/imx/hdp/imx-hdp-audio.c |   28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/drivers/gpu/drm/imx/hdp/imx-hdp-audio.c b/drivers/gpu/drm/imx/hdp/imx-hdp-audio.c
index 40313e0..e77bc90 100644
--- a/drivers/gpu/drm/imx/hdp/imx-hdp-audio.c
+++ b/drivers/gpu/drm/imx/hdp/imx-hdp-audio.c
@@ -60,6 +60,30 @@ static int select_N_index(u32 pclk)
 	return i;
 }
 
+static void imx_hdmi_audio_avi_set(state_struct *state,
+						u32 channels)
+{
+	struct hdmi_audio_infoframe frame;
+	u8 buf[32];
+	int ret;
+
+	hdmi_audio_infoframe_init(&frame);
+
+	frame.channels = channels;
+	frame.coding_type = HDMI_AUDIO_CODING_TYPE_PCM;
+
+	ret = hdmi_audio_infoframe_pack(&frame, buf + 1, sizeof(buf) - 1);
+	if (ret < 0) {
+		DRM_ERROR("failed to pack audio infoframe: %d\n", ret);
+		return;
+	}
+
+	buf[0] = 0;
+
+	CDN_API_InfoframeSet(state, 1, sizeof(buf),
+				    (u32 *)buf, HDMI_INFOFRAME_TYPE_AUDIO);
+}
+
 static u32 imx_hdp_audio(struct imx_hdp *hdmi, AUDIO_TYPE type, u32 sample_rate, u32 channels, u32 width)
 {
 	AUDIO_FREQ  freq;
@@ -126,6 +150,10 @@ static u32 imx_hdp_audio(struct imx_hdp *hdmi, AUDIO_TYPE type, u32 sample_rate,
 				hdmi->audio_type,
 				ncts_n,
 				AUDIO_MUTE_MODE_UNMUTE);
+
+	if (hdmi->audio_type == CDN_HDMITX_TYPHOON ||
+			hdmi->audio_type == CDN_HDMITX_KIRAN)
+		imx_hdmi_audio_avi_set(state, channels);
 	return 0;
 }
 
-- 
1.7.9.5

