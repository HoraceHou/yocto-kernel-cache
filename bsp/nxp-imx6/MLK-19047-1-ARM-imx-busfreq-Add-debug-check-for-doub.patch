From f9da4d5856a48c53e7345a0520ca44e07d608b4b Mon Sep 17 00:00:00 2001
From: Leonard Crestez <leonard.crestez@nxp.com>
Date: Fri, 3 Aug 2018 14:52:32 +0300
Subject: [PATCH 4303/5242] MLK-19047-1 ARM: imx: busfreq: Add debug check for
 double notify

commit  34b7bf1b17b8cb20a12121605caa5d30f178f6fa from
https://source.codeaurora.org/external/imx/linux-imx.git

The only user of busfreq notifiers is imx_thermal and if it receives a
double LOW_BUSFREQ_ENTER it will incorrectly decrease the reference
count on its clk. Since tempmon uses pll3 directly this can cause
problems like uart hangs.

Guard against this scenario with an explicit check and warn inside
busfreq_notify. This is not a high-performance path so it's better to be
safe.

Signed-off-by: Leonard Crestez <leonard.crestez@nxp.com>
Acked-by: Anson Huang <Anson.Huang@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/mach-imx/busfreq-imx.c |    9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/arch/arm/mach-imx/busfreq-imx.c b/arch/arm/mach-imx/busfreq-imx.c
index 29f6b29..d265716 100644
--- a/arch/arm/mach-imx/busfreq-imx.c
+++ b/arch/arm/mach-imx/busfreq-imx.c
@@ -139,10 +139,19 @@ static bool check_m4_sleep(void)
 	return  true;
 }
 
+static bool busfreq_notified_low = false;
+
 static int busfreq_notify(enum busfreq_event event)
 {
 	int ret;
 
+	if (event == LOW_BUSFREQ_ENTER) {
+		WARN_ON(busfreq_notified_low);
+		busfreq_notified_low = true;
+	} else if (event == LOW_BUSFREQ_EXIT) {
+		WARN_ON(!busfreq_notified_low);
+		busfreq_notified_low = false;
+	}
 	ret = raw_notifier_call_chain(&busfreq_notifier_chain, event, NULL);
 
 	return notifier_to_errno(ret);
-- 
1.7.9.5

