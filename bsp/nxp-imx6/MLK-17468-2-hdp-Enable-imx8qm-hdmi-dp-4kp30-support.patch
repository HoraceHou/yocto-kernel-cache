From aafc8b53cfbdd0c630d291eaad7a35e039d0a75a Mon Sep 17 00:00:00 2001
From: Sandor Yu <Sandor.yu@nxp.com>
Date: Mon, 29 Jan 2018 16:43:16 +0800
Subject: [PATCH 3262/5242] MLK-17468-2: hdp: Enable imx8qm hdmi/dp 4kp30
 support

commit  86de4b40fccd14f2fc11bb4363a5fa1f872ff259 from
https://source.codeaurora.org/external/imx/linux-imx.git

Add link rate select function.
Change max support pixel clock rate to 297MHz(4kp30).

Because edid read function is not enabled.
For such TV that max support 1080p60 or 720p60,
the followed cmdline mode should be added to kernel boot args:
video=HDMI-A-1:1920x1080-32@60 or
video=HDMI-A-1:1280x720-32@60

Signed-off-by: Sandor Yu <Sandor.yu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/imx/hdp/imx-hdp.c |   13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/imx/hdp/imx-hdp.c b/drivers/gpu/drm/imx/hdp/imx-hdp.c
index fde815a..3b5cfa4 100644
--- a/drivers/gpu/drm/imx/hdp/imx-hdp.c
+++ b/drivers/gpu/drm/imx/hdp/imx-hdp.c
@@ -572,6 +572,16 @@ static int imx_get_vic_index(struct drm_display_mode *mode)
 	return -1;
 }
 
+static u8 imx_hdp_link_rate(struct drm_display_mode *mode)
+{
+	if (mode->clock < 297000)
+		return AFE_LINK_RATE_1_6;
+	else if (mode->clock > 297000)
+		return AFE_LINK_RATE_5_4;
+	else
+		return AFE_LINK_RATE_2_7;
+}
+
 static void imx_hdp_mode_setup(struct imx_hdp *hdp, struct drm_display_mode *mode)
 {
 	int dp_vic;
@@ -594,6 +604,7 @@ static void imx_hdp_mode_setup(struct imx_hdp *hdp, struct drm_display_mode *mod
 	/* Config pixel link mux */
 	imx_hdp_call(hdp, pixel_link_mux, &hdp->state, mode);
 
+	hdp->link_rate = imx_hdp_link_rate(mode);
 	/* mode set */
 	ret = imx_hdp_call(hdp, phy_init, &hdp->state, dp_vic, 1, 8);
 	if (ret < 0) {
@@ -718,7 +729,7 @@ static int imx_hdp_connector_get_modes(struct drm_connector *connector)
 
 	if (hdp->is_4kp60 && mode->clock > 594000)
 		return MODE_CLOCK_HIGH;
-	else if (!hdp->is_4kp60 && mode->clock > 150000)
+	else if (!hdp->is_4kp60 && mode->clock > 297000)
 		return MODE_CLOCK_HIGH;
 
 	/* 4096x2160 is not supported now */
-- 
1.7.9.5

