From fff8c52ced76276f8441f73adefd597ebe45fae5 Mon Sep 17 00:00:00 2001
From: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Date: Thu, 25 Jan 2018 11:27:46 +0200
Subject: [PATCH 3390/5242] MLK-17634-4: drm: move hdr_panel_metadata to
 drm_hdmi_info

commit  24d51d0012fb1eecba20bb6317b5ee419ad61247 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/drm_edid.c        |   21 +++++++++++----------
 drivers/gpu/drm/imx/hdp/imx-hdp.c |    3 +++
 include/drm/drm_connector.h       |    3 ++-
 3 files changed, 16 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/drm_edid.c b/drivers/gpu/drm/drm_edid.c
index 0b56e7d..7f19a47 100644
--- a/drivers/gpu/drm/drm_edid.c
+++ b/drivers/gpu/drm/drm_edid.c
@@ -3881,22 +3881,23 @@ static uint16_t hdr_metadata_type(const u8 *edid_ext)
 static void
 drm_parse_hdr_metadata_block(struct drm_connector *connector, const u8 *db)
 {
+	struct drm_hdmi_info *info = &connector->display_info.hdmi;
 	uint16_t len;
 
 	len = cea_db_payload_len(db);
-	connector->hdr_panel_metadata->eotf = eotf_supported(db);
-	connector->hdr_panel_metadata->type = hdr_metadata_type(db);
+	info->hdr_panel_metadata.eotf = eotf_supported(db);
+	info->hdr_panel_metadata.type = hdr_metadata_type(db);
 
 	if (len == 6) {
-		connector->hdr_panel_metadata->max_cll = db[4];
-		connector->hdr_panel_metadata->max_fall = db[5];
-		connector->hdr_panel_metadata->min_cll = db[6];
+		info->hdr_panel_metadata.max_cll = db[4];
+		info->hdr_panel_metadata.max_fall = db[5];
+		info->hdr_panel_metadata.min_cll = db[6];
 	} else if (len == 5) {
-		connector->hdr_panel_metadata->max_cll = db[4];
-		connector->hdr_panel_metadata->max_fall = db[5];
-	} else if (len == 4)
-		connector->hdr_panel_metadata->max_cll = db[4];
-
+		info->hdr_panel_metadata.max_cll = db[4];
+		info->hdr_panel_metadata.max_fall = db[5];
+	} else if (len == 4) {
+		info->hdr_panel_metadata.max_cll = db[4];
+	}
 }
 
 static void
diff --git a/drivers/gpu/drm/imx/hdp/imx-hdp.c b/drivers/gpu/drm/imx/hdp/imx-hdp.c
index e3fb088..f3647a2 100644
--- a/drivers/gpu/drm/imx/hdp/imx-hdp.c
+++ b/drivers/gpu/drm/imx/hdp/imx-hdp.c
@@ -1049,6 +1049,9 @@ static int imx_hdp_imx_bind(struct device *dev, struct device *master,
 			   &imx_hdp_connector_funcs,
 			   DRM_MODE_CONNECTOR_HDMIA);
 
+	drm_object_attach_property(&connector->base,
+		connector->dev->mode_config.hdr_source_metadata_property, 0);
+
 	drm_mode_connector_attach_encoder(connector, encoder);
 
 	dev_set_drvdata(dev, hdp);
diff --git a/include/drm/drm_connector.h b/include/drm/drm_connector.h
index cb6d3cc..164e9e5 100644
--- a/include/drm/drm_connector.h
+++ b/include/drm/drm_connector.h
@@ -161,6 +161,8 @@ struct drm_hdmi_info {
 
 	/* Colorimerty info from EDID */
 	u32 colorimetry;
+	/* Panel HDR capabilities */
+	struct hdr_static_metadata hdr_panel_metadata;
 };
 
 /**
@@ -1003,7 +1005,6 @@ struct drm_connector {
 	struct llist_node free_node;
 
 	/* HDR metdata */
-	struct hdr_static_metadata *hdr_panel_metadata;
 	struct hdr_static_metadata *hdr_source_metadata;
 };
 
-- 
1.7.9.5

