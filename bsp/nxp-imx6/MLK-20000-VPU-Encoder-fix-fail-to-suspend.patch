From e74b8e864868ab7734c6e2d14584efdc9dff3c61 Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Mon, 22 Oct 2018 09:34:32 +0800
Subject: [PATCH 4892/5242] MLK-20000:VPU Encoder:fix fail to suspend

commit  eb0709b9d4bbb1eff753e46cf7b08db23ceff640 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c |   20 +++++++++++++++++---
 1 file changed, 17 insertions(+), 3 deletions(-)

diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index 3e57bfe..ba9bc4e 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -1256,6 +1256,8 @@ static void v4l2_transfer_buffer_to_firmware(struct queue_data *This,
 	if (!test_and_set_bit(VPU_ENC_STATUS_CONFIGURED, &ctx->status)) {
 		configure_codec(ctx);
 		dump_vb2_data(vb);
+		clear_bit(VPU_ENC_STATUS_STOP_SEND, &ctx->status);
+		clear_bit(VPU_ENC_STATUS_STOP_DONE, &ctx->status);
 	}
 	mutex_unlock(&ctx->instance_mutex);
 }
@@ -3261,10 +3263,22 @@ static struct vpu_ctx *first_available_instance(struct core_device *core_dev)
 	int idx;
 
 	for (idx = 0; idx < VPU_MAX_NUM_STREAMS; idx++) {
-		if (!core_dev->ctx[idx])
+		struct vpu_ctx *ctx = core_dev->ctx[idx];
+
+		if (!ctx)
+			continue;
+		if (!test_bit(VPU_ENC_STATUS_INITIALIZED, &ctx->status))
+			continue;
+		if (!test_bit(VPU_ENC_STATUS_CONFIGURED, &ctx->status))
+			continue;
+		if (test_bit(VPU_ENC_STATUS_CLOSED, &ctx->status))
 			continue;
-		if (!test_bit(VPU_ENC_STATUS_HANG, &core_dev->ctx[idx]->status))
-			return core_dev->ctx[idx];
+		if (test_bit(VPU_ENC_STATUS_STOP_SEND, &ctx->status))
+			continue;
+		if (test_bit(VPU_ENC_STATUS_STOP_DONE, &ctx->status))
+			continue;
+
+		return ctx;
 	}
 
 	return NULL;
-- 
1.7.9.5

