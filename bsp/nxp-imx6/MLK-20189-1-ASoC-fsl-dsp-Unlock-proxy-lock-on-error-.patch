From d7b8358c0146d05eebec9334f18cfc11baf968dc Mon Sep 17 00:00:00 2001
From: Daniel Baluta <daniel.baluta@nxp.com>
Date: Thu, 8 Nov 2018 14:40:50 +0200
Subject: [PATCH 5074/5242] MLK-20189-1: ASoC: fsl: dsp: Unlock proxy->lock on
 error path

commit  8464574897e56768f164b19f9f80e791b6c1092a from
https://source.codeaurora.org/external/imx/linux-imx.git

xf_cmd_recv will return with lock taken in two cases:
	* msg was received
	* waiting for msg was interrupted by a signal

Make sure we unlock proxy->lock in both cases.

This fixes Coverity issue: CID3335482.

Reviewed-by: S.j. Wang <shengjiu.wang@nxp.com>
Reviewed-by: Cosmin-Gabriel Samoila <cosmin.samoila@nxp.com>
Signed-off-by: Daniel Baluta <daniel.baluta@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 sound/soc/fsl/fsl_dsp.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/sound/soc/fsl/fsl_dsp.c b/sound/soc/fsl/fsl_dsp.c
index 046fe7b..6e61d69 100644
--- a/sound/soc/fsl/fsl_dsp.c
+++ b/sound/soc/fsl/fsl_dsp.c
@@ -232,6 +232,7 @@ static int fsl_dsp_ipc_msg_from_dsp(struct xf_client *client,
 
 	m = xf_cmd_recv(&dsp_priv->proxy, &client->wait, &client->queue, 0);
 	if (IS_ERR(m)) {
+		xf_unlock(&dsp_priv->proxy.lock);
 		dev_err(dev, "receiving failed: %d", (int)PTR_ERR(m));
 		return PTR_ERR(m);
 	}
-- 
1.7.9.5

