From fd68770967f0e255826d9da305f355f7ef6f79af Mon Sep 17 00:00:00 2001
From: Haibo Chen <haibo.chen@nxp.com>
Date: Mon, 3 Jul 2017 18:09:19 +0800
Subject: [PATCH 2042/5242] MLK-15313-2 ARM64: dts: imx8qm-lpddr4-arm2: add
 SD3.0 support

commit  7f5a18458ab228a1a30596310de106d513926c00 from
https://source.codeaurora.org/external/imx/linux-imx.git

Add SD3.0 support for USDHC2.

Signed-off-by: Haibo Chen <haibo.chen@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../boot/dts/freescale/fsl-imx8qm-lpddr4-arm2.dts  |   51 ++++++++++++++++++--
 arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi      |    2 +
 2 files changed, 49 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-lpddr4-arm2.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-lpddr4-arm2.dts
index 8f9d174..f809fd2 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-lpddr4-arm2.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-lpddr4-arm2.dts
@@ -63,6 +63,15 @@
 			regulator-max-microvolt = <3300000>;
 			regulator-always-on;
 		};
+
+		reg_usdhc2_vmmc: usdhc2_vmmc {
+			compatible = "regulator-fixed";
+			regulator-name = "sw-3p3-sd1";
+			regulator-min-microvolt = <3300000>;
+			regulator-max-microvolt = <3300000>;
+			gpio = <&gpio4 7 GPIO_ACTIVE_HIGH>;
+			enable-active-high;
+		};
 	};
 
 	sound-cs42888 {
@@ -264,6 +273,14 @@
 			>;
 		};
 
+		pinctrl_usdhc2_gpio: usdhc2grpgpio {
+			fsl,pins = <
+				SC_P_USDHC1_DATA6_LSIO_GPIO5_IO21	0x00000021
+				SC_P_USDHC1_DATA7_LSIO_GPIO5_IO22	0x00000021
+				SC_P_USDHC1_RESET_B_LSIO_GPIO4_IO07	0x00000021
+			>;
+		};
+
 		pinctrl_usdhc2: usdhc2grp {
 			fsl,pins = <
 				SC_P_USDHC1_CLK_CONN_USDHC1_CLK		0x06000041
@@ -272,8 +289,31 @@
 				SC_P_USDHC1_DATA1_CONN_USDHC1_DATA1	0x00000021
 				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x00000021
 				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x00000021
-				SC_P_USDHC1_DATA6_LSIO_GPIO5_IO21	0x00000021
-				SC_P_USDHC1_DATA7_LSIO_GPIO5_IO22	0x00000021
+				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x00000021
+			>;
+		};
+
+		pinctrl_usdhc2_100mhz: usdhc2grp100mhz {
+			fsl,pins = <
+				SC_P_USDHC1_CLK_CONN_USDHC1_CLK		0x06000045
+				SC_P_USDHC1_CMD_CONN_USDHC1_CMD		0x00000025
+				SC_P_USDHC1_DATA0_CONN_USDHC1_DATA0	0x00000025
+				SC_P_USDHC1_DATA1_CONN_USDHC1_DATA1	0x00000025
+				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x00000025
+				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x00000025
+				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x00000021
+			>;
+		};
+
+		pinctrl_usdhc2_200mhz: usdhc2grp200mhz {
+			fsl,pins = <
+				SC_P_USDHC1_CLK_CONN_USDHC1_CLK		0x06000047
+				SC_P_USDHC1_CMD_CONN_USDHC1_CMD		0x00000027
+				SC_P_USDHC1_DATA0_CONN_USDHC1_DATA0	0x00000027
+				SC_P_USDHC1_DATA1_CONN_USDHC1_DATA1	0x00000027
+				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x00000027
+				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x00000027
+				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x00000021
 			>;
 		};
 
@@ -343,11 +383,14 @@
 };
 
 &usdhc2 {
-	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_usdhc2>;
+	pinctrl-names = "default", "state_100mhz", "state_200mhz";
+	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_gpio>;
+	pinctrl-1 = <&pinctrl_usdhc2_100mhz>, <&pinctrl_usdhc2_gpio>;
+	pinctrl-2 = <&pinctrl_usdhc2_200mhz>, <&pinctrl_usdhc2_gpio>;
 	bus-width = <4>;
 	cd-gpios = <&gpio5 22 GPIO_ACTIVE_LOW>;
 	wp-gpios = <&gpio5 21 GPIO_ACTIVE_HIGH>;
+	vmmc-supply = <&reg_usdhc2_vmmc>;
 	status = "okay";
 };
 
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi b/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
index 96d4687..00aee41 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
@@ -1965,6 +1965,8 @@
 		clock-names = "ipg", "per", "ahb";
 		assigned-clock-rates = <400000000>, <200000000>, <0>;
 		power-domains = <&pd_conn_sdch1>;
+		fsl,tuning-start-tap = <20>;
+		fsl,tuning-step= <2>;
 		status = "disabled";
 	};
 
-- 
1.7.9.5

