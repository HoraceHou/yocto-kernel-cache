From bbba0dafc41bf35f2f00313663331b8d2e6f8238 Mon Sep 17 00:00:00 2001
From: "Guoniu.Zhou" <guoniu.zhou@nxp.com>
Date: Mon, 10 Sep 2018 16:55:41 +0800
Subject: [PATCH 4575/5242] MLK-19514-3: ISI: reorder video device register
 for m2m

commit  da3f0b595b613b657f63e621049947382e84008c from
https://source.codeaurora.org/external/imx/linux-imx.git

Register m2m video device after all camera devices

Signed-off-by: Guoniu.Zhou <guoniu.zhou@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/media/platform/imx8/mxc-isi-cap.c   |   23 ++++++++-----------
 drivers/media/platform/imx8/mxc-media-dev.c |   33 ++++++++++++++++++++++++++-
 drivers/media/platform/imx8/mxc-media-dev.h |    1 +
 3 files changed, 43 insertions(+), 14 deletions(-)

diff --git a/drivers/media/platform/imx8/mxc-isi-cap.c b/drivers/media/platform/imx8/mxc-isi-cap.c
index afc63c4..c684b6a 100644
--- a/drivers/media/platform/imx8/mxc-isi-cap.c
+++ b/drivers/media/platform/imx8/mxc-isi-cap.c
@@ -1616,16 +1616,21 @@ static int mxc_isi_register_cap_device(struct mxc_isi_dev *mxc_isi,
 static int mxc_isi_register_cap_and_m2m_device(struct mxc_isi_dev *mxc_isi,
 				 struct v4l2_device *v4l2_dev)
 {
+	struct mxc_md *mxc_md = container_of(v4l2_dev, struct mxc_md, v4l2_dev);
 	int ret;
 
-	if (mxc_isi->id == 0) {
-		ret = mxc_isi_register_m2m_device(mxc_isi, v4l2_dev);
+	ret = mxc_isi_register_cap_device(mxc_isi, v4l2_dev);
+	if (ret)
+		return ret;
+
+	/* register m2m at last */
+	if (!(--mxc_md->nr_isi) && mxc_md->mxc_isi[0]) {
+		ret = mxc_isi_register_m2m_device(mxc_md->mxc_isi[0], v4l2_dev);
 		if (ret < 0)
 			return ret;
+		dev_info(&mxc_isi->pdev->dev, "register m2m device success\n");
 	}
 
-	ret = mxc_isi_register_cap_device(mxc_isi, v4l2_dev);
-
 	return ret;
 }
 
@@ -1638,20 +1643,12 @@ static int mxc_isi_subdev_registered(struct v4l2_subdev *sd)
 		return -ENXIO;
 
 	dev_dbg(&mxc_isi->pdev->dev, "%s\n", __func__);
-#if 0
-	if (mxc_isi->id == 0) {
-		/* ISI channel 0 support source input image from memory  */
-		ret = mxc_isi_register_m2m_device(mxc_isi, sd->v4l2_dev);
-		if (ret < 0)
-			return ret;
-	}
-#endif
 
 	ret = mxc_isi_register_cap_and_m2m_device(mxc_isi, sd->v4l2_dev);
 	if (ret < 0)
 		return ret;
 
-	return ret;
+	return 0;
 }
 
 static void mxc_isi_subdev_unregistered(struct v4l2_subdev *sd)
diff --git a/drivers/media/platform/imx8/mxc-media-dev.c b/drivers/media/platform/imx8/mxc-media-dev.c
index 6acefd8..52d3804 100644
--- a/drivers/media/platform/imx8/mxc-media-dev.c
+++ b/drivers/media/platform/imx8/mxc-media-dev.c
@@ -418,7 +418,7 @@ static int register_isi_entity(struct mxc_md *mxc_md, struct mxc_isi_dev *mxc_is
 	int ret;
 
 	dev_dbg(&mxc_md->pdev->dev, "%s\n", __func__);
-	if (WARN_ON(mxc_isi->id >= MXC_ISI_MAX_DEVS || mxc_md->mxc_isi[mxc_isi->id]))
+	if (WARN_ON(mxc_isi->id >= MXC_ISI_MAX_DEVS))
 		return -EBUSY;
 
 	sd->grp_id = GRP_ID_MXC_ISI;
@@ -563,6 +563,34 @@ static int mxc_md_register_platform_entities(struct mxc_md *mxc_md,
 	return ret;
 }
 
+static void mxc_md_prepare_for_m2m(struct mxc_md *mxc_md,
+							struct device_node *parent)
+{
+	struct device *dev = &mxc_md->pdev->dev;
+	struct device_node *node;
+
+	for_each_available_child_of_node(parent, node) {
+		if (!strcmp(node->name, ISI_OF_NODE_NAME)) {
+			mxc_md->nr_isi++;
+
+			/* achive ISI channel0 driver data */
+			if (of_alias_get_id(node, "isi") == 0) {
+				struct platform_device *pdev =
+								of_find_device_by_node(node);
+
+				if (pdev && pdev->dev.driver) {
+					device_lock(&pdev->dev);
+					mxc_md->mxc_isi[0] = dev_get_drvdata(&pdev->dev);
+					device_unlock(&pdev->dev);
+				}
+				put_device(&pdev->dev);
+			}
+		}
+	}
+
+	dev_dbg(dev, "%s: nr_isi = %d\n", __func__, mxc_md->nr_isi);
+}
+
 static void mxc_md_unregister_entities(struct mxc_md *mxc_md)
 {
 	int i;
@@ -636,6 +664,9 @@ static int mxc_md_probe(struct platform_device *pdev)
 		goto err_md;
 	}
 
+	/* prepare for registration m2m */
+	mxc_md_prepare_for_m2m(mxc_md, dev->of_node);
+
 	ret = mxc_md_register_platform_entities(mxc_md, dev->of_node);
 	if (ret < 0)
 		goto err_v4l2_dev;
diff --git a/drivers/media/platform/imx8/mxc-media-dev.h b/drivers/media/platform/imx8/mxc-media-dev.h
index abcd654..128d41b 100644
--- a/drivers/media/platform/imx8/mxc-media-dev.h
+++ b/drivers/media/platform/imx8/mxc-media-dev.h
@@ -97,6 +97,7 @@ struct mxc_md {
 	struct mxc_mjpeg_enc  *mjpeg_enc;
 
 	int num_sensors;
+	unsigned int nr_isi;
 	bool parallel_csi;
 
 	struct media_device media_dev;
-- 
1.7.9.5

