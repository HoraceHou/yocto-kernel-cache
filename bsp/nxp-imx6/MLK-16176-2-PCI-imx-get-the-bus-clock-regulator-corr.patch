From 84b44ea84aa4333f1a6ff61c5b1bf02b448a0cf4 Mon Sep 17 00:00:00 2001
From: Richard Zhu <hongxing.zhu@nxp.com>
Date: Tue, 15 Aug 2017 17:18:17 +0800
Subject: [PATCH 2374/5242] MLK-16176-2 PCI: imx: get the bus clock regulator
 correctly

commit  7fee8b1a9f8c5d98f42ec170ff727cf0a15f9aaa from
https://source.codeaurora.org/external/imx/linux-imx.git

In order to make sure that get the regulator correctly.
Check the return value of devm_regulator_get().
Return value directly if it is '-EPROBE_DEFER'

Signed-off-by: Richard Zhu <hongxing.zhu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/pci/controller/dwc/pci-imx6.c |    2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/pci/controller/dwc/pci-imx6.c b/drivers/pci/controller/dwc/pci-imx6.c
index 850adbd..04d9462 100644
--- a/drivers/pci/controller/dwc/pci-imx6.c
+++ b/drivers/pci/controller/dwc/pci-imx6.c
@@ -1896,6 +1896,8 @@ static int __init imx6_pcie_probe(struct platform_device *pdev)
 	if (imx6_pcie->variant == IMX6QP) {
 		imx6_pcie->pcie_bus_regulator = devm_regulator_get(dev,
 				"pcie-bus");
+		if (PTR_ERR(imx6_pcie->pcie_bus_regulator) == -EPROBE_DEFER)
+			return -EPROBE_DEFER;
 		if (IS_ERR(imx6_pcie->pcie_bus_regulator))
 			imx6_pcie->pcie_bus_regulator = NULL;
 	} else {
-- 
1.7.9.5

