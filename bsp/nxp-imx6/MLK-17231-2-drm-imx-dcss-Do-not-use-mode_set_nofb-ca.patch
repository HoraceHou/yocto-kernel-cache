From 4102de849e902410308778f3d50c638d42085b11 Mon Sep 17 00:00:00 2001
From: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Date: Tue, 12 Dec 2017 13:06:35 +0200
Subject: [PATCH 3123/5242] MLK-17231-2: drm: imx: dcss: Do not use
 mode_set_nofb callback

commit  8e82e0c3c1b66bb3f19005be6a74983850d9a969 from
https://source.codeaurora.org/external/imx/linux-imx.git

This callback is not suitable for drivers using runtime PM. Move
everything in the crtc_enable() callback.

Signed-off-by: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/imx/dcss/dcss-crtc.c |   29 ++++++++---------------------
 1 file changed, 8 insertions(+), 21 deletions(-)

diff --git a/drivers/gpu/drm/imx/dcss/dcss-crtc.c b/drivers/gpu/drm/imx/dcss/dcss-crtc.c
index e8e7f86..9931aba 100644
--- a/drivers/gpu/drm/imx/dcss/dcss-crtc.c
+++ b/drivers/gpu/drm/imx/dcss/dcss-crtc.c
@@ -118,26 +118,6 @@ static void dcss_disable_vblank(struct drm_crtc *crtc)
 	.disable_vblank = dcss_disable_vblank,
 };
 
-static void dcss_crtc_mode_set_nofb(struct drm_crtc *crtc)
-{
-	struct dcss_crtc *dcss_crtc = container_of(crtc, struct dcss_crtc,
-						   base);
-	struct drm_display_mode *mode = &crtc->state->adjusted_mode;
-	struct dcss_soc *dcss = dev_get_drvdata(dcss_crtc->dev->parent);
-	struct videomode vm;
-
-	drm_display_mode_to_videomode(mode, &vm);
-
-	pm_runtime_get_sync(dcss_crtc->dev->parent);
-
-	dcss_dtg_sync_set(dcss, &vm);
-	dcss_ss_sync_set(dcss, &vm, mode->flags & DRM_MODE_FLAG_PHSYNC,
-			 mode->flags & DRM_MODE_FLAG_PVSYNC);
-
-	pm_runtime_mark_last_busy(dcss_crtc->dev->parent);
-	pm_runtime_put_autosuspend(dcss_crtc->dev->parent);
-}
-
 static int dcss_crtc_atomic_check(struct drm_crtc *crtc,
 				  struct drm_crtc_state *state)
 {
@@ -177,9 +157,17 @@ static void dcss_crtc_atomic_enable(struct drm_crtc *crtc,
 	struct dcss_crtc *dcss_crtc = container_of(crtc, struct dcss_crtc,
 						   base);
 	struct dcss_soc *dcss = dev_get_drvdata(dcss_crtc->dev->parent);
+	struct drm_display_mode *mode = &crtc->state->adjusted_mode;
+	struct videomode vm;
+
+	drm_display_mode_to_videomode(mode, &vm);
 
 	pm_runtime_get_sync(dcss_crtc->dev->parent);
 
+	dcss_dtg_sync_set(dcss, &vm);
+	dcss_ss_sync_set(dcss, &vm, mode->flags & DRM_MODE_FLAG_PHSYNC,
+			 mode->flags & DRM_MODE_FLAG_PVSYNC);
+
 	dcss_ss_enable(dcss, true);
 	dcss_dtg_enable(dcss, true, NULL);
 	dcss_ctxld_enable(dcss);
@@ -219,7 +207,6 @@ static void dcss_crtc_atomic_disable(struct drm_crtc *crtc,
 }
 
 static const struct drm_crtc_helper_funcs dcss_helper_funcs = {
-	.mode_set_nofb = dcss_crtc_mode_set_nofb,
 	.atomic_check = dcss_crtc_atomic_check,
 	.atomic_begin = dcss_crtc_atomic_begin,
 	.atomic_flush = dcss_crtc_atomic_flush,
-- 
1.7.9.5

