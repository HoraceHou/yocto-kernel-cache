From 7d0b3f674e408b13dc72bcc3dacd9fea6b673f76 Mon Sep 17 00:00:00 2001
From: Li Jun <jun.li@nxp.com>
Date: Tue, 30 Oct 2018 09:44:47 +0800
Subject: [PATCH 4949/5242] MLK-19240 usb: chipidea: udc: keep suspended after
 charger detection

commit  b3b9a278d019211b9d4aa54b342fbcdf13ec9516 from
https://source.codeaurora.org/external/imx/linux-imx.git

If the otg port is only for charging, we don't need keep the usb
port active, so let's keep it suspended after charger detection.

Acked-by: Peter Chen <peter.chen@nxp.com>
Signed-off-by: Li Jun <jun.li@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/usb/chipidea/udc.c |   11 ++++-------
 1 file changed, 4 insertions(+), 7 deletions(-)

diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index 8363a15..b32d1b7 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -2014,11 +2014,10 @@ int ci_usb_charger_connect(struct ci_hdrc *ci, int is_active)
 {
 	int ret = 0;
 
-	if (is_active)
-		pm_runtime_get_sync(ci->dev);
-
 	if (!(ci->platdata->flags & CI_HDRC_PHY_CHARGER_DETECTION))
-		goto out;
+		return 0;
+
+	pm_runtime_get_sync(ci->dev);
 
 	if (ci->usb_phy->charger_detect) {
 		usb_phy_set_charger_state(ci->usb_phy, is_active ?
@@ -2028,10 +2027,8 @@ int ci_usb_charger_connect(struct ci_hdrc *ci, int is_active)
 				CI_HDRC_CONTROLLER_VBUS_EVENT);
 		schedule_work(&ci->usb_phy->chg_work);
 	}
-out:
 
-	if (!is_active)
-		pm_runtime_put_sync(ci->dev);
+	pm_runtime_put_sync(ci->dev);
 
 	return ret;
 }
-- 
1.7.9.5

