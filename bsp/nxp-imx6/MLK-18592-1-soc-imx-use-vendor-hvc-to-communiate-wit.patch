From 283c5d5e04cedb41d762126fd2de6d6f7a38ef56 Mon Sep 17 00:00:00 2001
From: Peng Fan <peng.fan@nxp.com>
Date: Wed, 13 Jun 2018 16:11:14 +0800
Subject: [PATCH 4022/5242] MLK-18592-1 soc: imx: use vendor hvc to communiate
 with SCU

commit  7b79b05f9ce71204027dd11e2fe927d15f117411 from
https://source.codeaurora.org/external/imx/linux-imx.git

Let Dom0 use hvc to trap to xen to communicate with SCU.
xen could reuse the MU used by Dom0 before. By reusing
the MU in Dom0, xen has power to control resources owned
by DomU.

Signed-off-by: Peng Fan <peng.fan@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/soc/imx/sc/main/ipc.c |   17 ++++++++++++++---
 include/soc/imx/fsl_hvc.h     |   15 +++++++++++++++
 2 files changed, 29 insertions(+), 3 deletions(-)
 create mode 100644 include/soc/imx/fsl_hvc.h

diff --git a/drivers/soc/imx/sc/main/ipc.c b/drivers/soc/imx/sc/main/ipc.c
index 924f7a6..cfe70ec 100644
--- a/drivers/soc/imx/sc/main/ipc.c
+++ b/drivers/soc/imx/sc/main/ipc.c
@@ -6,6 +6,7 @@
  */
 
 /* Includes */
+#include <linux/arm-smccc.h>
 #include <linux/err.h>
 #include <linux/kernel.h>
 #include <linux/of.h>
@@ -18,6 +19,7 @@
 #include <linux/mx8_mu.h>
 #include <linux/syscore_ops.h>
 
+#include <soc/imx/fsl_hvc.h>
 #include <soc/imx8/sc/svc/irq/api.h>
 #include <soc/imx8/sc/ipc.h>
 #include <soc/imx8/sc/sci.h>
@@ -54,6 +56,8 @@
 /*--------------------------------------------------------------------------*/
 void sc_call_rpc(sc_ipc_t handle, sc_rpc_msg_t *msg, bool no_resp)
 {
+	struct arm_smccc_res res;
+
 	if (in_interrupt()) {
 		pr_warn("Cannot make SC IPC calls from an interrupt context\n");
 		dump_stack();
@@ -61,9 +65,16 @@ void sc_call_rpc(sc_ipc_t handle, sc_rpc_msg_t *msg, bool no_resp)
 	}
 	mutex_lock(&scu_mu_mutex);
 
-	sc_ipc_write(handle, msg);
-	if (!no_resp)
-		sc_ipc_read(handle, msg);
+	if (xen_initial_domain()) {
+		arm_smccc_hvc(FSL_HVC_SC, (uint64_t)msg, no_resp, 0, 0, 0, 0,
+			      0, &res);
+		if (res.a0)
+			printk("Error FSL_HVC_SC %ld\n", res.a0);
+	} else {
+		sc_ipc_write(handle, msg);
+		if (!no_resp)
+			sc_ipc_read(handle, msg);
+	}
 
 	mutex_unlock(&scu_mu_mutex);
 }
diff --git a/include/soc/imx/fsl_hvc.h b/include/soc/imx/fsl_hvc.h
new file mode 100644
index 0000000..63e3cc5
--- /dev/null
+++ b/include/soc/imx/fsl_hvc.h
@@ -0,0 +1,15 @@
+/*
+ * Copyright 2018 NXP
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#ifndef __SOC_FSL_HVC_H
+#define __SOC_FSL_HVC_H
+
+/* VENDOR HVC 0xC6000000 - 0xC600FFFF */
+#define FSL_HVC_SC			0xC6000000
+
+#endif
-- 
1.7.9.5

