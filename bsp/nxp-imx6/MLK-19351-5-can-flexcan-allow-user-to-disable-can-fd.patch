From 92e9174b53f179e153548e6177f86cd650b7f0bb Mon Sep 17 00:00:00 2001
From: Dong AiSheng <aisheng.dong@nxp.com>
Date: Tue, 28 Aug 2018 15:41:51 +0800
Subject: [PATCH 4632/5242] MLK-19351-5 can: flexcan: allow user to disable
 can fd mode from device tree

commit  e3f3d39932a494fa72fcebb2cc6ee7280637dbc3 from
https://source.codeaurora.org/external/imx/linux-imx.git

Normally CAN FD capable device must work on FD mode as it has different
statically claimed bittiming capability.
This patch provides users to disable CAN FD capability if users want
to only work at normal mode.

Signed-off-by: Joakim Zhang <qiangqing.zhang@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../devicetree/bindings/net/can/fsl-flexcan.txt    |    1 +
 drivers/net/can/flexcan.c                          |    7 +++++--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/Documentation/devicetree/bindings/net/can/fsl-flexcan.txt b/Documentation/devicetree/bindings/net/can/fsl-flexcan.txt
index 33d8a2d..278644a 100644
--- a/Documentation/devicetree/bindings/net/can/fsl-flexcan.txt
+++ b/Documentation/devicetree/bindings/net/can/fsl-flexcan.txt
@@ -33,6 +33,7 @@ Optional properties:
 - trx_en_gpio : enable gpio
 - trx_stby_gpio : standby gpio
 - trx_nerr_gpio : NERR gpio
+- disable-fd-mode : disable CAN FD mode support. Valid since i.MX8 series.
 
 Example:
 
diff --git a/drivers/net/can/flexcan.c b/drivers/net/can/flexcan.c
index c320b38..d219a16 100644
--- a/drivers/net/can/flexcan.c
+++ b/drivers/net/can/flexcan.c
@@ -1653,6 +1653,7 @@ static int flexcan_probe(struct platform_device *pdev)
 {
 	const struct of_device_id *of_id;
 	const struct flexcan_devtype_data *devtype_data;
+	struct device_node *np = pdev->dev.of_node;
 	struct net_device *dev;
 	struct flexcan_priv *priv;
 	struct regulator *reg_xceiver;
@@ -1757,8 +1758,10 @@ static int flexcan_probe(struct platform_device *pdev)
 
 	if (priv->devtype_data->quirks & FLEXCAN_QUIRK_USE_OFF_TIMESTAMP) {
 		if (priv->devtype_data->quirks & FLEXCAN_QUIRK_TIMESTAMP_SUPPORT_FD) {
-			priv->can.ctrlmode_supported |= CAN_CTRLMODE_FD;
-			priv->can.bittiming_const = &flexcan_fd_bittiming_const;
+			if (!(of_find_property(np, "disable-fd-mode", NULL))) {
+				priv->can.ctrlmode_supported |= CAN_CTRLMODE_FD;
+				priv->can.bittiming_const = &flexcan_fd_bittiming_const;
+			}
 
 			priv->tx_mb_reserved_idx = FLEXCAN_TX_MB_RESERVED_OFF_TIMESTAMP_FD;
 			priv->tx_mb_idx = FLEXCAN_TX_MB_OFF_TIMESTAMP_FD;
-- 
1.7.9.5

