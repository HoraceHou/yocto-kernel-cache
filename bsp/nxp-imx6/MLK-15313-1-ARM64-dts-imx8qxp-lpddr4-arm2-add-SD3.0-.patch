From 1a8e6cfdea2ece85609d9815ffe6693a489acf7a Mon Sep 17 00:00:00 2001
From: Haibo Chen <haibo.chen@nxp.com>
Date: Fri, 30 Jun 2017 14:24:40 +0800
Subject: [PATCH 2041/5242] MLK-15313-1 ARM64: dts: imx8qxp-lpddr4-arm2: add
 SD3.0 support

commit  eaed7d30d9b9468ae8237e9753112f7ceff39282 from
https://source.codeaurora.org/external/imx/linux-imx.git

Add SD3.0 support for USDHC2.

Signed-off-by: Haibo Chen <haibo.chen@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../boot/dts/freescale/fsl-imx8qxp-lpddr4-arm2.dts |   38 ++++++++++++++++----
 arch/arm64/boot/dts/freescale/fsl-imx8qxp.dtsi     |    2 ++
 2 files changed, 34 insertions(+), 6 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qxp-lpddr4-arm2.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qxp-lpddr4-arm2.dts
index 7c374f3..9303238 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qxp-lpddr4-arm2.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qxp-lpddr4-arm2.dts
@@ -34,7 +34,7 @@
 		#address-cells = <1>;
 		#size-cells = <0>;
 
-		reg_sd1_vmmc: sd1_vmmc {
+		reg_usdhc2_vmmc: usdhc2_vmmc {
 			compatible = "regulator-fixed";
 			regulator-name = "SD1_SPWR";
 			regulator-min-microvolt = <3000000>;
@@ -271,9 +271,11 @@
 			>;
 		};
 
-		pinctrl_usdhc2_rst: usdhc2_rst_grp {
+		pinctrl_usdhc2_gpio: usdhc2gpiogrp {
 			fsl,pins = <
 				SC_P_USDHC1_RESET_B_LSIO_GPIO4_IO19	0x06000048
+				SC_P_USDHC1_WP_LSIO_GPIO4_IO21		0x06000021
+				SC_P_USDHC1_CD_B_LSIO_GPIO4_IO22	0x06000021
 			>;
 		};
 
@@ -286,8 +288,30 @@
 				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x06000021
 				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x06000021
 				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x06000021
-				SC_P_USDHC1_WP_LSIO_GPIO4_IO21		0x06000021
-				SC_P_USDHC1_CD_B_LSIO_GPIO4_IO22	0x06000021
+			>;
+		};
+
+		pinctrl_usdhc2_100mhz: usdhc2grp100mhz {
+			fsl,pins = <
+				SC_P_USDHC1_CLK_CONN_USDHC1_CLK		0x06000045
+				SC_P_USDHC1_CMD_CONN_USDHC1_CMD		0x06000025
+				SC_P_USDHC1_DATA0_CONN_USDHC1_DATA0	0x06000025
+				SC_P_USDHC1_DATA1_CONN_USDHC1_DATA1	0x06000025
+				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x06000025
+				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x06000025
+				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x06000021
+			>;
+		};
+
+		pinctrl_usdhc2_200mhz: usdhc2grp200mhz {
+			fsl,pins = <
+				SC_P_USDHC1_CLK_CONN_USDHC1_CLK		0x06000047
+				SC_P_USDHC1_CMD_CONN_USDHC1_CMD		0x06000027
+				SC_P_USDHC1_DATA0_CONN_USDHC1_DATA0	0x06000027
+				SC_P_USDHC1_DATA1_CONN_USDHC1_DATA1	0x06000027
+				SC_P_USDHC1_DATA2_CONN_USDHC1_DATA2	0x06000027
+				SC_P_USDHC1_DATA3_CONN_USDHC1_DATA3	0x06000027
+				SC_P_USDHC1_VSELECT_CONN_USDHC1_VSELECT	0x06000021
 			>;
 		};
 
@@ -414,11 +438,13 @@
 
 &usdhc2 {
 	pinctrl-names = "default", "state_100mhz", "state_200mhz";
-	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_rst>;
+	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_gpio>;
+	pinctrl-1 = <&pinctrl_usdhc2_100mhz>, <&pinctrl_usdhc2_gpio>;
+	pinctrl-2 = <&pinctrl_usdhc2_200mhz>, <&pinctrl_usdhc2_gpio>;
 	bus-width = <4>;
 	cd-gpios = <&gpio4 22 GPIO_ACTIVE_LOW>;
 	wp-gpios = <&gpio4 21 GPIO_ACTIVE_HIGH>;
-	vmmc-supply = <&reg_sd1_vmmc>;
+	vmmc-supply = <&reg_usdhc2_vmmc>;
 	status = "okay";
 };
 
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qxp.dtsi b/arch/arm64/boot/dts/freescale/fsl-imx8qxp.dtsi
index 6d459cd..13cb35d4 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qxp.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qxp.dtsi
@@ -1423,6 +1423,8 @@
 		clock-names = "ipg", "per", "ahb";
 		assigned-clock-rates = <400000000>, <200000000>, <0>;
 		power-domains = <&pd_conn_sdch1>;
+		fsl,tuning-start-tap = <20>;
+		fsl,tuning-step= <2>;
 		status = "disabled";
 	};
 
-- 
1.7.9.5

