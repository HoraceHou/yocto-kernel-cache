From 5df0c929ae1aa6a50c733aa73ec2c0274e8bf458 Mon Sep 17 00:00:00 2001
From: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Date: Thu, 22 Feb 2018 10:42:59 +0200
Subject: [PATCH 3413/5242] MLK-17634-17: drm: imx: dcss: make P010 tiled
 formats work

commit  2f26e8f35c91d5dfbb681d1af54383496532f7f4 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: Laurentiu Palcu <laurentiu.palcu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/gpu/drm/imx/dcss/dcss-plane.c |    4 ++--
 drivers/gpu/imx/dcss/dcss-dtrc.c      |    9 ++++-----
 include/video/imx-dcss.h              |    5 ++---
 3 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/drivers/gpu/drm/imx/dcss/dcss-plane.c b/drivers/gpu/drm/imx/dcss/dcss-plane.c
index a50ad4e..7c928fe 100644
--- a/drivers/gpu/drm/imx/dcss/dcss-plane.c
+++ b/drivers/gpu/drm/imx/dcss/dcss-plane.c
@@ -307,7 +307,7 @@ static void dcss_plane_atomic_set_base(struct dcss_plane *dcss_plane)
 		}
 
 		dcss_dtrc_set_format_mod(dcss_plane->dcss, dcss_plane->ch_num,
-					 pix_format, fb->modifier);
+					 fb->modifier);
 		dcss_dtrc_addr_set(dcss_plane->dcss, dcss_plane->ch_num,
 				   p1_ba, p2_ba, dcss_plane->dtrc_table_ofs_val);
 		break;
@@ -412,7 +412,7 @@ static void dcss_plane_atomic_update(struct drm_plane *plane,
 
 	if (plane->type == DRM_PLANE_TYPE_OVERLAY)
 		dcss_dtrc_set_res(dcss_plane->dcss, dcss_plane->ch_num,
-				  &src, &old_src);
+				  &src, &old_src, pixel_format);
 
 	/* DTRC has probably aligned the sizes. */
 	adj_w = src.x2 - src.x1;
diff --git a/drivers/gpu/imx/dcss/dcss-dtrc.c b/drivers/gpu/imx/dcss/dcss-dtrc.c
index e862308..02e218c 100644
--- a/drivers/gpu/imx/dcss/dcss-dtrc.c
+++ b/drivers/gpu/imx/dcss/dcss-dtrc.c
@@ -297,7 +297,6 @@ void dcss_dtrc_addr_set(struct dcss_soc *dcss, int ch_num, u32 p1_ba, u32 p2_ba,
 
 	ch = &dtrc->ch[ch_num];
 
-
 	dcss_dtrc_write(dtrc, ch_num, p1_ba, DCSS_DTRC_DYDSADDR);
 	dcss_dtrc_write(dtrc, ch_num, p2_ba, DCSS_DTRC_DCDSADDR);
 
@@ -321,7 +320,7 @@ void dcss_dtrc_addr_set(struct dcss_soc *dcss, int ch_num, u32 p1_ba, u32 p2_ba,
 EXPORT_SYMBOL(dcss_dtrc_addr_set);
 
 void dcss_dtrc_set_res(struct dcss_soc *dcss, int ch_num, struct drm_rect *src,
-		       struct drm_rect *old_src)
+		       struct drm_rect *old_src, u32 pixel_format)
 {
 	struct dcss_dtrc_priv *dtrc = dcss->dtrc_priv;
 	struct dcss_dtrc_ch *ch;
@@ -341,6 +340,8 @@ void dcss_dtrc_set_res(struct dcss_soc *dcss, int ch_num, struct drm_rect *src,
 
 	bank = dcss_readl(ch->base_reg + DCSS_DTRC_DTCTRL) >> 31;
 
+	ch->pix_format = pixel_format;
+
 	pix_depth = ch->pix_format == DRM_FORMAT_P010 ? 10 : 8;
 	old_xres = old_src->x2 - old_src->x1;
 	old_yres = old_src->y2 - old_src->y1;
@@ -505,8 +506,7 @@ bool dcss_dtrc_is_running(struct dcss_soc *dcss, int ch_num)
 	return ch->running;
 }
 
-void dcss_dtrc_set_format_mod(struct dcss_soc *dcss, int ch_num,
-			      u32 pix_format, u64 modifier)
+void dcss_dtrc_set_format_mod(struct dcss_soc *dcss, int ch_num, u64 modifier)
 {
 	struct dcss_dtrc_priv *dtrc = dcss->dtrc_priv;
 	struct dcss_dtrc_ch *ch;
@@ -518,7 +518,6 @@ void dcss_dtrc_set_format_mod(struct dcss_soc *dcss, int ch_num,
 
 	ch = &dtrc->ch[ch_num];
 
-	ch->pix_format = pix_format;
 	ch->format_modifier = modifier;
 }
 EXPORT_SYMBOL(dcss_dtrc_set_format_mod);
diff --git a/include/video/imx-dcss.h b/include/video/imx-dcss.h
index 29cd3e1..253dff8 100644
--- a/include/video/imx-dcss.h
+++ b/include/video/imx-dcss.h
@@ -128,12 +128,11 @@ void dcss_hdr10_setup(struct dcss_soc *dcss, int ch_num,
 /* DTRC */
 void dcss_dtrc_bypass(struct dcss_soc *dcss, int ch_num);
 void dcss_dtrc_set_res(struct dcss_soc *dcss, int ch_num, struct drm_rect *src,
-		       struct drm_rect *old_src);
+		       struct drm_rect *old_src, u32 pixel_format);
 void dcss_dtrc_addr_set(struct dcss_soc *dcss, int ch_num, u32 p1_ba, u32 p2_ba,
 			uint64_t dec_table_ofs);
 void dcss_dtrc_enable(struct dcss_soc *dcss, int ch_num, bool enable);
-void dcss_dtrc_set_format_mod(struct dcss_soc *dcss, int ch_num,
-			      u32 pix_format, u64 modifier);
+void dcss_dtrc_set_format_mod(struct dcss_soc *dcss, int ch_num, u64 modifier);
 
 enum dcss_color_space {
 	DCSS_COLORSPACE_RGB,
-- 
1.7.9.5

