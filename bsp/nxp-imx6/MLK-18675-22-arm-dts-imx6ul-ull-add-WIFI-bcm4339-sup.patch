From 751e08e35dbf72279ecbed272ab464c284699f48 Mon Sep 17 00:00:00 2001
From: Andy Duan <fugang.duan@nxp.com>
Date: Fri, 1 Jun 2018 18:29:55 +0800
Subject: [PATCH 4047/5242] MLK-18675-22 arm: dts: imx6ul/ull: add WIFI
 bcm4339 support with fmac driver

commit  1cd4e1449acdc782d446fe1a5e994c32fccb7b2a from
https://source.codeaurora.org/external/imx/linux-imx.git

Add WIFI bcm4339 support with fmac driver.

Signed-off-by: Fugang Duan <fugang.duan@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/boot/dts/imx6ul-evk-btwifi-oob.dtsi |   14 +++++------
 arch/arm/boot/dts/imx6ul-evk-btwifi.dtsi     |   33 ++++++++++++--------------
 2 files changed, 22 insertions(+), 25 deletions(-)

diff --git a/arch/arm/boot/dts/imx6ul-evk-btwifi-oob.dtsi b/arch/arm/boot/dts/imx6ul-evk-btwifi-oob.dtsi
index cd7a5e6..36c013b 100644
--- a/arch/arm/boot/dts/imx6ul-evk-btwifi-oob.dtsi
+++ b/arch/arm/boot/dts/imx6ul-evk-btwifi-oob.dtsi
@@ -6,12 +6,6 @@
  * published by the Free Software Foundation.
  */
 
-&bcmdhd_wlan_0 {
-	/* Need to define WL_HOST_WAKE for OOB IRQ: ENET2_RX_ER (gpio2_15) */
-	/* Hardware modification is needed on imx6ul evk for using OOB. */
-	gpios = <&gpio2 15 0>;  /* WL_HOST_WAKE */
-};
-
 &pinctrl_wifi {
 	fsl,pins = <
 		/* MUXing for WL_HOST_WAKE */
@@ -26,5 +20,11 @@
  * Refer to Murata Hardware Reference Manual for more details.
  */
 &fec2 {
-	status="disabled";
+	status = "disabled";
+};
+
+&brcmf {
+	interrupt-parent = <&gpio2>;
+	interrupts = <15 IRQ_TYPE_LEVEL_HIGH>;
+	interrupt-names = "host-wake";
 };
diff --git a/arch/arm/boot/dts/imx6ul-evk-btwifi.dtsi b/arch/arm/boot/dts/imx6ul-evk-btwifi.dtsi
index d4810bd..a2958fb 100644
--- a/arch/arm/boot/dts/imx6ul-evk-btwifi.dtsi
+++ b/arch/arm/boot/dts/imx6ul-evk-btwifi.dtsi
@@ -20,21 +20,11 @@
 		#reset-cells = <0>;
 	};
 
-	regulators {
-		wlreg_on: fixedregulator@100 {
-			compatible = "regulator-fixed";
-			regulator-min-microvolt = <5000000>;
-			regulator-max-microvolt = <5000000>;
-			regulator-name = "wlreg_on";
-			gpio = <&gpio5 1 0>;
-			startup-delay-us = <100>;
-			enable-active-high;
-		};
-	};
-
-	bcmdhd_wlan_0: bcmdhd_wlan@0 {
-		compatible = "android,bcmdhd_wlan";
-		wlreg_on-supply = <&wlreg_on>;
+	usdhc1_pwrseq: usdhc1_pwrseq {
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_wifi>;
+		compatible = "mmc-pwrseq-simple";
+		reset-gpios = <&gpio5 1 GPIO_ACTIVE_LOW>;
 	};
 };
 
@@ -55,13 +45,20 @@
 };
 
 &usdhc1 {
+	#address-cells = <1>;
+	#size-cells = <0>;
 	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_usdhc1 &pinctrl_wifi>;
+	pinctrl-0 = <&pinctrl_usdhc1>;
 	no-1-8-v;
 	non-removable;
-	cd-post;
 	pm-ignore-notify;
-	wifi-host; /* add hook for SD card detect mechanism for BCMDHD driver */
+	mmc-pwrseq = <&usdhc1_pwrseq>;
+	cap-power-off-card;
+
+	brcmf: bcrmf@1 {
+		reg = <1>;
+		compatible = "brcm,bcm4329-fmac";
+	};
 };
 
 &gpio_spi {
-- 
1.7.9.5

