From e0cf11da916a926a3fb8265dd87ec9ff35234cc4 Mon Sep 17 00:00:00 2001
From: Franck LENORMAND <franck.lenormand@nxp.com>
Date: Tue, 26 Jun 2018 13:10:55 +0200
Subject: [PATCH 4207/5242] MLK-18082: crypto: caam: Check ret value of
 dma_set_mask_and_coherent

commit  278d4b127292943eaeb49f23d8a99598ea8954bd from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: Franck LENORMAND <franck.lenormand@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/crypto/caam/ctrl.c |   27 ++++++++++++++++++++++-----
 1 file changed, 22 insertions(+), 5 deletions(-)

diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index 4ae20aa..5a2add7 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -569,16 +569,28 @@ static int probe_w_seco(struct caam_drv_private *ctrlpriv)
 	 */
 
 	/* Set DMA masks according to platform ranging */
-	if (sizeof(dma_addr_t) == sizeof(u64))
+	if (of_machine_is_compatible("fsl,imx8mm") ||
+		of_machine_is_compatible("fsl,imx8qm") ||
+		of_machine_is_compatible("fsl,imx8qxp") ||
+		of_machine_is_compatible("fsl,imx8mq")) {
+		ret = dma_set_mask_and_coherent(ctrlpriv->dev,
+			DMA_BIT_MASK(32));
+	} else if (sizeof(dma_addr_t) == sizeof(u64))
 		if (of_device_is_compatible(ctrlpriv->pdev->dev.of_node,
 					    "fsl,sec-v5.0"))
-			dma_set_mask_and_coherent(ctrlpriv->dev,
+			ret = dma_set_mask_and_coherent(ctrlpriv->dev,
 						  DMA_BIT_MASK(40));
 		else
-			dma_set_mask_and_coherent(ctrlpriv->dev,
+			ret = dma_set_mask_and_coherent(ctrlpriv->dev,
 						  DMA_BIT_MASK(36));
 	else
-		dma_set_mask_and_coherent(ctrlpriv->dev, DMA_BIT_MASK(32));
+		ret = dma_set_mask_and_coherent(ctrlpriv->dev, DMA_BIT_MASK(32));
+
+	if (ret) {
+		dev_err(ctrlpriv->dev, "dma_set_mask_and_coherent failed (%d)\n",
+			ret);
+		return ret;
+	}
 
 	/*
 	 * this is where we should run the descriptor for DRNG init
@@ -725,7 +737,12 @@ static int caam_probe(struct platform_device *pdev)
 
 	check_virt(ctrlpriv, comp_params);
 
-	if (sizeof(dma_addr_t) == sizeof(u64)) {
+	if (of_machine_is_compatible("fsl,imx8mm") ||
+		of_machine_is_compatible("fsl,imx8qm") ||
+		of_machine_is_compatible("fsl,imx8qxp") ||
+		of_machine_is_compatible("fsl,imx8mq")) {
+		ret = dma_set_mask_and_coherent(dev, DMA_BIT_MASK(32));
+	} else if (sizeof(dma_addr_t) == sizeof(u64))
 		if (caam_dpaa2)
 			ret = dma_set_mask_and_coherent(dev, DMA_BIT_MASK(49));
 		else if (of_device_is_compatible(nprop, "fsl,sec-v5.0"))
-- 
1.7.9.5

