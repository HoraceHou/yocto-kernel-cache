From 1870ea4005e9965b062c74764f05657f68243311 Mon Sep 17 00:00:00 2001
From: Peng Fan <peng.fan@nxp.com>
Date: Sat, 29 Sep 2018 13:54:42 +0800
Subject: [PATCH 4787/5242] MLK-19773 ARM64: dts support camera in DomU

commit  4364267ceb98a47c20937ec2cd317f27029216c2 from
https://source.codeaurora.org/external/imx/linux-imx.git

Use ISI0-3 in DomU, use ISI4-7 in Dom0.

 BuildInfo:
  - SCFW a958746e, SECO-FW 31fabbff, IMX-MKIMAGE f244aefa, ATF 1590be0
  - U-Boot 2018.03-00707-g884cada50b

Use `mx8_v4l2_cap_drm.out -cam 0xf` to test camera in Dom0 and DomU
after `systemctl stop weston`.

One remaing issue is that ISI_CH0 is the parent power domain,
if dom0 runtime power down this domain, DomU will camera will
panic.

Since there is an i2c controller passthrough, the orignal backend
pvi2c adapter idx will be changed to 0, so reflect that change
in domu.dts.

Signed-off-by: Peng Fan <peng.fan@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../boot/dts/freescale/fsl-imx8qm-mek-dom0.dts     |  109 +++++++++++++++++++-
 .../boot/dts/freescale/fsl-imx8qm-mek-domu.dts     |   90 ++++++++++++++--
 arch/arm64/boot/dts/freescale/fsl-imx8qm-xen.dtsi  |   24 +++++
 3 files changed, 214 insertions(+), 9 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
index e7d88a3..acc421c 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
@@ -133,7 +133,19 @@
 				SC_R_CAAM_JR2_OUT
 				SC_R_CAAM_JR3
 				SC_R_CAAM_JR3_OUT
-				>;
+				/* Camera */
+				SC_R_ISI_CH0
+				SC_R_ISI_CH1
+				SC_R_ISI_CH2
+				SC_R_ISI_CH3
+				SC_R_MIPI_0
+				SC_R_MIPI_0_PWM_0
+				SC_R_MIPI_0_I2C_0
+				SC_R_MIPI_0_I2C_1
+				SC_R_CSI_0
+				SC_R_CSI_0_PWM_0
+				SC_R_CSI_0_I2C_0
+			>;
 			pads = <
 				/* i2c1_lvds1 */
 				SC_P_LVDS1_I2C1_SCL
@@ -166,7 +178,11 @@
 				SC_P_LVDS1_I2C0_SDA
 				SC_P_USDHC2_RESET_B
 				>;
-			gpios = <&gpio1 13 GPIO_ACTIVE_LOW>, <&gpio4 9 GPIO_ACTIVE_LOW>, <&gpio4 29 GPIO_ACTIVE_LOW>, <&gpio4 27 GPIO_ACTIVE_LOW>;
+			gpios = <&gpio1 13 GPIO_ACTIVE_LOW>,
+				<&gpio1 27 GPIO_ACTIVE_LOW>,
+				<&gpio4 9 GPIO_ACTIVE_LOW>,
+				<&gpio4 27 GPIO_ACTIVE_LOW>,
+				<&gpio4 29 GPIO_ACTIVE_LOW>;
 		};
 	};
 
@@ -323,7 +339,7 @@
 	mmu-masters = <&dpu2 0x13>, <&gpu_3d1 0x15>,
 		      <&usdhc1 0x12>, <&usbotg1 0x11>,
 		      <&edma01 0x10>, <&cm41 0x09>, <&pciea 0x08>,
-		      <&vpu_decoder 0x7>, <&crypto 0x6>;
+		      <&vpu_decoder 0x7>, <&crypto 0x6>, <&isi_0 0x5>;
 };
 
 &lvds_region2 {
@@ -583,3 +599,90 @@
 		xen,passthrough;
 	};
 };
+
+/* Camera */
+&img_pdma_0_lpcg {
+	xen,passthrough;
+};
+
+&img_pdma_1_lpcg {
+	xen,passthrough;
+};
+
+&img_pdma_2_lpcg {
+	xen,passthrough;
+};
+
+&img_pdma_3_lpcg {
+	xen,passthrough;
+};
+
+&mipi_csi_0_lpcg {
+	xen,passthrough;
+};
+
+&img_pxl_link_csi0_lpcg {
+	xen,passthrough;
+};
+
+&gpio0_mipi_csi0 {
+	xen,passthrough;
+};
+
+&irqsteer_csi0 {
+	xen,passthrough;
+};
+
+&isi_0 {
+	xen,passthrough;
+	#stream-id-cells = <1>;
+	iommus = <&smmu>;
+	fsl,sc_rsrc_id = <SC_R_ISI_CH0>,
+			 <SC_R_ISI_CH1>,
+			 <SC_R_ISI_CH2>,
+			 <SC_R_ISI_CH3>;
+};
+
+&isi_1 {
+	xen,passthrough;
+};
+
+&isi_2 {
+	xen,passthrough;
+};
+
+&isi_3 {
+	xen,passthrough;
+};
+
+&mipi_csi_0 {
+	xen,passthrough;
+};
+
+&i2c0_mipi_csi0 {
+	xen,passthrough;
+};
+
+&isi_4 {
+	status = "okay";
+};
+
+&isi_5 {
+	status = "okay";
+};
+
+&isi_6 {
+	status = "okay";
+};
+
+&isi_7 {
+	status = "okay";
+};
+
+&mipi_csi_1 {
+	status = "okay";
+};
+
+&i2c0_mipi_csi1 {
+	status = "okay";
+};
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
index 1069161..6a242fe 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
@@ -37,6 +37,11 @@
 		dpu1 = &dpu2;
 		ldb1 = &ldb2;
 		serial1 = &lpuart1;
+		isi0 = &isi_0;
+		isi1 = &isi_1;
+		isi2 = &isi_2;
+		isi3 = &isi_3;
+		csi0 = &mipi_csi_0;
 	};
 
 	cpus {
@@ -286,7 +291,7 @@
 			status = "okay";
 		};
 
-		xen_i2c1: xen_i2c@1 {
+		xen_i2c0: xen_i2c@0 {
 			compatible = "xen,i2c";
 			be-adapter = "5a800000.i2c";
 			status = "okay";
@@ -474,7 +479,7 @@
 /delete-node/ &ldb1_phy;
 /delete-node/ &ldb1;
 /delete-node/ &lvds1_pwm;
-/delete-node/ &camera;
+/*/delete-node/ &camera;*/
 /delete-node/ &adc0;
 /delete-node/ &adc1;
 /delete-node/ &i2c0;
@@ -504,8 +509,8 @@
 
 /delete-node/ &irqsteer_lvds0;
 /delete-node/ &i2c1_lvds0;
-/delete-node/ &irqsteer_csi0;
-/delete-node/ &i2c0_mipi_csi0;
+/*/delete-node/ &irqsteer_csi0;*/
+/*/delete-node/ &i2c0_mipi_csi0;*/
 /delete-node/ &irqsteer_csi1;
 /delete-node/ &i2c0_mipi_csi1;
 /delete-node/ &lpspi0;
@@ -560,7 +565,7 @@
 	status = "disabled";
 };
 
-/delete-node/ &gpio0_mipi_csi0;
+/*/delete-node/ &gpio0_mipi_csi0;*/
 /delete-node/ &gpio0_mipi_csi1;
 /delete-node/ &gpt0;
 /delete-node/ &pwm0;
@@ -826,7 +831,7 @@
 	status = "okay";
 };
 
-&xen_i2c1 {
+&xen_i2c0 {
 	#address-cells = <1>;
 	#size-cells = <0>;
 	clock-frequency = <100000>;
@@ -850,3 +855,76 @@
 		interrupt-open-drain;
 	};
 };
+
+/* Camera */
+/delete-node/ &isi_4;
+/delete-node/ &isi_5;
+/delete-node/ &isi_6;
+/delete-node/ &isi_7;
+/delete-node/ &mipi_csi_1;
+
+&gpio0_mipi_csi0 {
+	status = "okay";
+};
+
+&irqsteer_csi0 {
+	status = "okay";
+};
+
+&isi_0 {
+	status = "okay";
+};
+
+&isi_1 {
+	status = "okay";
+};
+
+&isi_2 {
+	status = "okay";
+};
+
+&isi_3 {
+	status = "okay";
+};
+
+&mipi_csi_0 {
+	#address-cells = <1>;
+	#size-cells = <0>;
+	virtual-channel;
+	status = "okay";
+
+	/* Camera 0  MIPI CSI-2 (CSIS0) */
+	port@0 {
+		reg = <0>;
+		mipi_csi0_ep: endpoint {
+			remote-endpoint = <&max9286_0_ep>;
+			data-lanes = <1 2 3 4>;
+		};
+	};
+};
+
+&i2c0_mipi_csi0 {
+	#address-cells = <1>;
+	#size-cells = <0>;
+	pinctrl-names = "default";
+	clock-frequency = <100000>;
+	status = "okay";
+
+
+	max9286_mipi@6A	 {
+		compatible = "maxim,max9286_mipi";
+		reg = <0x6A>;
+		clocks = <&clk IMX8QM_CLK_DUMMY>;
+		clock-names = "capture_mclk";
+		mclk = <27000000>;
+		mclk_source = <0>;
+		pwn-gpios = <&gpio1 27 GPIO_ACTIVE_HIGH>;
+		virtual-channel;
+		port {
+			max9286_0_ep: endpoint {
+			remote-endpoint = <&mipi_csi0_ep>;
+			data-lanes = <1 2 3 4>;
+			};
+		};
+	};
+};
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-xen.dtsi b/arch/arm64/boot/dts/freescale/fsl-imx8qm-xen.dtsi
index 6840c24..addc4ef 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-xen.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-xen.dtsi
@@ -160,6 +160,30 @@
 	hsio_pcie_x2_crr2_lpcg: hsio_phy_x2_lpcg@5f0c0000 {
 		reg = <0x0 0x5f0c0000 0x0 0x10000>;
 	};
+
+	mipi_csi_0_lpcg: mipi_csi_0_lpcg@58223000 {
+		reg = <0x0 0x58223000 0x0 0x1000>;
+	};
+
+	img_pxl_link_csi0_lpcg: img_pxl_link_csi0_lpcg@58580000 {
+		reg = <0x0 0x58580000 0x0 0x1000>;
+	};
+
+	img_pdma_0_lpcg: img_pdma_0_lpcg@58500000 {
+		reg = <0x0 0x58500000 0x0 0x1000>;
+	};
+
+	img_pdma_1_lpcg: img_pdma_1_lpcg@58510000 {
+		reg = <0x0 0x58510000 0x0 0x1000>;
+	};
+
+	img_pdma_2_lpcg: img_pdma_2_lpcg@58520000 {
+		reg = <0x0 0x58520000 0x0 0x1000>;
+	};
+
+	img_pdma_3_lpcg: img_pdma_3_lpcg@58530000 {
+		reg = <0x0 0x58530000 0x0 0x1000>;
+	};
 };
 
 /delete-node/ &edma0;
-- 
1.7.9.5

