From 01c3d973ffed1fb55b7b9622f7b8567e7eb10535 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 16 Mar 2016 14:59:20 +0800
Subject: [PATCH] driver: pci: pci-imx6: reset pcie core when link up fail

If there is no PCIE card inserted into PCIE interface, link up will fail.
In this case, original code will disable clock and regulator of pcie
controller and return -EINVAL from imx6_pcie_start_link() function,
and also cause probe exit exceptionally. Now, if you run kexec, the
second kernel will hang up because enters wrong case and access
pcie controller register without enabling pcie controller clock and
regulator.
So, call imx6_pcie_assert_core_reset() function to reset pcie core
when link up fail, so that the second kernel enters correct case when
initializing pcie controller.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
[Quanyang: some modification at context]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/pci/dwc/pci-imx6.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/pci/dwc/pci-imx6.c b/drivers/pci/dwc/pci-imx6.c
index 0b38da4..42ee93b 100644
--- a/drivers/pci/dwc/pci-imx6.c
+++ b/drivers/pci/dwc/pci-imx6.c
@@ -820,6 +820,7 @@ static int imx6_pcie_establish_link(struct imx6_pcie *imx6_pcie)
 	imx6_pcie_reset_phy(imx6_pcie);
 
 	if (!IS_ENABLED(CONFIG_PCI_IMX6_COMPLIANCE_TEST)) {
+		imx6_pcie_assert_core_reset(imx6_pcie);
 		clk_disable_unprepare(imx6_pcie->pcie);
 		if (!imx6_pcie->ext_osc)
 			clk_disable_unprepare(imx6_pcie->pcie_bus);
-- 
1.7.9.5

