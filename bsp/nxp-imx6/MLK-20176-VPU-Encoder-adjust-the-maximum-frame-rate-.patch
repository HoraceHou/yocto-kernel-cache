From a6c043ee381866d38983c49b3503e2c4433b8150 Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Fri, 2 Nov 2018 15:04:03 +0800
Subject: [PATCH 4989/5242] MLK-20176:VPU Encoder:adjust the maximum frame
 rate limit to 120

commit  83696fa3b753dd3474cfdb351666986b7648a8de from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c     |   60 +++++++----------------
 drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h |    3 ++
 2 files changed, 20 insertions(+), 43 deletions(-)

diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index 3cc9bc0..cdbcb76 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -236,39 +236,6 @@ static void write_enc_reg(struct vpu_dev *dev, u32 val, off_t reg)
 	},
 };
 
-static struct v4l2_fract vpu_fps_list[] = {
-	{1, 30},
-	{1, 29},
-	{1, 28},
-	{1, 27},
-	{1, 26},
-	{1, 25},
-	{1, 24},
-	{1, 23},
-	{1, 22},
-	{1, 21},
-	{1, 20},
-	{1, 19},
-	{1, 18},
-	{1, 17},
-	{1, 16},
-	{1, 15},
-	{1, 14},
-	{1, 13},
-	{1, 12},
-	{1, 11},
-	{1, 10},
-	{1, 9},
-	{1, 8},
-	{1, 7},
-	{1, 6},
-	{1, 5},
-	{1, 4},
-	{1, 3},
-	{1, 2},
-	{1, 1},
-};
-
 static void vpu_ctx_send_cmd(struct vpu_ctx *ctx, uint32_t cmdid,
 				uint32_t cmdnum, uint32_t *local_cmddata);
 
@@ -396,15 +363,21 @@ static int v4l2_ioctl_enum_framesizes(struct file *file, void *fh,
 static int v4l2_ioctl_enum_frameintervals(struct file *file, void *fh,
 						struct v4l2_frmivalenum *fival)
 {
+	u32 framerate;
+
 	if (!fival)
 		return -EINVAL;
 
-	if (fival->index >= ARRAY_SIZE(vpu_fps_list))
+	if (fival->index < 0)
+		return -EINVAL;
+	framerate = VPU_ENC_FRAMERATE_MIN +
+			fival->index * VPU_ENC_FRAMERATE_STEP;
+	if (framerate > VPU_ENC_FRAMERATE_MAX)
 		return -EINVAL;
 
 	fival->type = V4L2_FRMIVAL_TYPE_DISCRETE;
-	fival->discrete.numerator = vpu_fps_list[fival->index].numerator;
-	fival->discrete.denominator = vpu_fps_list[fival->index].denominator;
+	fival->discrete.numerator = 1;
+	fival->discrete.denominator = framerate;
 
 	return 0;
 }
@@ -699,26 +672,27 @@ static int v4l2_ioctl_g_parm(struct file *file, void *fh,
 
 static int find_proper_framerate(struct v4l2_fract *fival)
 {
-	int i;
 	u32 min_delta = INT_MAX;
 	struct v4l2_fract target_fival = {0, 0};
+	u32 framerate = VPU_ENC_FRAMERATE_MIN;
 
 	if (!fival)
 		return -EINVAL;
 
-	for (i = 0; i < ARRAY_SIZE(vpu_fps_list); i++) {
-		struct v4l2_fract *f = &vpu_fps_list[i];
+	while (framerate <= VPU_ENC_FRAMERATE_MAX) {
 		u32 delta;
 
-		delta = abs(fival->numerator * f->denominator -
-				fival->denominator * f->numerator);
+		delta = abs(fival->numerator * framerate -
+				fival->denominator);
 		if (!delta)
 			return 0;
 		if (delta < min_delta) {
-			target_fival.numerator = f->numerator;
-			target_fival.denominator = f->denominator;
+			target_fival.numerator = 1;
+			target_fival.denominator = framerate;
 			min_delta = delta;
 		}
+
+		framerate += VPU_ENC_FRAMERATE_STEP;
 	}
 	if (!target_fival.numerator || !target_fival.denominator)
 		return -EINVAL;
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h b/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h
index bf97595..5504a12 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h
@@ -14,6 +14,9 @@
 #define VPU_ENC_HEIGHT_MIN		48
 #define VPU_ENC_WIDTH_STEP		16
 #define VPU_ENC_HEIGHT_STEP		2
+#define VPU_ENC_FRAMERATE_MAX		120
+#define VPU_ENC_FRAMERATE_MIN		1
+#define VPU_ENC_FRAMERATE_STEP		1
 
 #define VPU_ENC_WIDTH_DEFAULT		1920
 #define VPU_ENC_HEIGHT_DEFAULT		1080
-- 
1.7.9.5

