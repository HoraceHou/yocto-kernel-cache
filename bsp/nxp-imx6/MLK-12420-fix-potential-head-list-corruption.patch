From 3fba20871870ce33c557049d6201e8d40638ab51 Mon Sep 17 00:00:00 2001
From: Fancy Fang <chen.fang@nxp.com>
Date: Tue, 22 Mar 2016 10:52:27 +0800
Subject: [PATCH 0984/5242] MLK-12420 fix potential head list corruption.

commit  937972ac4a4c66904e496e4605838743724d6085 from
https://source.codeaurora.org/external/imx/linux-imx.git

The head list may be corrupted when two requests from
the same 'pxp_chan' are issued sequentially. So change
the issue_pending function to strictly serialized the
requests to avoid this kind of issue.

Signed-off-by: Fancy Fang <chen.fang@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/dma/pxp/pxp_dma_v3.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/dma/pxp/pxp_dma_v3.c b/drivers/dma/pxp/pxp_dma_v3.c
index f440450..4857c20 100644
--- a/drivers/dma/pxp/pxp_dma_v3.c
+++ b/drivers/dma/pxp/pxp_dma_v3.c
@@ -1809,6 +1809,8 @@ static void pxp_issue_pending(struct dma_chan *chan)
 	struct pxps *pxp = to_pxp(pxp_dma);
 	unsigned long flags0, flags;
 
+	down(&pxp->sema);
+
 	spin_lock_irqsave(&pxp->lock, flags0);
 	spin_lock_irqsave(&pxp_chan->lock, flags);
 
@@ -1825,7 +1827,6 @@ static void pxp_issue_pending(struct dma_chan *chan)
 	spin_unlock_irqrestore(&pxp->lock, flags0);
 
 	pxp_clk_enable(pxp);
-	down(&pxp->sema);
 
 	spin_lock_irqsave(&pxp->lock, flags);
 	pxp->pxp_ongoing = 1;
-- 
1.7.9.5

