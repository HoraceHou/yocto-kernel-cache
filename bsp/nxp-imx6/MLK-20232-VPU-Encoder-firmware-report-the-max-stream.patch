From f3d33d780b9e8ca00697691c8300236ec95652cc Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Mon, 5 Nov 2018 18:35:33 +0800
Subject: [PATCH 5082/5242] MLK-20232:VPU Encoder:firmware report the max
 stream number

commit  b4105a4a933fdf0f1ddb5861898318094ad57366 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/vpu-encoder-b0/mediasys_types.h |    3 +--
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c |   24 ++++++++++++++++++++----
 2 files changed, 21 insertions(+), 6 deletions(-)

diff --git a/drivers/mxc/vpu-encoder-b0/mediasys_types.h b/drivers/mxc/vpu-encoder-b0/mediasys_types.h
index c902626..62a187a 100644
--- a/drivers/mxc/vpu-encoder-b0/mediasys_types.h
+++ b/drivers/mxc/vpu-encoder-b0/mediasys_types.h
@@ -62,8 +62,7 @@
 typedef int int32;
 #define FALSE 0
 #define TRUE 1
-#define VPU_MAX_NUM_STREAMS 4
-#define VID_API_NUM_STREAMS 4
+#define VID_API_NUM_STREAMS 8
 #define VID_API_MAX_BUF_PER_STR 3
 #define VID_API_MAX_NUM_MVC_VIEWS 4
 #define MEDIAIP_MAX_NUM_MALONES 2
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index dc50975..d4d24c2 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -2375,6 +2375,25 @@ static void enable_mu(struct core_device *dev)
 	MU_sendMesgToFW(dev->mu_base_virtaddr, INIT_DONE, 2);
 }
 
+static void get_core_supported_instance_count(struct core_device *core)
+{
+	pENC_RPC_HOST_IFACE iface;
+
+	iface = core->shared_mem.pSharedInterface;
+	core->supported_instance_count =
+		min_t(u32, iface->uMaxEncoderStreams, VID_API_NUM_STREAMS);
+}
+
+static void vpu_core_start_done(struct core_device *core)
+{
+	if (!core)
+		return;
+
+	get_core_supported_instance_count(core);
+	core->firmware_started = true;
+	complete(&core->start_cmp);
+}
+
 //This code is added for MU
 static irqreturn_t fsl_vpu_mu_isr(int irq, void *This)
 {
@@ -2385,8 +2404,7 @@ static irqreturn_t fsl_vpu_mu_isr(int irq, void *This)
 	if (msg == 0xaa) {
 		enable_mu(dev);
 	} else if (msg == 0x55) {
-		dev->firmware_started = true;
-		complete(&dev->start_cmp);
+		vpu_core_start_done(dev);
 	}  else if (msg == 0xA5) {
 		/*receive snapshot done msg and wakeup complete to suspend*/
 		complete(&dev->snap_done_cmp);
@@ -3757,8 +3775,6 @@ static int init_vpu_core_dev(struct core_device *core_dev)
 	if (!core_dev)
 		return -EINVAL;
 
-	core_dev->supported_instance_count =
-		min(VPU_MAX_NUM_STREAMS, VID_API_NUM_STREAMS);
 	mutex_init(&core_dev->core_mutex);
 	mutex_init(&core_dev->cmd_mutex);
 	init_completion(&core_dev->start_cmp);
-- 
1.7.9.5

