From 547f66044311bec688897aeb40fdb99efaed30c8 Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Wed, 17 Oct 2018 09:49:59 +0800
Subject: [PATCH 4880/5242] MLK-19956:VPU Encoder:record the pid who open
 encoder

commit  e24ae6ee45ee617b658bee54bed6706ccd90d520 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c |    8 ++++++--
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h |    2 ++
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index 0d698b0..e1d3880 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -2347,8 +2347,9 @@ static ssize_t show_instance_info(struct device *dev,
 	param = ctx->enc_param;
 	fw = ctx->core_dev->m0_p_fw_space_vir;
 
-	num += snprintf(buf + num, PAGE_SIZE, "pid:%d\n", current->pid);
-	num += snprintf(buf + num, PAGE_SIZE, "fw:%d, %d\n", fw[16], fw[17]);
+	num += snprintf(buf + num, PAGE_SIZE,
+			"pid: %d; tgid: %d\n", ctx->pid, ctx->tgid);
+	num += snprintf(buf + num, PAGE_SIZE, "fw: %d, %d\n", fw[16], fw[17]);
 
 	num += snprintf(buf + num, PAGE_SIZE, "cmd:\n");
 
@@ -2516,6 +2517,9 @@ static int v4l2_open(struct file *filp)
 	create_instance_file(ctx);
 	initialize_enc_param(ctx);
 
+	ctx->pid = current->pid;
+	ctx->tgid = current->tgid;
+
 	filp->private_data = &ctx->fh;
 
 	return 0;
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
index 2565500..33fc276 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
@@ -281,6 +281,8 @@ struct vpu_ctx {
 	struct buffer_addr enc_buffer;
 	struct core_device *core_dev;
 
+	pid_t pid;
+	pid_t tgid;
 	struct vpu_statistic statistic;
 	struct device_attribute dev_attr_instance;
 	char name[64];
-- 
1.7.9.5

