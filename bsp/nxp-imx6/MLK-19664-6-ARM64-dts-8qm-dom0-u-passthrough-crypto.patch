From 75360f9aba12f56143848f07d63dafd04b54e7e6 Mon Sep 17 00:00:00 2001
From: Peng Fan <peng.fan@nxp.com>
Date: Sat, 22 Sep 2018 21:25:09 +0800
Subject: [PATCH 4721/5242] MLK-19664-6 ARM64: dts: 8qm dom0/u: passthrough
 crypto

commit  913183fda6520cceb6b43f42a5f6e813be97f59b from
https://source.codeaurora.org/external/imx/linux-imx.git

passthrough crypto to domu

Signed-off-by: Peng Fan <peng.fan@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../boot/dts/freescale/fsl-imx8qm-mek-dom0.dts     |   33 ++++++++++++++++----
 .../boot/dts/freescale/fsl-imx8qm-mek-domu.dts     |    4 +--
 2 files changed, 29 insertions(+), 8 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
index ec49455..b502a43 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-dom0.dts
@@ -128,6 +128,11 @@
 				SC_R_VPU_MU_1
 				SC_R_VPU_MU_2
 				SC_R_VPU_MU_3
+				/* crypto */
+				SC_R_CAAM_JR2
+				SC_R_CAAM_JR2_OUT
+				SC_R_CAAM_JR3
+				SC_R_CAAM_JR3_OUT
 				>;
 			pads = <
 				/* i2c1_lvds1 */
@@ -318,7 +323,7 @@
 	mmu-masters = <&dpu2 0x13>, <&gpu_3d1 0x15>,
 		      <&usdhc1 0x12>, <&usbotg1 0x11>,
 		      <&edma01 0x10>, <&cm41 0x09>, <&pciea 0x08>,
-		      <&vpu_decoder 0x7>;
+		      <&vpu_decoder 0x7>, <&crypto 0x6>;
 };
 
 &lvds_region2 {
@@ -341,11 +346,6 @@
 	xen,passthrough;
 };
 
-&crypto {
-	/* Met CAAM failure on A0, disable it first */
-	status = "disabled";
-};
-
 &dpu2_intsteer {
 	xen,passthrough;
 };
@@ -548,3 +548,24 @@
        #stream-id-cells = <1>;
        xen,passthrough;
 };
+
+&crypto {
+	xen,passthrough;
+	iommus = <&smmu>;
+	#stream-id-cells = <1>;
+	/* JR1 is not used by Linux */
+	fsl,sc_rsrc_id = <SC_R_CAAM_JR2>, <SC_R_CAAM_JR2_OUT>,
+			 <SC_R_CAAM_JR3>, <SC_R_CAAM_JR3_OUT>;
+};
+
+&sec_jr2 {
+	xen,passthrough;
+};
+
+&sec_jr3 {
+	xen,passthrough;
+};
+
+&caam_sm {
+	xen,passthrough;
+};
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
index 639da76..1a6d199 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
@@ -671,8 +671,8 @@
 	reg = <0x0 0x5d210000 0x0 0x10000>;
 };
 
-/delete-node/ &crypto;
-/delete-node/ &caam_sm;
+/*/delete-node/ &crypto;*/
+/*/delete-node/ &caam_sm;*/
 /*/delete-node/ &sc_pwrkey;*/
 /delete-node/ &wdog;
 /delete-node/ &wu;
-- 
1.7.9.5

