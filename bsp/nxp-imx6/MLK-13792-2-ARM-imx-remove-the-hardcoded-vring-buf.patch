From 90a9df223fcc68a76cd80c973926344a035bbd17 Mon Sep 17 00:00:00 2001
From: Richard Zhu <hongxing.zhu@nxp.com>
Date: Fri, 6 Jan 2017 13:54:21 +0800
Subject: [PATCH 1464/5242] MLK-13792-2 ARM: imx: remove the hardcoded vring
 buf

commit  b0a86ce554c299bdcbbc0e96082179ab98a216c4 from
https://source.codeaurora.org/external/imx/linux-imx.git

input the vring buffer by device tree node, and
remove the hard-coded vring buffer in the driver

Signed-off-by: Richard Zhu <hongxing.zhu@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/mach-imx/imx_rpmsg.c |   34 +++++++---------------------------
 1 file changed, 7 insertions(+), 27 deletions(-)

diff --git a/arch/arm/mach-imx/imx_rpmsg.c b/arch/arm/mach-imx/imx_rpmsg.c
index 5c06557..9c85afe 100644
--- a/arch/arm/mach-imx/imx_rpmsg.c
+++ b/arch/arm/mach-imx/imx_rpmsg.c
@@ -322,10 +322,7 @@ static int set_vring_phy_buf(struct platform_device *pdev,
 			}
 		}
 	} else {
-		/* back compatible for the old single rpmsg instance */
-		rpdev->ivdev[0].vring[0] = 0x9FF00000;
-		rpdev->ivdev[0].vring[1] = 0x9FF08000;
-
+		return -ENOMEM;
 	}
 
 	return ret;
@@ -335,8 +332,6 @@ static int imx_rpmsg_probe(struct platform_device *pdev)
 {
 	int i, j, ret = 0;
 	struct device_node *np = pdev->dev.of_node;
-	struct resource *res;
-	resource_size_t size;
 
 	for (i = 0; i < ARRAY_SIZE(imx_rpmsg_vprocs); i++) {
 		struct imx_rpmsg_vproc *rpdev = &imx_rpmsg_vprocs[i];
@@ -351,30 +346,15 @@ static int imx_rpmsg_probe(struct platform_device *pdev)
 		}
 
 		if (!strcmp(rpdev->rproc_name, "m4")) {
-			ret = of_device_is_compatible(np, "fsl,imx7d-rpmsg");
-			ret |= of_device_is_compatible(np, "fsl,imx6sx-rpmsg");
+			ret = set_vring_phy_buf(pdev, rpdev,
+						rpdev->vdev_nums);
 			if (ret) {
-				res = platform_get_resource(pdev,
-							    IORESOURCE_MEM, 0);
-
-				if (res) {
-					size = resource_size(res);
-					rpdev->ivdev[0].vring[0] = res->start;
-					rpdev->ivdev[0].vring[1] = res->start
-									+ size;
-				} else {
-					/* hardcodes here now. */
-					rpdev->ivdev[0].vring[0] = 0xBFFF0000;
-					rpdev->ivdev[0].vring[1] = 0xBFFF8000;
-				}
-			} else {
-				ret = set_vring_phy_buf(pdev, rpdev,
-							rpdev->vdev_nums);
-				if (ret)
-					break;
+				pr_err("No vring buffer.\n");
+				return -ENOMEM;
 			}
 		} else {
-			break;
+			pr_err("No remote m4 processor.\n");
+			return -ENODEV;
 		}
 
 		for (j = 0; j < rpdev->vdev_nums; j++) {
-- 
1.7.9.5

