From c3b462ad2d1d3846598d5a125c5dd0592c7c2900 Mon Sep 17 00:00:00 2001
From: Xiaoning Wang <xiaoning.wang@nxp.com>
Date: Fri, 14 Sep 2018 10:32:41 +0800
Subject: [PATCH 4627/5242] MLK-19452-3 ARM: dts: Add spi slave support for
 imx7ulp

commit  8afc8c4e163a8cb57c5e3dc4636deff38e3ff1e3 from
https://source.codeaurora.org/external/imx/linux-imx.git

Add "spi-slave" attribute for recognizing slave mode.
If it is not in slave mode, please delete this attribute.
Usage can be found at spi-fsl-lpspi.txt.

Modify "Makefile" to build "imx7ulp-evk-spi-slave.dtb".

Signed-off-by: Xiaoning Wang <xiaoning.wang@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../devicetree/bindings/spi/spi-fsl-lpspi.txt      |    3 +++
 arch/arm/boot/dts/Makefile                         |    1 +
 arch/arm/boot/dts/imx7ulp-evk-spi-slave.dts        |   16 ++++++++++++++++
 3 files changed, 20 insertions(+)
 create mode 100644 arch/arm/boot/dts/imx7ulp-evk-spi-slave.dts

diff --git a/Documentation/devicetree/bindings/spi/spi-fsl-lpspi.txt b/Documentation/devicetree/bindings/spi/spi-fsl-lpspi.txt
index 225ace1..9e44d85 100644
--- a/Documentation/devicetree/bindings/spi/spi-fsl-lpspi.txt
+++ b/Documentation/devicetree/bindings/spi/spi-fsl-lpspi.txt
@@ -7,6 +7,8 @@ Required properties:
 - interrupt-parent : core interrupt controller
 - interrupts : lpspi interrupt
 - clocks : lpspi clock specifier
+- spi-slave : spi slave mode support. In slave mode, add this attribute without
+	      value. In master mode, remove it.
 
 Examples:
 
@@ -16,4 +18,5 @@ lpspi2: lpspi@40290000 {
 	interrupt-parent = <&intc>;
 	interrupts = <GIC_SPI 28 IRQ_TYPE_LEVEL_HIGH>;
 	clocks = <&clks IMX7ULP_CLK_LPSPI2>;
+	spi-slave;
 };
diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
index 2f8197b..30e33f3 100644
--- a/arch/arm/boot/dts/Makefile
+++ b/arch/arm/boot/dts/Makefile
@@ -701,6 +701,7 @@ dtb-$(CONFIG_SOC_IMX7D) += \
 dtb-$(CONFIG_SOC_IMX7ULP) += \
 	imx7ulp-14x14-arm2.dtb \
 	imx7ulp-evk.dtb \
+	imx7ulp-evk-spi-slave.dtb \
 	imx7ulp-evk-emmc.dtb \
 	imx7ulp-evk-emmc-qspi.dtb \
 	imx7ulp-evk-ft5416.dtb \
diff --git a/arch/arm/boot/dts/imx7ulp-evk-spi-slave.dts b/arch/arm/boot/dts/imx7ulp-evk-spi-slave.dts
new file mode 100644
index 0000000..728f91e
--- /dev/null
+++ b/arch/arm/boot/dts/imx7ulp-evk-spi-slave.dts
@@ -0,0 +1,16 @@
+/*
+ * Copyright 2016 Freescale Semiconductor, Inc.
+ * Copyright 2017-2018 NXP.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#include "imx7ulp-evk.dts"
+
+/delete-node/&spidev0;
+
+&lpspi3 {
+	spi-slave;
+};
-- 
1.7.9.5

