From cfa6d6751fc46e79ad6a5a4cb2ea12fd2db7a079 Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Sun, 30 Sep 2018 11:01:01 +0800
Subject: [PATCH 4761/5242] MLK-19781:VPU Encoder:Implement enumeration frame
 size

commit  7b6bf567d3acdb116d48fc99459d36cacd951044 from
https://source.codeaurora.org/external/imx/linux-imx.git

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c     |   62 +++++++++++++++++++++++
 drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h |   18 +++++++
 drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c    |    2 +-
 3 files changed, 81 insertions(+), 1 deletion(-)
 create mode 100644 drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h

diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index c59a03a..892dfb3 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -48,6 +48,7 @@
 
 #include "vpu_encoder_b0.h"
 #include "vpu_encoder_ctrl.h"
+#include "vpu_encoder_config.h"
 
 unsigned int vpu_dbg_level_encoder = LVL_WARN;
 
@@ -221,6 +222,26 @@ static int v4l2_ioctl_enum_fmt_vid_out_mplane(struct file *file,
 	return 0;
 }
 
+static int v4l2_ioctl_enum_framesizes(struct file *file, void *fh,
+					struct v4l2_frmsizeenum *fsize)
+{
+	if (!fsize)
+		return -EINVAL;
+
+	if (fsize->index)
+		return -EINVAL;
+
+	fsize->type = V4L2_FRMSIZE_TYPE_STEPWISE;
+	fsize->stepwise.max_width = VPU_ENC_WIDTH_MAX;
+	fsize->stepwise.max_height = VPU_ENC_HEIGHT_MAX;
+	fsize->stepwise.min_width = VPU_ENC_WIDTH_MIN;
+	fsize->stepwise.min_height = VPU_ENC_HEIGHT_MIN;
+	fsize->stepwise.step_width = VPU_ENC_WIDTH_STEP;
+	fsize->stepwise.step_height = VPU_ENC_HEIGHT_STEP;
+
+	return 0;
+}
+
 static int v4l2_ioctl_g_fmt(struct file *file,
 		void *fh,
 		struct v4l2_format *f
@@ -299,6 +320,42 @@ static int initialize_enc_param(struct vpu_ctx *ctx)
 	return 0;
 }
 
+static int check_size(u32 width, u32 height)
+{
+	if (width < VPU_ENC_WIDTH_MIN ||
+			width > VPU_ENC_WIDTH_MAX ||
+			((width - VPU_ENC_WIDTH_MIN) % VPU_ENC_WIDTH_STEP) ||
+			height < VPU_ENC_HEIGHT_MIN ||
+			height > VPU_ENC_HEIGHT_MAX ||
+			((height - VPU_ENC_HEIGHT_MIN) % VPU_ENC_HEIGHT_STEP)) {
+		vpu_dbg(LVL_ERR, "Unsupported frame size : %dx%d\n",
+				width, height);
+		return -EINVAL;
+	}
+
+	return 0;
+}
+
+static int check_v4l2_fmt(struct v4l2_format *f)
+{
+	int ret = -EINVAL;
+
+	switch (f->type) {
+	case V4L2_BUF_TYPE_VIDEO_CAPTURE:
+	case V4L2_BUF_TYPE_VIDEO_OUTPUT:
+		ret = check_size(f->fmt.pix.width, f->fmt.pix.height);
+		break;
+	case V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE:
+	case V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE:
+		ret = check_size(f->fmt.pix_mp.width, f->fmt.pix_mp.height);
+		break;
+	default:
+		break;
+	}
+
+	return ret;
+}
+
 static struct vpu_v4l2_fmt *find_fmt_by_fourcc(struct vpu_v4l2_fmt *fmts,
 						unsigned int size,
 						u32 fourcc)
@@ -419,6 +476,10 @@ static int v4l2_ioctl_s_fmt(struct file *file,
 	pEncParam = ctx->enc_param;
 	vpu_dbg(LVL_DEBUG, "%s()\n", __func__);
 
+	ret = check_v4l2_fmt(f);
+	if (ret)
+		return ret;
+
 	switch (f->type) {
 	case V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE:
 		q_data = &ctx->q_data[V4L2_SRC];
@@ -813,6 +874,7 @@ static int v4l2_ioctl_streamoff(struct file *file,
 	.vidioc_querycap                = v4l2_ioctl_querycap,
 	.vidioc_enum_fmt_vid_cap_mplane = v4l2_ioctl_enum_fmt_vid_cap_mplane,
 	.vidioc_enum_fmt_vid_out_mplane = v4l2_ioctl_enum_fmt_vid_out_mplane,
+	.vidioc_enum_framesizes		= v4l2_ioctl_enum_framesizes,
 	.vidioc_g_fmt_vid_cap_mplane    = v4l2_ioctl_g_fmt,
 	.vidioc_g_fmt_vid_out_mplane    = v4l2_ioctl_g_fmt,
 	.vidioc_try_fmt_vid_cap_mplane  = v4l2_ioctl_try_fmt,
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h b/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h
new file mode 100644
index 0000000..1c04462
--- /dev/null
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_config.h
@@ -0,0 +1,18 @@
+/*
+ * Copyright(c) 2018 NXP. All rights reserved.
+ *
+ * vpu_encoder_config.h
+ *
+ * Author Ming Qian<ming.qian@nxp.com>
+ */
+#ifndef _VPU_ENCODER_CONFIG_H
+#define _VPU_ENCODER_CONFIG_H
+
+#define VPU_ENC_WIDTH_MAX		1920
+#define VPU_ENC_HEIGHT_MAX		1080
+#define VPU_ENC_WIDTH_MIN		64
+#define VPU_ENC_HEIGHT_MIN		48
+#define VPU_ENC_WIDTH_STEP		2
+#define VPU_ENC_HEIGHT_STEP		2
+
+#endif
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
index 8269c56..0cb4a072 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
@@ -52,7 +52,7 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#include <linux/stddef.h>
+#include <linux/kernel.h>
 #include "vpu_encoder_rpc.h"
 
 void rpc_init_shared_memory_encoder(struct shared_addr *This,
-- 
1.7.9.5

