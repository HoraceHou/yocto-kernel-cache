From 3825f2a701aabc97e6bbc21d9ea0ea5b92efa283 Mon Sep 17 00:00:00 2001
From: Zhou Peng-B04994 <eagle.zhou@nxp.com>
Date: Fri, 7 Jul 2017 18:15:25 +0800
Subject: [PATCH 2083/5242] MLK-15356-1:[i.MX8MQ/Hantro] Add support for
 android platform

commit  a1c564c0a1cafe292edbd56adc9907fa3e3542be from
https://source.codeaurora.org/external/imx/linux-imx.git

Add hantro register mmap feature

Signed-off-by: Zhou Peng-B04994 <eagle.zhou@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mxc/hantro/hantrodec.c |   24 +++++++++++++++++++++++-
 1 file changed, 23 insertions(+), 1 deletion(-)

diff --git a/drivers/mxc/hantro/hantrodec.c b/drivers/mxc/hantro/hantrodec.c
index 28a4dc4..223a00b 100755
--- a/drivers/mxc/hantro/hantrodec.c
+++ b/drivers/mxc/hantro/hantrodec.c
@@ -1233,6 +1233,27 @@ static int hantrodec_release(struct inode *inode, struct file *filp) {
   return 0;
 }
 
+/*------------------------------------------------------------------------------
+ Function name   : hantro_mmap
+ Description     : memory map interface for hantro file operation
+
+ Return type     : int
+------------------------------------------------------------------------------*/
+static int hantro_mmap(struct file *fp, struct vm_area_struct *vm)
+{
+  if (vm->vm_pgoff==(multicorebase[0] >> PAGE_SHIFT) || vm->vm_pgoff==(multicorebase[1] >> PAGE_SHIFT)){
+    vm->vm_flags |= VM_IO;
+    vm->vm_page_prot = pgprot_noncached(vm->vm_page_prot);
+    PDEBUG("hantro mmap: size=0x%lX, page off=0x%lX\n",(vm->vm_end - vm->vm_start), vm->vm_pgoff);
+    return remap_pfn_range(vm, vm->vm_start, vm->vm_pgoff, vm->vm_end - vm->vm_start,
+               vm->vm_page_prot) ? -EAGAIN : 0;
+  }
+  else{
+    PDEBUG("invalid map offset :0x%lX \n",vm->vm_pgoff);
+    return -EINVAL;
+  }
+}
+
 #ifdef CLK_CFG
 void hantrodec_disable_clk(unsigned long value)
 {
@@ -1258,7 +1279,8 @@ void hantrodec_disable_clk(unsigned long value)
   .open = hantrodec_open,
   .release = hantrodec_release,
   .unlocked_ioctl = hantrodec_ioctl,
-  .fasync = NULL
+  .fasync = NULL,
+  .mmap = hantro_mmap,
 };
 
 /*------------------------------------------------------------------------------
-- 
1.7.9.5

