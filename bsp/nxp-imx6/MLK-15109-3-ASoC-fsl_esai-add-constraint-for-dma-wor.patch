From c6fef32b640547be83f5227f3e3069fba335384c Mon Sep 17 00:00:00 2001
From: Shengjiu Wang <shengjiu.wang@freescale.com>
Date: Mon, 19 Jun 2017 11:28:42 +0800
Subject: [PATCH 1959/5242] MLK-15109-3: ASoC: fsl_esai: add constraint for
 dma workaround

commit  93ba4f024a1a6fd54b6b21ccad630cdacfd88807 from
https://source.codeaurora.org/external/imx/linux-imx.git

Use GPT dma event to instead of esai dma event can't totally
resolve/workaround the hardware issue, There is two GPT, one
GPT is to get the failing edge of dma event, then to trigger
EDMA copy data, another one is to get the raising edge, then to
clear the interrupt of both GPT, sometimes, the clear operation
may clear the failing edge event wrongly in race condition.
then the EDMA will stop.
In test result, the high sample rate and multi-channel is easy
to trigger this issue. so add constraint for them to make the
workaround stable

Signed-off-by: Shengjiu Wang <shengjiu.wang@freescale.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 sound/soc/fsl/fsl_esai.c |    7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/sound/soc/fsl/fsl_esai.c b/sound/soc/fsl/fsl_esai.c
index 6a69dd2..9133eeb 100644
--- a/sound/soc/fsl/fsl_esai.c
+++ b/sound/soc/fsl/fsl_esai.c
@@ -648,6 +648,13 @@ static int fsl_esai_startup(struct snd_pcm_substream *substream,
 				esai_priv->dma_params_rx.maxburst);
 	}
 
+	if (esai_priv->soc->dma_workaround) {
+		snd_pcm_hw_constraint_minmax(substream->runtime,
+				SNDRV_PCM_HW_PARAM_CHANNELS, 1, 2);
+		snd_pcm_hw_constraint_minmax(substream->runtime,
+				SNDRV_PCM_HW_PARAM_RATE, 48000, 48000);
+	}
+
 	return 0;
 
 err_fsysclk:
-- 
1.7.9.5

