From 52e17f9dc017c0ec644e8640e962063b6a5bdfca Mon Sep 17 00:00:00 2001
From: ming_qian <ming.qian@nxp.com>
Date: Mon, 5 Nov 2018 13:36:43 +0800
Subject: [PATCH 5023/5242] MLK-20174:VPU Encoder:add DebugBufferDesc in RPC
 interface

commit  efd53e833ef0e7e44cfb2b4f33b61356978aaed1 from
https://source.codeaurora.org/external/imx/linux-imx.git

fix some typo

Signed-off-by: ming_qian <ming.qian@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm64/boot/dts/freescale/fsl-imx8dx.dtsi      |    2 +-
 .../dts/freescale/fsl-imx8qm-mek-domu-dpu1.dts     |    2 +-
 .../boot/dts/freescale/fsl-imx8qm-mek-domu.dts     |    2 +-
 arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi      |    2 +-
 drivers/mxc/vpu-encoder-b0/mediasys_types.h        |   23 ++++++++++----------
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c        |    3 ++-
 drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h        |    4 ++--
 drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c       |   15 +++++++++++++
 drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.h       |    2 ++
 9 files changed, 37 insertions(+), 18 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8dx.dtsi b/arch/arm64/boot/dts/freescale/fsl-imx8dx.dtsi
index 14caf22..484e812 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8dx.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8dx.dtsi
@@ -3343,7 +3343,7 @@
 		compatible = "nxp,imx8qm-b0-vpuenc", "nxp,imx8qxp-b0-vpuenc";
 		boot-region = <&encoder_boot>;
 		rpc-region = <&encoder_rpc>;
-		fw-buf_size = <0x1000000>;
+		fw-buf-size = <0x1000000>;
 		rpc-buf-size = <0x500000>;
 		print-buf-size = <0x300000>;
 		reg = <0x0 0x2d000000 0x0 0x1000000>;
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu-dpu1.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu-dpu1.dts
index 96f6439..de51cad 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu-dpu1.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu-dpu1.dts
@@ -234,7 +234,7 @@
 			compatible = "nxp,imx8qm-b0-vpuenc", "nxp,imx8qxp-b0-vpuenc";
 			boot-region = <&encoder_boot>;
 			rpc-region = <&encoder_rpc>;
-			fw-buf_size = <0x1000000 0x1000000>;
+			fw-buf-size = <0x1000000 0x1000000>;
 			rpc-buf-size = <0x500000 0x500000>;
 			print-buf-size = <0x300000 0x300000>;
 			reg = <0x0 0x2d000000 0x0 0x1000000>;
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
index 14b562f..23786b2 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm-mek-domu.dts
@@ -266,7 +266,7 @@
 			compatible = "nxp,imx8qm-b0-vpuenc", "nxp,imx8qxp-b0-vpuenc";
 			boot-region = <&encoder_boot>;
 			rpc-region = <&encoder_rpc>;
-			fw-buf_size = <0x1000000 0x1000000>;
+			fw-buf-size = <0x1000000 0x1000000>;
 			rpc-buf-size = <0x500000 0x500000>;
 			print-buf-size = <0x300000 0x300000>;
 			reg = <0x0 0x2d000000 0x0 0x1000000>;
diff --git a/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi b/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
index 0ddb627..a61aecb 100644
--- a/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-imx8qm.dtsi
@@ -197,7 +197,7 @@
 		compatible = "nxp,imx8qm-b0-vpuenc", "nxp,imx8qxp-b0-vpuenc";
 		boot-region = <&encoder_boot>;
 		rpc-region = <&encoder_rpc>;
-		fw-buf_size = <0x1000000 0x1000000>;
+		fw-buf-size = <0x1000000 0x1000000>;
 		rpc-buf-size = <0x500000 0x500000>;
 		print-buf-size = <0x300000 0x300000>;
 		reg = <0x0 0x2d000000 0x0 0x1000000>;
diff --git a/drivers/mxc/vpu-encoder-b0/mediasys_types.h b/drivers/mxc/vpu-encoder-b0/mediasys_types.h
index a499c5d..81ca174 100644
--- a/drivers/mxc/vpu-encoder-b0/mediasys_types.h
+++ b/drivers/mxc/vpu-encoder-b0/mediasys_types.h
@@ -664,17 +664,18 @@
 } MEDIA_ENC_API_CONTROL_INTERFACE, *pMEDIA_ENC_API_CONTROL_INTERFACE;
 
 typedef struct {
-	u_int32                                FwExecBaseAddr;
-	u_int32                                FwExecAreaSize;
-	BUFFER_DESCRIPTOR_TYPE                 StreamCmdBufferDesc;
-	BUFFER_DESCRIPTOR_TYPE                 StreamMsgBufferDesc;
-	u_int32                                StreamCmdIntEnable[VID_API_NUM_STREAMS];
-	u_int32                                FWVersion;
-	u_int32                                uMVDFWOffset;
-	u_int32                                uMaxEncoderStreams;
-	u_int32                                pEncCtrlInterface[VID_API_NUM_STREAMS];
-	MEDIAIP_FW_SYSTEM_CONFIG               sSystemCfg;
-	u_int32                                uApiVersion;
+	u_int32					FwExecBaseAddr;
+	u_int32					FwExecAreaSize;
+	BUFFER_DESCRIPTOR_TYPE			StreamCmdBufferDesc;
+	BUFFER_DESCRIPTOR_TYPE			StreamMsgBufferDesc;
+	u_int32					StreamCmdIntEnable[VID_API_NUM_STREAMS];
+	u_int32					FWVersion;
+	u_int32					uMVDFWOffset;
+	u_int32					uMaxEncoderStreams;
+	u_int32					pEncCtrlInterface[VID_API_NUM_STREAMS];
+	MEDIAIP_FW_SYSTEM_CONFIG		sSystemCfg;
+	u_int32					uApiVersion;
+	BUFFER_DESCRIPTOR_TYPE			DebugBufferDesc;
 } ENC_RPC_HOST_IFACE, *pENC_RPC_HOST_IFACE;
 
 #define SCB_XREG_SLV_BASE                               0x00000000
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
index de60d8e..22c2f5b 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.c
@@ -2364,6 +2364,7 @@ static void enable_mu(struct core_device *dev)
 			dev->rpc_actual_size, dev->rpc_buf_size);
 
 	mu_addr = cpu_phy_to_mu(dev, dev->m0_rpc_phy + dev->rpc_buf_size);
+	rpc_set_print_buffer(&dev->shared_mem, mu_addr, dev->print_buf_size);
 	MU_sendMesgToFW(dev->mu_base_virtaddr, PRINT_BUF_OFFSET, mu_addr);
 
 	mu_addr = cpu_phy_to_mu(dev, dev->m0_rpc_phy);
@@ -3511,7 +3512,7 @@ static int parse_core_info(struct core_device *core, struct device_node *np)
 	}
 	core->reg_fw_base = val;
 
-	ret = of_property_read_u32_index(np, "fw-buf_size", core->id, &val);
+	ret = of_property_read_u32_index(np, "fw-buf-size", core->id, &val);
 	if (ret) {
 		vpu_err("find fw-buf-size for core[%d] fail\n", core->id);
 		core->fw_buf_size = M0_BOOT_SIZE_DEFAULT;
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
index 555a847..621c415 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_b0.h
@@ -51,9 +51,9 @@
 #define MMAP_BUF_TYPE_MASK 0xF0000000
 #define M0_BOOT_SIZE_DEFAULT	0x1000000
 #define M0_BOOT_SIZE_MIN	0x100000
-#define RPC_SIZE_DEFAULT	0x500000
+#define RPC_SIZE_DEFAULT	0x100000
 #define RPC_SIZE_MIN		0x100000
-#define PRINT_SIZE_DEFAULT	0x300000
+#define PRINT_SIZE_DEFAULT	0x200000
 #define PRINT_SIZE_MIN		0x200000
 #define MEM_SIZE  0x2800000
 #define YUV_SIZE  0x4000000
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
index 366e76e..c858237 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.c
@@ -395,3 +395,18 @@ pENC_DSA_STATUS_t rpc_get_dsa_status(struct shared_addr *shared_mem, int index)
 
 	return dsa_status;
 }
+
+void rpc_set_print_buffer(struct shared_addr *shared_mem,
+				unsigned long print_phy_addr, u32 size)
+{
+	pENC_RPC_HOST_IFACE pSharedInterface;
+	pBUFFER_DESCRIPTOR_TYPE debugBufDesc;
+
+
+	pSharedInterface = shared_mem->pSharedInterface;
+	debugBufDesc = &pSharedInterface->DebugBufferDesc;
+
+	debugBufDesc->start = print_phy_addr;
+	debugBufDesc->end = debugBufDesc->start + size;
+	debugBufDesc->wptr = debugBufDesc->rptr = debugBufDesc->start;
+}
diff --git a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.h b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.h
index 7078d80..b77d5b6 100644
--- a/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.h
+++ b/drivers/mxc/vpu-encoder-b0/vpu_encoder_rpc.h
@@ -125,5 +125,7 @@ pMEDIAIP_ENC_MEM_POOL rpc_get_mem_pool(
 pENC_ENCODING_STATUS rpc_get_encoding_status(
 		struct shared_addr *shared_mem, int index);
 pENC_DSA_STATUS_t rpc_get_dsa_status(struct shared_addr *shared_mem, int index);
+void rpc_set_print_buffer(struct shared_addr *shared_mem,
+				unsigned long print_phy_addr, u32 size);
 
 #endif
-- 
1.7.9.5

