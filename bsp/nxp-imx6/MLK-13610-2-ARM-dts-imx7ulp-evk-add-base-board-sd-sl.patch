From c0dbf0fc475e20bd3b636c2124a60803320ee0c0 Mon Sep 17 00:00:00 2001
From: Haibo Chen <haibo.chen@nxp.com>
Date: Thu, 15 Dec 2016 10:58:18 +0800
Subject: [PATCH 1357/5242] MLK-13610-2 ARM: dts: imx7ulp-evk: add base board
 sd slot support

commit  957da032f12efed4c92933c69b8b057e2e29baf0 from
https://source.codeaurora.org/external/imx/linux-imx.git

On imx7ulp-evk board, the SD slot on base board is conflict with BT/WiFi.
This patch seperate the usdhc1 from imx7ulp-evk.dts, and create new dts.

Signed-off-by: Haibo Chen <haibo.chen@nxp.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/boot/dts/Makefile            |    1 +
 arch/arm/boot/dts/imx7ulp-evk-sd1.dts |   32 ++++++++++++++++++++++++++++++++
 arch/arm/boot/dts/imx7ulp-evk.dts     |   24 ++++++++++++++++++++++--
 arch/arm/boot/dts/imx7ulp.dtsi        |    2 ++
 4 files changed, 57 insertions(+), 2 deletions(-)
 create mode 100644 arch/arm/boot/dts/imx7ulp-evk-sd1.dts

diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
index 0e05297..cd8d9ea 100644
--- a/arch/arm/boot/dts/Makefile
+++ b/arch/arm/boot/dts/Makefile
@@ -696,6 +696,7 @@ dtb-$(CONFIG_SOC_IMX7ULP) += \
 	imx7ulp-14x14-arm2.dtb \
 	imx7ulp-evk.dtb \
 	imx7ulp-evk-emmc.dtb \
+	imx7ulp-evk-sd1.dtb \
 	imx7ulp-evk-lpuart.dtb \
 	imx7ulp-evk-qspi.dtb \
 	imx7ulp-evk-wm8960.dtb
diff --git a/arch/arm/boot/dts/imx7ulp-evk-sd1.dts b/arch/arm/boot/dts/imx7ulp-evk-sd1.dts
new file mode 100644
index 0000000..6cdb99a
--- /dev/null
+++ b/arch/arm/boot/dts/imx7ulp-evk-sd1.dts
@@ -0,0 +1,32 @@
+/*
+ * Copyright 2016 Freescale Semiconductor, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#include "imx7ulp-evk.dts"
+
+&bcmdhd_wlan_0 {
+	status = "disabled";
+};
+
+&lpuart6 {
+	status = "disabled";
+};
+
+&usdhc1 {
+	pinctrl-names = "default", "state_100mhz", "state_200mhz", "sleep";
+	pinctrl-0 = <&pinctrl_usdhc1 &pinctrl_usdhc1_rst>;
+	pinctrl-1 = <&pinctrl_usdhc1 &pinctrl_usdhc1_rst>;
+	pinctrl-2 = <&pinctrl_usdhc1 &pinctrl_usdhc1_rst>;
+	pinctrl-3 = <&pinctrl_usdhc1 &pinctrl_usdhc1_rst>;
+	cd-gpios = <&gpio2 13 GPIO_ACTIVE_LOW>;
+	wp-gpios = <&gpio2 12 GPIO_ACTIVE_HIGH>;
+	vmmc-supply = <&reg_vsd_3v3b>;
+	/delete-property/non-removable;
+	/delete-property/cd-post;
+	/delete-property/wifi-host;
+	status = "okay";
+};
diff --git a/arch/arm/boot/dts/imx7ulp-evk.dts b/arch/arm/boot/dts/imx7ulp-evk.dts
index fa74188..5505046 100644
--- a/arch/arm/boot/dts/imx7ulp-evk.dts
+++ b/arch/arm/boot/dts/imx7ulp-evk.dts
@@ -67,6 +67,16 @@
 			gpio = <&gpio1 0 GPIO_ACTIVE_HIGH>;
 			enable-active-high;
 		};
+
+		reg_vsd_3v3b: regulator@2 {
+			compatible = "regulator-fixed";
+			reg = <2>;
+			regulator-name = "VSD_3V3B";
+			regulator-min-microvolt = <3300000>;
+			regulator-max-microvolt = <3300000>;
+			gpio = <&gpio2 11 GPIO_ACTIVE_HIGH>;
+			enable-active-high;
+		};
 	};
 
 	extcon_usb1: extcon_usb1 {
@@ -140,9 +150,12 @@
 	imx7ulp-evk {
 		pinctrl_hog_1: hoggrp-1 {
 			fsl,pins = <
-				IMX7ULP_PAD_PTC10__PTC10		0x30100		/* USDHC0 CD */
+				IMX7ULP_PAD_PTC10__PTC10	0x30100		/* USDHC0 CD */
 				IMX7ULP_PAD_PTC1__PTC1		0x20100
 				IMX7ULP_PAD_PTD0__PTD0		0x30100		/* USDHC0 RST */
+				IMX7ULP_PAD_PTE13__PTE13	0x30103		/* USDHC1 CD */
+				IMX7ULP_PAD_PTE12__PTE12	0x30103		/* USDHC1 WP */
+				IMX7ULP_PAD_PTE14__SDHC1_VS	0x843		/* USDHC1 VSEL */
 			>;
 		};
 
@@ -244,6 +257,12 @@
 			>;
 		};
 
+		pinctrl_usdhc1_rst: usdhc1grp_rst {
+			fsl,pins = <
+				IMX7ULP_PAD_PTE11__PTE11	0x30100	/* USDHC1 RST */
+			>;
+		};
+
 		pinctrl_wifi: wifigrp {
 			fsl,pins = <
 				IMX7ULP_PAD_PTE6__PTE6		0x43 /* WL_REG_ON */
@@ -370,8 +389,9 @@
 };
 
 &usdhc1 {
-	pinctrl-names = "default";
+	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&pinctrl_usdhc1 &pinctrl_wifi>;
+	pinctrl-1 = <&pinctrl_usdhc1 &pinctrl_wifi>;
 	non-removable;
 	keep-power-in-suspend;
 	cd-post;
diff --git a/arch/arm/boot/dts/imx7ulp.dtsi b/arch/arm/boot/dts/imx7ulp.dtsi
index 9330ba2..30c6971 100644
--- a/arch/arm/boot/dts/imx7ulp.dtsi
+++ b/arch/arm/boot/dts/imx7ulp.dtsi
@@ -321,6 +321,8 @@
 				 <&clks IMX7ULP_CLK_USDHC1>;
 			clock-names ="ipg", "ahb", "per";
 			bus-width = <4>;
+			fsl,tuning-start-tap = <20>;
+			fsl,tuning-step= <2>;
 			status = "disabled";
 		};
 
-- 
1.7.9.5

