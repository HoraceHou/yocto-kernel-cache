From 71da4f7faa351b0612b0c236d9064e655dda1766 Mon Sep 17 00:00:00 2001
From: Aaron Williams <aaron.williams@cavium.com>
Date: Thu, 13 Sep 2018 19:39:47 -0700
Subject: [PATCH 0198/1051] octeontx: mmc: fix setting clock for non-zero bus
 IDs

There is an issue in all Octeon and OcteonTX devices where the clock
settings in the MIO_EMM_SWITCH register only take effect if the BUS_ID
field is zero.

For any device other than device zero this means that the register must
be written twice, first with BUS_ID set to zero and again with the proper
BUS_ID in order for the CLK_LO and CLK_HI fields to take effect.

Signed-off-by: Aaron Williams <aaron.williams@marvell.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/mmc/host/cavium.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/mmc/host/cavium.c b/drivers/mmc/host/cavium.c
index dba6d901c176..9baa4208dead 100644
--- a/drivers/mmc/host/cavium.c
+++ b/drivers/mmc/host/cavium.c
@@ -289,6 +289,11 @@ static void cvm_mmc_switch_to(struct cvm_mmc_slot *slot)
 
 	writeq(slot->cached_rca, host->base + MIO_EMM_RCA(host));
 	emm_switch = slot->cached_switch;
+	/* Due to errata 29956 the clock is not set properly when the
+	 * bus_id is non-zero.
+	 */
+	set_bus_id(&emm_switch, 0);
+	do_switch(host, emm_switch & GENMASK_ULL(0, 31));
 	set_bus_id(&emm_switch, slot->bus_id);
 	do_switch(host, emm_switch);
 	host->powered = true;
-- 
2.17.1

