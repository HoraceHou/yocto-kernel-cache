From 1e05f39cf44e0491b082e51298156b2c17ba841f Mon Sep 17 00:00:00 2001
From: Yelena Krivosheev <yelena@marvell.com>
Date: Wed, 3 Oct 2018 13:23:47 +0300
Subject: [PATCH 0714/1051] mvneta: support 1G to 2.5G port speed change

Change-Id: I0dcbd2837bc15db8e9ce485a4052e876a9c5aa7f
Signed-off-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/60230
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Igal Liberman <igall@marvell.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/marvell/mvneta.c | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index c337f6ced397..ddc934dc65bd 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -3451,7 +3451,9 @@ static int mvneta_mac_link_state(struct net_device *ndev,
 
 	gmac_stat = mvreg_read(pp, MVNETA_GMAC_STATUS);
 
-	if (gmac_stat & MVNETA_GMAC_SPEED_1000)
+	if (pp->phy_interface == PHY_INTERFACE_MODE_2500BASEX)
+		state->speed = SPEED_2500;
+	else if (gmac_stat & MVNETA_GMAC_SPEED_1000)
 		state->speed = SPEED_1000;
 	else if (gmac_stat & MVNETA_GMAC_SPEED_100)
 		state->speed = SPEED_100;
@@ -3984,6 +3986,19 @@ mvneta_ethtool_set_link_ksettings(struct net_device *ndev,
 {
 	struct mvneta_port *pp = netdev_priv(ndev);
 
+	if (!pp->phylink)
+		return -1;
+
+	phylink_stop(pp->phylink);
+
+	if (cmd->base.speed == 1000)
+		pp->phy_interface = PHY_INTERFACE_MODE_SGMII;
+
+	if (cmd->base.speed == 2500)
+		pp->phy_interface = PHY_INTERFACE_MODE_2500BASEX;
+
+	phylink_start(pp->phylink);
+
 	return phylink_ethtool_ksettings_set(pp->phylink, cmd);
 }
 
-- 
2.17.1

