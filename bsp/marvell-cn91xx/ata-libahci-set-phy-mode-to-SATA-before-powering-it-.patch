From ad3886b158b29c03fa354e0c219bb9c9805a2ea0 Mon Sep 17 00:00:00 2001
From: Grzegorz Jaszczyk <jaz@semihalf.com>
Date: Thu, 19 Apr 2018 14:28:31 +0200
Subject: [PATCH 0594/1051] ata: libahci: set phy mode to SATA before powering
 it on

Some phy drivers like "marvell,comphy-cp110" are able to configure phy to
various mode, not only particular one. In such case it is required to set
appropriate mode before powering the phy.

For other phys which are only dedicated for SATA the set_mode handler is
not used therefore this patch shouldn't change anything.

Change-Id: Id2244f3903c138313b42e469e3cbdb1f6819f1da
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/ata/libahci_platform.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/ata/libahci_platform.c b/drivers/ata/libahci_platform.c
index 30cc8f1a31e1..72951e3b2c5e 100644
--- a/drivers/ata/libahci_platform.c
+++ b/drivers/ata/libahci_platform.c
@@ -55,6 +55,12 @@ static int ahci_platform_enable_phys(struct ahci_host_priv *hpriv)
 		if (rc)
 			goto disable_phys;
 
+		rc = phy_set_mode(hpriv->phys[i], PHY_MODE_SATA);
+		if (rc) {
+			phy_exit(hpriv->phys[i]);
+			goto disable_phys;
+		}
+
 		rc = phy_power_on(hpriv->phys[i]);
 		if (rc) {
 			phy_exit(hpriv->phys[i]);
-- 
2.17.1

