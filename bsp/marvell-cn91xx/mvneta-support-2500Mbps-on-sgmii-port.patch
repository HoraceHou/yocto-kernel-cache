From e918e9bb91a180c9403e626cd9898f5d28585e1e Mon Sep 17 00:00:00 2001
From: Yelena Krivosheev <yelena@marvell.com>
Date: Sun, 16 Sep 2018 12:33:22 +0300
Subject: [PATCH 0713/1051] mvneta: support 2500Mbps on sgmii port

Change-Id: I67e6175514181e9d9bbf495cda07bd372249fdab
Signed-off-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/60229
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Igal Liberman <igall@marvell.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/marvell/mvneta.c        | 7 +++++--
 drivers/phy/marvell/phy-mvebu-cp110-comphy.c | 1 +
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index 83da2fa052fa..c337f6ced397 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -3169,7 +3169,8 @@ static int mvneta_setup_txqs(struct mvneta_port *pp)
  *
  * The COMPHY configures the serdes lanes regardless of the actual use of the
  * lanes by the physical layer. This is why configurations like
- * "mvneta (1000BaseX) - COMPHY (SGMII)" are valid.
+ * "mvneta (1000BaseX) - COMPHY (SGMII)" or
+ * "mvneta (2500BaseX) - COMPHY (2500SGMII)" are valid.
  */
 static int mvneta_comphy_init(struct mvneta_port *pp)
 {
@@ -3523,6 +3524,7 @@ static void mvneta_mac_config(struct net_device *ndev, unsigned int mode,
 
 	if (state->interface == PHY_INTERFACE_MODE_QSGMII ||
 	    state->interface == PHY_INTERFACE_MODE_SGMII ||
+	    state->interface == PHY_INTERFACE_MODE_2500BASEX ||
 	    phy_interface_mode_is_8023z(state->interface))
 		new_ctrl2 |= MVNETA_GMAC2_PCS_ENABLE;
 
@@ -4500,7 +4502,8 @@ static int mvneta_port_power_up(struct mvneta_port *pp, int phy_mode)
 	if (phy_mode == PHY_INTERFACE_MODE_QSGMII)
 		mvreg_write(pp, MVNETA_SERDES_CFG, MVNETA_QSGMII_SERDES_PROTO);
 	else if (phy_mode == PHY_INTERFACE_MODE_SGMII ||
-		 phy_mode == PHY_INTERFACE_MODE_1000BASEX)
+		 phy_mode == PHY_INTERFACE_MODE_1000BASEX ||
+		 phy_mode == PHY_INTERFACE_MODE_2500BASEX)
 		mvreg_write(pp, MVNETA_SERDES_CFG, MVNETA_SGMII_SERDES_PROTO);
 	else if (!phy_interface_mode_is_rgmii(phy_mode))
 		return -EINVAL;
diff --git a/drivers/phy/marvell/phy-mvebu-cp110-comphy.c b/drivers/phy/marvell/phy-mvebu-cp110-comphy.c
index d7e2802e72f0..6f25ba6e64f0 100644
--- a/drivers/phy/marvell/phy-mvebu-cp110-comphy.c
+++ b/drivers/phy/marvell/phy-mvebu-cp110-comphy.c
@@ -90,6 +90,7 @@ static unsigned long a3700_comphy_smc(unsigned long function_id,
 static const struct mvebu_comhy_conf mvebu_comphy_a3700_modes[] = {
 	/* lane 0 */
 	MVEBU_COMPHY_CONF(0, 1, PHY_MODE_SGMII),
+	MVEBU_COMPHY_CONF(0, 1, PHY_MODE_2500SGMII),
 	MVEBU_COMPHY_CONF(0, 0, PHY_MODE_USB_HOST),
 	MVEBU_COMPHY_CONF(0, 0, PHY_MODE_USB_DEVICE),
 	/* lane 1 */
-- 
2.17.1

