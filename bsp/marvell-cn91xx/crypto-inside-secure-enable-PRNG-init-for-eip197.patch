From a7ee2bcfe74978d350818f9a249e40ab78bf329c Mon Sep 17 00:00:00 2001
From: Ofer Heifetz <oferh@marvell.com>
Date: Tue, 29 May 2018 16:49:11 +0300
Subject: [PATCH 0642/1051] crypto: inside-secure - enable PRNG init for eip197

Change-Id: If1278383cd819b328ff294e4f1ed6e3cc700b3e9
Signed-off-by: Ofer Heifetz <oferh@marvell.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/crypto/inside-secure/safexcel.c | 41 +++++++++++++++++++++++++
 drivers/crypto/inside-secure/safexcel.h | 22 +++++++++++++
 2 files changed, 63 insertions(+)

diff --git a/drivers/crypto/inside-secure/safexcel.c b/drivers/crypto/inside-secure/safexcel.c
index b20237a2cb81..33d268dd98f2 100644
--- a/drivers/crypto/inside-secure/safexcel.c
+++ b/drivers/crypto/inside-secure/safexcel.c
@@ -29,6 +29,43 @@ static int eip_in_use = -1;
 /* Module param to save the assigned rings to the Kernel */
 static uint rings[MAX_EIP_DEVICE] = {RINGS_UNINITIALIZED, RINGS_UNINITIALIZED};
 
+/* Initialize pseudo random generator */
+static void eip197_prng_init(struct safexcel_crypto_priv *priv, int pe)
+{
+	u64 seed;
+
+	get_random_bytes(&seed, sizeof(seed));
+
+	/* disable PRNG and set to manual mode */
+	writel(0, EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_CTRL(pe));
+
+	/* Write seed data */
+	writel(lower_32_bits(seed),
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_SEED_L(pe));
+	writel(upper_32_bits(seed),
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_SEED_H(pe));
+
+	/* Write key data */
+	writel(EIP197_PE_EIP96_PRNG_KEY_0_L_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_KEY_0_L(pe));
+	writel(EIP197_PE_EIP96_PRNG_KEY_0_H_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_KEY_0_H(pe));
+	writel(EIP197_PE_EIP96_PRNG_KEY_1_L_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_KEY_1_L(pe));
+	writel(EIP197_PE_EIP96_PRNG_KEY_1_H_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_KEY_1_H(pe));
+
+	/* Write LFSR data */
+	writel(EIP197_PE_EIP96_PRNG_LFSR_L_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_LFSR_L(pe));
+	writel(EIP197_PE_EIP96_PRNG_LFSR_H_VAL,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_LFSR_H(pe));
+
+	/* enable PRNG and set to auto mode */
+	writel(EIP197_PE_EIP96_PRNG_EN | EIP197_PE_EIP96_PRNG_AUTO,
+	       EIP197_PE(priv) + EIP197_PE_EIP96_PRNG_CTRL(pe));
+}
+
 static void eip197_trc_cache_init(struct safexcel_crypto_priv *priv)
 {
 	u32 val, htable_offset;
@@ -496,6 +533,10 @@ static int safexcel_hw_init(struct safexcel_crypto_priv *priv)
 	writel(GENMASK(30, 20), EIP197_HIA_AIC_G(priv) + EIP197_HIA_AIC_G_ACK);
 
 	if (priv->version == EIP197B || priv->version == EIP197D) {
+		/* init PRNG */
+		for (pe = 0; pe < priv->config.pes; pe++)
+			eip197_prng_init(priv, pe);
+
 		eip197_trc_cache_init(priv);
 
 		ret = eip197_load_firmwares(priv);
diff --git a/drivers/crypto/inside-secure/safexcel.h b/drivers/crypto/inside-secure/safexcel.h
index 7fa0d9f9a251..bcbc1c4d81a9 100644
--- a/drivers/crypto/inside-secure/safexcel.h
+++ b/drivers/crypto/inside-secure/safexcel.h
@@ -148,6 +148,28 @@
 #define EIP197_TRC_ECCDATA			0xf0840
 #define EIP197_CS_RAM_CTRL			0xf7ff0
 
+/* EIP-96 PRNG */
+/* Registers   */
+#define EIP197_PE_EIP96_PRNG_CTRL(n)			(0x01044 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_SEED_L(n)			(0x01048 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_SEED_H(n)			(0x0104c + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_KEY_0_L(n)			(0x01050 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_KEY_0_H(n)			(0x01054 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_KEY_1_L(n)			(0x01058 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_KEY_1_H(n)			(0x0105c + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_LFSR_L(n)			(0x01070 + (0x2000 * n))
+#define EIP197_PE_EIP96_PRNG_LFSR_H(n)			(0x01074 + (0x2000 * n))
+/* Register bits */
+#define EIP197_PE_EIP96_PRNG_EN				BIT(0)
+#define EIP197_PE_EIP96_PRNG_AUTO			BIT(1)
+/* Default values */
+#define EIP197_PE_EIP96_PRNG_KEY_0_L_VAL		0xaee75681
+#define EIP197_PE_EIP96_PRNG_KEY_0_H_VAL		0x0f27c239
+#define EIP197_PE_EIP96_PRNG_KEY_1_L_VAL		0x79947198
+#define EIP197_PE_EIP96_PRNG_KEY_1_H_VAL		0xe2991275
+#define EIP197_PE_EIP96_PRNG_LFSR_L_VAL			0x21ac3c7c
+#define EIP197_PE_EIP96_PRNG_LFSR_H_VAL			0xd008c4b4
+
 /* EIP197_HIA_xDR_DESC_SIZE */
 #define EIP197_xDR_DESC_MODE_64BIT		BIT(31)
 
-- 
2.17.1

