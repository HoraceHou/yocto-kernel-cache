From fb4d6f34606119b25a49cb5c4a19ea089998b7c4 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Mon, 4 Jun 2018 17:48:09 -0700
Subject: [PATCH 0347/1051] (SDK only) spidev: expand device list, add generic
 "linux,spidev"

This should go in Cavium SDK, but not to kernel.org.

Changing the kernel to add compatible devices seems wrong,
but that's what the spidev code implies - logging a warning
if compatible="spidev" is listed in device-tree.

Two SPI-driven telephony devices (SLIC and framer) are added to
compatible-id list in the spirit of kernel.org's 956b200a.

In practice many distributions have found this to be unworkable,
and added a "linux,spidev" generic id, so that's added too,
to avoid having to rework generic thunder kernel when a new SPI
device is added, which can be managed from usermode by spidev.

One of these changes should go upstream, but perhaps not both,
so that devtree-described SPI targets can be accessed from
usermode via kernel spidev driver

Signed-off-by: Peter Swain <pswain@cavium.com>
Signed-off-by: Yury Norov <ynorov@caviumnetworks.com>
[Kevin: The original patch got from Marvell sdk10.0_19.06]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../devicetree/bindings/spi/spidev.txt        | 41 +++++++++++++++++++
 drivers/spi/spidev.c                          | 13 ++++++
 2 files changed, 54 insertions(+)
 create mode 100644 Documentation/devicetree/bindings/spi/spidev.txt

diff --git a/Documentation/devicetree/bindings/spi/spidev.txt b/Documentation/devicetree/bindings/spi/spidev.txt
new file mode 100644
index 000000000000..83ea37958d14
--- /dev/null
+++ b/Documentation/devicetree/bindings/spi/spidev.txt
@@ -0,0 +1,41 @@
+spidev: generic usermode SPI driver
+
+The devicetree binding for devices interfaced through spidev
+is controversial, and this documents a compromise for extensible
+embedded systems, which is at variance with the kernel.org policy
+
+By the policy discussed in kernel.org's commit 956b200a,
+each new device type handled via the spidev device should be added
+to spidev.c's signature list, because device tree entries should refer
+to the actual hardware, not just an access method.
+
+Changing the kernel to add compatible devices seems wrong,
+but that's what the spidev code implied - logging a warning
+if compatible="spidev" is listed in device-tree.
+
+Two SPI-driven telephony devices (SLIC and framer) are added to
+compatible-id list in the spirit of kernel.org's 956b200a.
+
+In practice many distributions have found this to be unworkable,
+and added a "linux,spidev" generic id, so that's added too,
+to avoid having to rework generic thunder kernel when a new SPI
+device is added, which can be managed from usermode by spidev.
+
+One of these changes should go upstream, but perhaps not both,
+so that devtree-described SPI targets can be accessed from
+usermode via kernel spidev driver.
+
+Perhaps the best solution is to mark device tree entries with both
+the "linux,spidev" string, to allow binding to kernels without
+knowledge of target device, and also with a target device string
+to help usercode find the device type it's looking for.
+
+Original list
+        { .compatible = "rohm,dh2228fv" },
+        { .compatible = "lineartechnology,ltc2488" },
+added
+        { .compatible = "silabs,si32260" },
+        { .compatible = "maxim,ds26521" },
+compromise for extendability
+        { .compatible = "linux,spidev" },
+
diff --git a/drivers/spi/spidev.c b/drivers/spi/spidev.c
index cda10719d1d1..8324f1810ad5 100644
--- a/drivers/spi/spidev.c
+++ b/drivers/spi/spidev.c
@@ -669,6 +669,19 @@ static const struct of_device_id spidev_dt_ids[] = {
 	{ .compatible = "lineartechnology,ltc2488" },
 	{ .compatible = "ge,achc" },
 	{ .compatible = "semtech,sx1301" },
+	/*
+	 * Compromise with commit 956b200a
+	 *  spi: spidev: Warn loudly if instantiated from DT as "spidev"
+	 * Either push these two upstream, and do the same on all new IDs.
+	 */
+	{ .compatible = "silabs,si32260" },
+	{ .compatible = "maxim,ds26521" },
+	/*
+	 * Or push this "linux,spidev" upstream, and amend the warning to
+	 * complain if no OTHER compat string is supplied to help steer
+	 * device recognition ...
+	 */
+	{ .compatible = "linux,spidev" },
 	{},
 };
 MODULE_DEVICE_TABLE(of, spidev_dt_ids);
-- 
2.17.1

