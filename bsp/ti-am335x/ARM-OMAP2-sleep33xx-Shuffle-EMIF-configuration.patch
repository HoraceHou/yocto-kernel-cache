From feb27b403c67850ea7d60f826f330390c38188a4 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Tue, 25 Jul 2017 12:44:23 -0500
Subject: [PATCH 044/205] ARM: OMAP2+: sleep33xx: Shuffle EMIF configuration

This commit comes from:
  git://git.ti.com/processor-sdk/processor-sdk-linux.git

Currently we are saving the context of the EMIF before programming the
EMIF to enter self-refresh mode. In order to ensure that we can properly
resume, make sure that we program the EMIF to enter self-refresh before
we save the context of the EMIF so that the actual state of the EMIF is
what gets restored on resume. This allows us to properly clear the
self-refresh state if the EMIF is set for that after restoring the
context and guaranteeing proper exit of low power states.

Otherwise the EMIF will always be programmed on resume as not being in
self-refresh and it is critical that the EMIF is brought back up
configured for self-refresh and then transitioned into normal operation,
otherwise self-refresh exit may fail and hang the board because the
contents of memory is lost.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/sleep33xx.S |   21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/arch/arm/mach-omap2/sleep33xx.S b/arch/arm/mach-omap2/sleep33xx.S
index fbcd25d..854363b 100644
--- a/arch/arm/mach-omap2/sleep33xx.S
+++ b/arch/arm/mach-omap2/sleep33xx.S
@@ -74,6 +74,16 @@ ENTRY(am33xx_do_wfi)
 	ldr	r4, [r2, #AMX3_PM_WFI_FLAGS_OFFSET]
 
 cache_skip_flush:
+	/* Check if we want self refresh, if so enter SR */
+	tst     r4, #WFI_FLAG_SELF_REFRESH
+	beq     emif_skip_enter_sr
+
+	adr	r9, am33xx_emif_sram_table
+
+	ldr	r3, [r9, #EMIF_PM_ENTER_SR_OFFSET]
+	blx	r3
+
+emif_skip_enter_sr:
 	/* Only necessary if PER is losing context */
 	tst	r4, #WFI_FLAG_SAVE_EMIF
 	beq	emif_skip_save
@@ -84,14 +94,9 @@ cache_skip_flush:
 	blx	r3
 
 emif_skip_save:
-	/* Check if we want self refresh, if so enter SR and disable EMIF */
+	/* Only can disable EMIF if we have entered self refresh */
 	tst     r4, #WFI_FLAG_SELF_REFRESH
-	beq     emif_skip_enter_sr
-
-	adr	r9, am33xx_emif_sram_table
-
-	ldr	r3, [r9, #EMIF_PM_ENTER_SR_OFFSET]
-	blx	r3
+	beq     emif_skip_disable
 
 	/* Disable EMIF */
 	ldr     r1, virt_emif_clkctrl
@@ -106,7 +111,7 @@ wait_emif_disable:
 	cmp	r2, r3
 	bne	wait_emif_disable
 
-emif_skip_enter_sr:
+emif_skip_disable:
 	tst	r4, #WFI_FLAG_WAKE_M3
 	beq	wkup_m3_skip
 
-- 
1.7.9.5

