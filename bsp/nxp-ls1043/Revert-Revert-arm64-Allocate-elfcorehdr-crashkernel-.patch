From afc07a4614cce9ad25df20b39367792c656f0ae1 Mon Sep 17 00:00:00 2001
From: Xulin Sun <xulin.sun@windriver.com>
Date: Tue, 2 Apr 2019 15:07:54 +0800
Subject: [PATCH 3/4] Revert "Revert "arm64: Allocate elfcorehdr & crashkernel
 mem before any reservation""

This reverts commit 2d39a9d746d036ff997c9a7523a2ababface0634.
NXP LS1043A needs to allocate crashkernel memory before reserve the mem.

Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm64/mm/init.c |   12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/mm/init.c b/arch/arm64/mm/init.c
index 787e279..f589f4a 100644
--- a/arch/arm64/mm/init.c
+++ b/arch/arm64/mm/init.c
@@ -460,6 +460,14 @@ void __init arm64_memblock_init(void)
 	 * Register the kernel text, kernel data, initrd, and initial
 	 * pagetables with memblock.
 	 */
+
+	/* make this the first reservation so that there are no chances of
+	 * overlap
+	 */
+	reserve_elfcorehdr();
+
+	reserve_crashkernel();
+
 	memblock_reserve(__pa_symbol(_text), _end - _text);
 #ifdef CONFIG_BLK_DEV_INITRD
 	if (initrd_start) {
@@ -479,10 +487,6 @@ void __init arm64_memblock_init(void)
 	else
 		arm64_dma_phys_limit = PHYS_MASK + 1;
 
-	reserve_crashkernel();
-
-	reserve_elfcorehdr();
-
 	high_memory = __va(memblock_end_of_DRAM() - 1) + 1;
 
 	dma_contiguous_reserve(arm64_dma_phys_limit);
-- 
1.7.9.5

