From 1200e9b9c5e1d2faffdc67dd428e4a8d180d7f78 Mon Sep 17 00:00:00 2001
From: Alex Marginean <alexandru.marginean@nxp.com>
Date: Mon, 23 Sep 2019 14:23:35 +0300
Subject: [PATCH 216/245] felix: skip probing if device is disabled in DT

commit 4634b3e134ba8984cf81f0bbdeaa0b60848503e8 from
http://source.codeaurora.org/external/qoriq/qoriq-components/linux.git

For some of the SoC configurations the switch HW is disabled but the PCI
function is still presented on the bus.  To avoid boot time errors the
function must be disabled and the patch adds support for that.

Signed-off-by: Alex Marginean <alexandru.marginean@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/net/ethernet/mscc/felix_board.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/net/ethernet/mscc/felix_board.c b/drivers/net/ethernet/mscc/felix_board.c
index 27a3c170a102..04e3025c437f 100644
--- a/drivers/net/ethernet/mscc/felix_board.c
+++ b/drivers/net/ethernet/mscc/felix_board.c
@@ -733,6 +733,11 @@ static int felix_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	size_t len;
 	int i, err;
 
+	if (pdev->dev.of_node && !of_device_is_available(pdev->dev.of_node)) {
+		dev_info(&pdev->dev, "device is disabled, skipping\n");
+		return -ENODEV;
+	}
+
 	err = pci_enable_device(pdev);
 	if (err) {
 		dev_err(&pdev->dev, "device enable failed\n");
-- 
2.17.1

