From 2e7bff2a60398183fabe0d256ab942f1ffc43ef4 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Tue, 19 Nov 2019 14:19:30 +0800
Subject: [PATCH 14/40] Revert "can: xilinx: Enable clocks even when CONFIG_PM
 is disabled"

This reverts commit 2d8159b7aa9223cb63432e45632acd12bc582526.
---
 drivers/net/can/xilinx_can.c | 31 ++++++++-----------------------
 1 file changed, 8 insertions(+), 23 deletions(-)

diff --git a/drivers/net/can/xilinx_can.c b/drivers/net/can/xilinx_can.c
index 7ea9bc6e476c..33ab09f37f76 100644
--- a/drivers/net/can/xilinx_can.c
+++ b/drivers/net/can/xilinx_can.c
@@ -1737,20 +1737,13 @@ static int xcan_probe(struct platform_device *pdev)
 	priv->write_reg = xcan_write_reg_le;
 	priv->read_reg = xcan_read_reg_le;
 
-	ret = clk_prepare_enable(priv->bus_clk);
-	if (ret) {
-		dev_err(&pdev->dev, "Cannot enable clock.\n");
-		goto err_free;
-	}
-
-	ret = clk_prepare_enable(priv->can_clk);
-	if (ret) {
-		dev_err(&pdev->dev, "Cannot enable clock.\n");
-		goto err_clk;
-	}
-
-	pm_runtime_set_active(&pdev->dev);
 	pm_runtime_enable(&pdev->dev);
+	ret = pm_runtime_get_sync(&pdev->dev);
+	if (ret < 0) {
+		netdev_err(ndev, "%s: pm_runtime_get failed(%d)\n",
+			__func__, ret);
+		goto err_pmdisable;
+	}
 
 	if (priv->read_reg(priv, XCAN_SR_OFFSET) != XCAN_SR_CONFIG_MASK) {
 		priv->write_reg = xcan_write_reg_be;
@@ -1778,11 +1771,9 @@ static int xcan_probe(struct platform_device *pdev)
 	return 0;
 
 err_disableclks:
+	pm_runtime_put(priv->dev);
+err_pmdisable:
 	pm_runtime_disable(&pdev->dev);
-	pm_runtime_set_suspended(&pdev->dev);
-	clk_disable_unprepare(priv->can_clk);
-err_clk:
-	clk_disable_unprepare(priv->bus_clk);
 err_free:
 	free_candev(ndev);
 err:
@@ -1802,12 +1793,6 @@ static int xcan_remove(struct platform_device *pdev)
 	struct xcan_priv *priv = netdev_priv(ndev);
 
 	unregister_candev(ndev);
-
-	if (!pm_runtime_suspended(&pdev->dev)) {
-		clk_disable_unprepare(priv->bus_clk);
-		clk_disable_unprepare(priv->can_clk);
-	}
-
 	pm_runtime_disable(&pdev->dev);
 	netif_napi_del(&priv->napi);
 	free_candev(ndev);
-- 
2.17.1

