From 1a74e9fbc79edb9f0507a76acdb6850daa2559dc Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 21 Apr 2016 08:23:15 +0300
Subject: [PATCH 1326/1345] pcie: armada8k: Set flag to always re-assign buses
 and resources

commit  e0173957dc397f49dfe0dfeecae8d3fbca7a421e from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Linux PCI stack respects PCI bus and resource assignment performed by BIOS,
bootloaders, or firmware. In some scenarios, The non-linux allocation
is wrong and fails to account for extended features.
For example when an end-point has an SR-IOV capability, The PCI stack
must reserve additional buses behind the PCI bridge to allow the
virtual functions to use them when needed. U-BOOT for example doesn't
account for this.
To resolve that, we add a flag in the host controller telling the PCI
stack to re-assign all resources.

Change-Id: Ie5e8506ff242433b58deaafdac1b855ad911790c
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/29248
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Shadi Ammouri <shadi@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/pci/dwc/pcie-armada8k.c |    2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/pci/dwc/pcie-armada8k.c b/drivers/pci/dwc/pcie-armada8k.c
index 495b023..6d9b186 100644
--- a/drivers/pci/dwc/pcie-armada8k.c
+++ b/drivers/pci/dwc/pcie-armada8k.c
@@ -239,6 +239,8 @@ static int armada8k_pcie_probe(struct platform_device *pdev)
 
 	platform_set_drvdata(pdev, pcie);
 
+	pci_add_flags(PCI_REASSIGN_ALL_RSRC | PCI_REASSIGN_ALL_BUS);
+
 	ret = armada8k_add_pcie_port(pcie, pdev);
 	if (ret)
 		goto fail;
-- 
1.7.9.5

