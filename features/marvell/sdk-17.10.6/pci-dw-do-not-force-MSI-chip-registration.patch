From e11afcbae2742911d15462c9c1858aa075ca251d Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Sun, 21 Feb 2016 16:32:20 +0200
Subject: [PATCH 0069/1345] pci: dw: do not force MSI chip registration

commit  16d3985828f610b21ee21de42dccd5bd06365bf5 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Some DW based PCIe controllers, like Armada-8k can only
detect in runtime if they have support for MSI or not.

Do not fail the host init in case a DW based driver refuses
to register an MSI chip. instead, continue and register the
PCI host without an MSI chip.

Change-Id: I4ece91d1c5b525616f25490490f9481951ee7cf8
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/pci/dwc/pcie-designware-host.c |    9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/drivers/pci/dwc/pcie-designware-host.c b/drivers/pci/dwc/pcie-designware-host.c
index 28ed32b..cbebfaa 100644
--- a/drivers/pci/dwc/pcie-designware-host.c
+++ b/drivers/pci/dwc/pcie-designware-host.c
@@ -281,7 +281,7 @@ int dw_pcie_host_init(struct pcie_port *pp)
 	struct platform_device *pdev = to_platform_device(dev);
 	struct pci_bus *bus, *child;
 	struct resource *cfg_res;
-	int i, ret;
+	int i, ret, has_msi = 0;
 	LIST_HEAD(res);
 	struct resource_entry *win, *tmp;
 
@@ -386,13 +386,12 @@ int dw_pcie_host_init(struct pcie_port *pp)
 				ret = -ENXIO;
 				goto error;
 			}
+			has_msi = 1;
 
 			for (i = 0; i < MAX_MSI_IRQS; i++)
 				irq_create_mapping(pp->irq_domain, i);
 		} else {
-			ret = pp->ops->msi_host_init(pp, &dw_pcie_msi_chip);
-			if (ret < 0)
-				goto error;
+			has_msi = (pp->ops->msi_host_init(pp, &dw_pcie_msi_chip) == 0);
 		}
 	}
 
@@ -400,7 +399,7 @@ int dw_pcie_host_init(struct pcie_port *pp)
 		pp->ops->host_init(pp);
 
 	pp->root_bus_nr = pp->busn->start;
-	if (IS_ENABLED(CONFIG_PCI_MSI)) {
+	if (IS_ENABLED(CONFIG_PCI_MSI) && has_msi) {
 		bus = pci_scan_root_bus_msi(dev, pp->root_bus_nr,
 					    &dw_pcie_ops, pp, &res,
 					    &dw_pcie_msi_chip);
-- 
1.7.9.5

