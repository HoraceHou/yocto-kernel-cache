From 04c485de4b481ff8106fb2727b92d363facca797 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Mon, 20 Jun 2016 13:16:23 +0300
Subject: [PATCH 0332/1345] fix: sar: ap806: fix kernel crash when CPU
 frequency is not supported

commit  5459bed660e5b97eb2d549e1c4ab22a4de46e542 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Remove the return from clk_init function when sample at reset CPU clock
frequency is not supported.
The issue found when loading Kernel with unsupported CPU frequency,
the function return without configure the MSS clock, and UART baud-rate
not configured correctly.
Setting CPU clock to 0 (zoro) is invalid, and might lead to unexpected
unit behavior, but avoiding kernel crash

Change-Id: I80ba550a819f3ad7c69626820db58642b6bc6426
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/30566
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Neta Zur Hershkovits <neta@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/clk/mvebu/ap806-system-controller.c |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/clk/mvebu/ap806-system-controller.c b/drivers/clk/mvebu/ap806-system-controller.c
index 6fa7fa0..9e90be7 100644
--- a/drivers/clk/mvebu/ap806-system-controller.c
+++ b/drivers/clk/mvebu/ap806-system-controller.c
@@ -89,8 +89,12 @@ static int ap806_syscon_clk_probe(struct platform_device *pdev)
 		cpuclk_freq = 600;
 		break;
 	default:
+		/* set cpuclk_freq as invalid value to continue and
+		** configure the MSS clock (used to calculate the
+		** baudrate of the UART
+		*/
+		cpuclk_freq = 0;
 		dev_err(&pdev->dev, "invalid SAR value\n");
-		return -EINVAL;
 	}
 
 	/* Convert to hertz */
-- 
1.7.9.5

