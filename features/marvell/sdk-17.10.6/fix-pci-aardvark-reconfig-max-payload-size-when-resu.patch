From 5e8259d21e75f1d255924411a2b6ff7f58a3e83b Mon Sep 17 00:00:00 2001
From: Evan Wang <xswang@marvell.com>
Date: Wed, 5 Jul 2017 14:11:13 +0800
Subject: [PATCH 1060/1345] fix: pci: aardvark: reconfig max payload size when
 resume

commit  bd94ba0f6020a8ac59d6714f84e0f0c8538b902f from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Currently the Max Payload Size is not restored when
S2R resume, which causes PCIE data transfer problem
after resume.
The patch restored the max payload size in resume
routine.
JIRA number: A3700-1357

Change-Id: If0a3f12d0c26dbb13f5018e5da96ee3dbacd8bb6
Signed-off-by: Evan Wang <xswang@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/41159
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Victor Gu <xigu@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/pci/host/pci-aardvark.c |   10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/host/pci-aardvark.c b/drivers/pci/host/pci-aardvark.c
index 67ba301..306ba98 100644
--- a/drivers/pci/host/pci-aardvark.c
+++ b/drivers/pci/host/pci-aardvark.c
@@ -179,6 +179,7 @@
 
 struct advk_pcie {
 	struct platform_device *pdev;
+	struct pci_bus *bus;
 	void __iomem *base;
 	struct phy *phy;
 	struct list_head resources;
@@ -871,9 +872,10 @@ static int advk_pcie_bus_configure_mps(struct pci_dev *dev, void *data)
 	return 0;
 }
 
-static void advk_pcie_configure_mps(struct pci_bus *bus, struct advk_pcie *pcie)
+static void advk_pcie_configure_mps(struct advk_pcie *pcie)
 {
 	u8 smpss = PCIE_CORE_DEV_CTRL_STATS_MAX_PAYLOAD_SZ;
+	struct pci_bus *bus = pcie->bus;
 	u32 reg;
 
 	/* Find the minimal supported MAX payload size */
@@ -1016,12 +1018,13 @@ static int advk_pcie_probe(struct platform_device *pdev)
 	}
 
 	pci_bus_assign_resources(bus);
+	pcie->bus = bus;
 
 	list_for_each_entry(child, &bus->children, node)
 		pcie_bus_configure_settings(child);
 
 	/* Configure the MAX pay load size */
-	advk_pcie_configure_mps(bus, pcie);
+	advk_pcie_configure_mps(pcie);
 
 	pci_bus_add_devices(bus);
 	return 0;
@@ -1077,6 +1080,9 @@ static int advk_pcie_resume_noirq(struct device *dev)
 
 	advk_pcie_setup_hw(pcie);
 
+	/* Reconfigure the MAX pay load size */
+	advk_pcie_configure_mps(pcie);
+
 	return 0;
 }
 
-- 
1.7.9.5

