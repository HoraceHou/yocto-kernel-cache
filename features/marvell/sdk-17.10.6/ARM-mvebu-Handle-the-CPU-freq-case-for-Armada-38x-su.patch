From 2de9d5cbaa1668ea76850ce505537e8ed0826a17 Mon Sep 17 00:00:00 2001
From: Gregory CLEMENT <gregory.clement@free-electrons.com>
Date: Fri, 3 Jul 2015 08:08:05 +0200
Subject: [PATCH 0028/1345] ARM: mvebu: Handle the CPU freq case for Armada
 38x suspend

commit  7a53fca87705da755e359c29157e1014ef2a6e23 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: I253e9c6b91ebae14dc6771838946ba0fdcaf967b
Signed-off-by: Gregory CLEMENT <gregory.clement@free-electrons.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/23687
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/27313
Reviewed-by: Lior Amsalem <alior@marvell.com>
Tested-by: Lior Amsalem <alior@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/mach-mvebu/pm.c   |    3 +++
 arch/arm/mach-mvebu/pmsu.h |    1 +
 2 files changed, 4 insertions(+)

diff --git a/arch/arm/mach-mvebu/pm.c b/arch/arm/mach-mvebu/pm.c
index b402382..0bbe19a 100644
--- a/arch/arm/mach-mvebu/pm.c
+++ b/arch/arm/mach-mvebu/pm.c
@@ -217,6 +217,9 @@ static int mvebu_enter_suspend(void)
 
 	cpu_suspend(0, mvebu_pm_powerdown);
 
+	/* Remove CPU1 from the PMU frequency domain until it becomes online */
+	mvebu_v7_pmsu_disable_dfs_cpu(1);
+
 	outer_resume();
 
 	mvebu_v7_pmsu_idle_exit();
diff --git a/arch/arm/mach-mvebu/pmsu.h b/arch/arm/mach-mvebu/pmsu.h
index 9166e94..6260ebd 100644
--- a/arch/arm/mach-mvebu/pmsu.h
+++ b/arch/arm/mach-mvebu/pmsu.h
@@ -22,4 +22,5 @@ int mvebu_setup_boot_addr_wa(unsigned int crypto_eng_target,
 
 int armada_370_xp_pmsu_idle_enter(unsigned long deepidle);
 int armada_38x_do_cpu_suspend(unsigned long deepidle);
+void mvebu_v7_pmsu_disable_dfs_cpu(int hw_cpu);
 #endif	/* __MACH_370_XP_PMSU_H */
-- 
1.7.9.5

