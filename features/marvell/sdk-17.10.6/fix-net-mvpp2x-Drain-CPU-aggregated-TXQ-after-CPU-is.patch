From 2a759076722763bf9c3026dfa3b5fe0533560532 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Wed, 19 Jul 2017 16:57:29 +0300
Subject: [PATCH 1091/1345] fix: net: mvpp2x: Drain CPU aggregated TXQ after
 CPU is in down state

commit  e04789ceebf27c1e65b9784af1ff87211d55de91 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

This patch fix race between xmit procedure and CPU hotplug during heavy
traffic.
Race could cause traffic loss and traffic stuck.

Fix:
- Drain CPU aggregated TXQ after CPU is dead and prevent race with xmit
  procedure on same CPU.
- Packets transmitted from dead CPU address space by mv_pp22_thread_write
  function.

Change-Id: I4e63d2674565582cde1d6281d40e8935a4e6c146
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/41867
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 318cd4e..e8ceef8 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -4942,7 +4942,8 @@ static int mv_pp2x_port_cpu_callback(struct notifier_block *nfb,
 		if (port->priv->pp2xdata->interrupt_tx_done)
 			on_each_cpu_mask(&cpus_mask, mv_pp2x_tx_done_pkts_coal_set, port, 1);
 		break;
-	case CPU_DOWN_PREPARE:
+	case CPU_DEAD:
+	case CPU_DEAD_FROZEN:
 		cp_pcpu = per_cpu_ptr(port->priv->pcpu, cpu);
 		aggr_txq = &port->priv->aggr_txqs[cpu];
 		mv_pp2x_tx_timer_kill(cp_pcpu);
-- 
1.7.9.5

