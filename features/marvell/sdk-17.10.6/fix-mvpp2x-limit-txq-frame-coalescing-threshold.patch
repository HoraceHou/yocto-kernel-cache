From 35645336d572a0496871af0d1f13c1eaa6a9de51 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Tue, 16 Aug 2016 14:14:09 +0300
Subject: [PATCH 0411/1345] fix: mvpp2x: limit txq frame coalescing threshold

commit  66eb6914def3c725e387dea46e502b9c5da98851 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

- limit txq frame coalescing threshold with 16K value

Change-Id: I39e76be0a54ad88c40c22b0603e4594366f17dbb
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/31969
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c   |    2 ++
 .../net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h  |    4 +++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
index 1c4eae5..281af1c 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
@@ -3496,6 +3496,8 @@ void mv_pp2x_tx_done_pkts_coal_set(void *arg)
 	for (queue = 0; queue < port->num_tx_queues; queue++) {
 		struct mv_pp2x_tx_queue *txq = port->txqs[queue];
 
+		if (txq->pkts_coal > MVPP2_MAX_TRANSMITTED_THRESH)
+			txq->pkts_coal = MVPP2_MAX_TRANSMITTED_THRESH;
 		val = (txq->pkts_coal << MVPP2_TRANSMITTED_THRESH_OFFSET) &
 		       MVPP2_TRANSMITTED_THRESH_MASK;
 		mv_pp2x_write(&port->priv->hw, MVPP2_TXQ_NUM_REG, txq->id);
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
index 638bfff..528eab6 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
@@ -798,7 +798,9 @@
 #define MVPP2_AGGR_TXQ_UPDATE_REG		0x2090
 #define MVPP2_TXQ_THRESH_REG			0x2094
 #define MVPP2_TRANSMITTED_THRESH_OFFSET		16
-#define MVPP2_TRANSMITTED_THRESH_MASK		0x3fff0000
+#define MVPP2_MAX_TRANSMITTED_THRESH		0x3fff
+#define MVPP2_TRANSMITTED_THRESH_MASK		\
+	((MVPP2_MAX_TRANSMITTED_THRESH) << MVPP2_TRANSMITTED_THRESH_OFFSET)
 #define MVPP2_TXQ_INDEX_REG			0x2098
 #define MVPP2_TXQ_PREF_BUF_REG			0x209c
 #define MVPP2_PREF_BUF_PTR(desc)		((desc) & 0xfff)
-- 
1.7.9.5

