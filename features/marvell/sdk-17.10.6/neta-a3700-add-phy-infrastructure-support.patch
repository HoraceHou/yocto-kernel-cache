From e37769b5e38929f21e0f849d13df4789c45a89a4 Mon Sep 17 00:00:00 2001
From: Evan Wang <xswang@marvell.com>
Date: Tue, 17 Jan 2017 00:40:13 +0800
Subject: [PATCH 0855/1345] neta: a3700: add phy infrastructure support

commit  77b729d3e00f5af7ffa4346d4b292cd191a16d5c from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

- neta driver needs to support phy init during normal setup
  and PM resume to eliminate dependency on bootloader.
- the patch implement phy support with phy infrastructure
  via calling API of phy_init, phy_power_on, etc.

Change-Id: I1a9db5dd54281432aeb2c6ec22a35edfbabded21
Signed-off-by: Evan Wang <xswang@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/37076
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../bindings/net/marvell-armada-370-neta.txt       |   23 +++++++++++++-
 drivers/net/ethernet/marvell/mvneta.c              |   33 +++++++++++++++++++-
 2 files changed, 54 insertions(+), 2 deletions(-)

diff --git a/Documentation/devicetree/bindings/net/marvell-armada-370-neta.txt b/Documentation/devicetree/bindings/net/marvell-armada-370-neta.txt
index 1102207..651d106 100644
--- a/Documentation/devicetree/bindings/net/marvell-armada-370-neta.txt
+++ b/Documentation/devicetree/bindings/net/marvell-armada-370-neta.txt
@@ -22,7 +22,7 @@ Optional properties:
   "core" for core clock and "bus" for the optional bus clock.
 
 
-Optional properties (valid only for Armada XP/38x):
+Optional properties (valid only for Armada XP/38x/3700):
 
 - buffer-manager: a phandle to a buffer manager node. Please refer to
   Documentation/devicetree/bindings/net/marvell-neta-bm.txt
@@ -33,6 +33,10 @@ Optional properties (valid only for Armada XP/38x):
 - bm,pool-short: ID of a pool, that will be used for accepting
   packets of a size lower than given threshold. If not set, the port
   will use a single 'long' pool for all packets, as defined above.
+- phys: the serdes PHY associated to this device. Currently the property
+  is only used by armada-3700 for SGMII interface.
+  Format: <comphy_parent lane_number lane_type>.
+- phy-names: the name of dedicated serdes indicated by above property of phys.
 
 Example:
 
@@ -49,3 +53,20 @@ ethernet@70000 {
 	bm,pool-long = <0>;
 	bm,pool-short = <1>;
 };
+
+Example with serdes PHY:
+	eth1: ethernet@40000 {
+	compatible = "marvell,armada3700-neta";
+	reg = <0x40000 0x4000>;
+	interrupts = <GIC_SPI 45 IRQ_TYPE_LEVEL_HIGH>;
+	mac-address = [00 50 43 01 02 03];
+	clocks = <&sgateclk 4>;
+	status = "okay";
+	phy-mode = "sgmii";
+	phy = <&phy1>;
+	buffer-manager = <&bm>;
+	bm,pool-long = <0>;
+	bm,pool-short = <1>;
+	phys = <&a3700_comphy 1 COMPHY_SGMII1>;
+	phy-names = "comphy";
+};
diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index 087317a..1fe903a 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -36,6 +36,7 @@
 #include <net/ip.h>
 #include <net/ipv6.h>
 #include <net/tso.h>
+#include <linux/phy/phy.h>
 
 /* Registers */
 #define MVNETA_RXQ_CONFIG_REG(q)                (0x1400 + ((q) << 2))
@@ -422,6 +423,11 @@ struct mvneta_port {
 	struct mii_bus *mii_bus;
 	phy_interface_t phy_interface;
 	struct device_node *phy_node;
+	/* comphy handler, current it supports a 1:1 relation between the port
+	 * and the phy. The phy here means serdes, which is different from
+	 * phy_dev above.
+	 */
+	struct phy *comphy;
 	unsigned int link;
 	unsigned int duplex;
 	unsigned int speed;
@@ -4681,6 +4687,20 @@ static int mvneta_probe(struct platform_device *pdev)
 	pp->phy_node = phy_node;
 	pp->phy_interface = phy_mode;
 
+	/* Get comphy and init if there is */
+	pp->comphy = devm_of_phy_get(&pdev->dev, dn, "comphy");
+	if (!IS_ERR(pp->comphy)) {
+		err = phy_init(pp->comphy);
+		if (err)
+			goto err_put_phy_node;
+
+		err = phy_power_on(pp->comphy);
+		if (err) {
+			phy_exit(pp->comphy);
+			goto err_exit_phy;
+		}
+	}
+
 	err = of_property_read_string(dn, "managed", &managed);
 	pp->use_inband_status = (err == 0 &&
 				 strcmp(managed, "in-band-status") == 0);
@@ -4705,7 +4725,7 @@ static int mvneta_probe(struct platform_device *pdev)
 		pp->clk = devm_clk_get(&pdev->dev, NULL);
 	if (IS_ERR(pp->clk)) {
 		err = PTR_ERR(pp->clk);
-		goto err_put_phy_node;
+		goto err_off_phy;
 	}
 
 	clk_prepare_enable(pp->clk);
@@ -4871,6 +4891,12 @@ static int mvneta_probe(struct platform_device *pdev)
 err_clk:
 	clk_disable_unprepare(pp->clk_bus);
 	clk_disable_unprepare(pp->clk);
+err_off_phy:
+	if (!IS_ERR(pp->comphy))
+		phy_power_off(pp->comphy);
+err_exit_phy:
+	if (!IS_ERR(pp->comphy))
+		phy_exit(pp->comphy);
 err_put_phy_node:
 	of_node_put(phy_node);
 	if (of_phy_is_fixed_link(dn))
@@ -4906,6 +4932,11 @@ static int mvneta_remove(struct platform_device *pdev)
 				       1 << pp->id);
 	}
 
+	if (!IS_ERR(pp->comphy)) {
+		phy_power_off(pp->comphy);
+		phy_exit(pp->comphy);
+	}
+
 	return 0;
 }
 
-- 
1.7.9.5

