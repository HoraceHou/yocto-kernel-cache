From a6d585246f3d285136ca7fb13705e6f614066315 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 26 Jul 2017 13:04:55 +0300
Subject: [PATCH 1192/1345] fix: neta: swbm: fix rx error when refill is
 stopped

commit  34d96281a572b25998009efcd5d3c5d4f16cf5d7 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: I3cf5113364934382737fde41e1790c0fe9b121f9
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/42191
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Neta Zur Hershkovits <neta@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvneta.c |   13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index 5c93766..dcbfc34 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -2143,8 +2143,17 @@ static int mvneta_rx_swbm(struct mvneta_port *pp, int rx_todo,
 err_drop_frame:
 			dev->stats.rx_errors++;
 			mvneta_rx_error(pp, rx_desc);
-			/* leave the descriptor untouched */
-			rx_filled++;
+			if (atomic_read(&rxq->refill_stop)) {
+				/* refill already stopped - free skb */
+				rx_desc->buf_cookie = 0;
+				atomic_inc(&rxq->missed);
+				dma_unmap_single(dev->dev.parent, phys_addr - pp->rx_offset_correction,
+						 MVNETA_RX_BUF_SIZE(pp->pkt_size), DMA_FROM_DEVICE);
+				mvneta_frag_free(pp->frag_size, data);
+			} else {
+				/* leave the descriptor untouched */
+				rx_filled++;
+			}
 			continue;
 		}
 
-- 
1.7.9.5

