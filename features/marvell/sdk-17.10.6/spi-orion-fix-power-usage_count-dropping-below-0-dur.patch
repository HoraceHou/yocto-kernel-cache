From ee2f4c9db8d0eb6f2827770b540929e14eb62d8a Mon Sep 17 00:00:00 2001
From: Yoav Gvili <ygvili@marvell.com>
Date: Wed, 2 Nov 2016 17:13:35 +0200
Subject: [PATCH 0579/1345] spi: orion: fix power usage_count dropping below 0
 during probe.

commit  8cc59d27054cb379a6f73f2f6e7ec39b13d1aa5f from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

The call to pm_runtime_autosuspend() in orion_spi_probe() will drop
the device power usage_count from 0 to -1. If the device is used for a
very large SPI transfer (for instance dd if=/dev/mtd0 bs=1M count=1,
where /dev/mtd0 is an SPI NOR flash) the power usage_count will go
back to 0, leading the PM runtime code to think it is okay to power
down the device after SPI_AUTOSUSPEND_TIMEOUT milliseconds have
passed.

Fix that by invoking pm_runtime_get_sync() during probe.

Change-Id: Ie8a8b4e1980a95b5f7c50fdbab8b947d0fd6f225
Signed-off-by: Yoav Gvili <ygvili@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/33539
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/spi/spi-orion.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/spi/spi-orion.c b/drivers/spi/spi-orion.c
index 3a06be6..afa7f69 100644
--- a/drivers/spi/spi-orion.c
+++ b/drivers/spi/spi-orion.c
@@ -723,6 +723,7 @@ static int orion_spi_probe(struct platform_device *pdev)
 	if (status < 0)
 		goto out_rel_pm;
 
+	pm_runtime_get_sync(&pdev->dev);
 	pm_runtime_mark_last_busy(&pdev->dev);
 	pm_runtime_put_autosuspend(&pdev->dev);
 
-- 
1.7.9.5

