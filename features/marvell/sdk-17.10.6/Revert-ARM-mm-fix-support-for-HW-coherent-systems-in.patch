From 14454a309cb33933da3b43da939694565398de4d Mon Sep 17 00:00:00 2001
From: Marcin Wojtas <mw@semihalf.com>
Date: Sat, 19 Mar 2016 09:04:34 +0100
Subject: [PATCH 0131/1345] Revert "ARM: mm: fix support for HW coherent
 systems in PL310 cache"

commit  1fe519815792d360e127fc86ec9b91ad81c22248 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

This patch reverts the PL310 removal of L2 operations due to HWCC
system. This is done because of a new (and dymanic) way to find this
configuration and remove the L2 operations.
The new implementation is introduced in the followin patches.

This reverts 'commit c4e4d88303a0 ("ARM: dma-mapping: Don't use
outer_flush_range when the L2C is coherent")'.

Change-Id: I4bd2c87396971a7f0969441f2d7c1b42d010bb09
Signed-off-by: Lior Amsalem <alior@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/28513
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Ofer Heifetz <oferh@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/mm/cache-l2x0.c |    7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mm/cache-l2x0.c b/arch/arm/mm/cache-l2x0.c
index 0b2a4ca..808efbb 100644
--- a/arch/arm/mm/cache-l2x0.c
+++ b/arch/arm/mm/cache-l2x0.c
@@ -1324,9 +1324,9 @@ static void __init l2c310_of_parse(const struct device_node *np,
 };
 
 /*
- * This is a variant of the of_l2c310_data with .sync and .flush_range set to
- * NULL. Outer sync and flush range operations are not needed when the system
- * is I/O coherent, and potentially harmful in certain situations (PCIe/PL310
+ * This is a variant of the of_l2c310_data with .sync set to
+ * NULL. Outer sync operations are not needed when the system is I/O
+ * coherent, and potentially harmful in certain situations (PCIe/PL310
  * deadlock on Armada 375/38x due to hardware I/O coherency). The
  * other operations are kept because they are infrequent (therefore do
  * not cause the deadlock in practice) and needed for secondary CPU
@@ -1345,6 +1345,7 @@ static void __init l2c310_of_parse(const struct device_node *np,
 	.outer_cache = {
 		.inv_range   = l2c210_inv_range,
 		.clean_range = l2c210_clean_range,
+		.flush_range = l2c210_flush_range,
 		.flush_all   = l2c210_flush_all,
 		.disable     = l2c310_disable,
 		.resume      = l2c310_resume,
-- 
1.7.9.5

