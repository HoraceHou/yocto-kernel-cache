From 5258cf4f5fb9ea0d854c30962d2b79ad03495a98 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Tue, 16 Feb 2016 17:11:15 +0200
Subject: [PATCH 0038/1345] mv_xor_v2: add compatbile for zor-z1 to reduce
 rd/wr burst size

commit  74eefdb1b0a4b02ddef9b8831757f03a41be29b3 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: I6d4168d5ad0cc558327219022dc14e69b48877fa
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../boot/dts/marvell/armada-ap806-z1-quad.dtsi     |   19 +++++++++
 drivers/dma/mv_xor_v2.c                            |   43 +++++++++++++++++---
 2 files changed, 57 insertions(+), 5 deletions(-)

diff --git a/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi b/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
index 7cec24a..49e901f 100644
--- a/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
@@ -80,4 +80,23 @@
 		};
 	};
 
+	ap806 {
+		config-space {
+			xor0@400000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor1@420000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor2@440000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor3@460000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+		};
+	};
 };
diff --git a/drivers/dma/mv_xor_v2.c b/drivers/dma/mv_xor_v2.c
index f3e211f..84a2c399 100644
--- a/drivers/dma/mv_xor_v2.c
+++ b/drivers/dma/mv_xor_v2.c
@@ -64,8 +64,10 @@
 #define   MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_WR_VAL	8
 #define   MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_SHIFT	12
 #define   MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL	4
+#define   MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL_Z1	2
 #define   MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_SHIFT	16
 #define	  MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_VAL	4
+#define   MV_XOR_V2_GLOB_GLOB_BW_CTRL_WR_BURST_LEN_VAL_Z1     	2
 #define MV_XOR_V2_GLOB_PAUSE				0x014
 #define   MV_XOR_V2_GLOB_PAUSE_AXI_TIME_DIS_VAL		0x8
 #define MV_XOR_V2_GLOB_SYS_INT_CAUSE			0x200
@@ -179,6 +181,17 @@ struct mv_xor_v2_sw_desc {
 };
 
 /*
+ * Hold XOR engine parameters depending on the matched
+ * compatible string.
+ */
+struct mv_xor_v2_compat_data {
+	u32 rd_burst_len;
+	u32 wr_burst_len;
+};
+
+static const struct of_device_id mv_xor_v2_dt_ids[];
+
+/*
  * Fill the data buffers to a HW descriptor
  */
 static void mv_xor_v2_set_data_buffers(struct mv_xor_v2_device *xor_dev,
@@ -605,6 +618,8 @@ static void mv_xor_v2_set_msi_msg(struct msi_desc *desc, struct msi_msg *msg)
 static int mv_xor_v2_descq_init(struct mv_xor_v2_device *xor_dev)
 {
 	u32 reg;
+	const struct of_device_id *match;
+	struct mv_xor_v2_compat_data *data;
 
 	/* write the DESQ size to the DMA engine */
 	writel(MV_XOR_V2_DESC_NUM,
@@ -644,14 +659,17 @@ static int mv_xor_v2_descq_init(struct mv_xor_v2_device *xor_dev)
 	 * -  Limit the number of outstanding write & read data
 	 *    (OBB/IBB) requests to the maximal value.
 	*/
+	match = of_match_node(mv_xor_v2_dt_ids, xor_dev->dmadev.dev->of_node);
+	if (WARN_ON(!match))
+		return -1;
+	data = (struct mv_xor_v2_compat_data *)match->data;
+
 	reg = ((MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_RD_VAL <<
 		MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_RD_SHIFT) |
 	       (MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_WR_VAL  <<
 		MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_WR_SHIFT) |
-	       (MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL <<
-		MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_SHIFT) |
-	       (MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_VAL <<
-		MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_SHIFT));
+		(data->rd_burst_len << MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_SHIFT) |
+		(data->wr_burst_len << MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_SHIFT);
 	writel(reg, xor_dev->glob_base + MV_XOR_V2_GLOB_BW_CTRL);
 
 	/* Disable the AXI timer feature */
@@ -835,10 +853,25 @@ static int mv_xor_v2_remove(struct platform_device *pdev)
 }
 
 #ifdef CONFIG_OF
+
+struct mv_xor_v2_compat_data xor_compat_data = {
+	.rd_burst_len = MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL,
+	.wr_burst_len = MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_VAL
+};
+
+struct mv_xor_v2_compat_data xor_compat_data_z1 = {
+	.rd_burst_len = MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL_Z1,
+	.wr_burst_len = MV_XOR_V2_GLOB_GLOB_BW_CTRL_WR_BURST_LEN_VAL_Z1
+};
+
 static const struct of_device_id mv_xor_v2_dt_ids[] = {
-	{ .compatible = "marvell,xor-v2", },
+	{ .compatible = "marvell,mv-xor-v2",
+	  .data = &xor_compat_data},
+	{ .compatible = "marvell,mv-xor-v2-z1",
+	  .data = &xor_compat_data_z1 },
 	{},
 };
+
 MODULE_DEVICE_TABLE(of, mv_xor_v2_dt_ids);
 #endif
 
-- 
1.7.9.5

