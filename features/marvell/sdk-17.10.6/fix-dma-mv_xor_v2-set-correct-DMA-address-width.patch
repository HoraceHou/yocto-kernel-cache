From bc7ab82aba3e76676f7d828b5fe487d1a52df312 Mon Sep 17 00:00:00 2001
From: Igal Liberman <igall@marvell.com>
Date: Mon, 24 Apr 2017 15:51:42 +0300
Subject: [PATCH 0984/1345] fix: dma: mv_xor_v2: set correct DMA address width

commit  5b67bec322486593a01a7f55ea3d438b8595ac6a from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Currently, there's a data corruption when working with A80x0
and DRAM size is bigger than 4GB. The data corruption happens
because the DMA bus width isn't configured properly.

The patch fixes the issue by implementing the following:
- Add new property to the device-tree: "dma-bus-width" to pass
  the correct DMA bus width to the driver.
- Call dma_set_mask_and_coherent() function: This function must
  be called before any DMA API calls, both to confirm DMA really
  is going to work, and also to describe the full inherent
  addressing capability which passed to the driver from the
  device-tree.

Calling dma_set_mask_and_coherent() with the correct bus width
solves the data corruption occurs when using XOR engine with DRAM
bigger than 4GB.

Documentation is updated accordingly.

Change-Id: I26d682213e2417774f05ce7d0fa9320539b034bf
Signed-off-by: Igal Liberman <igall@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/38852
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../devicetree/bindings/dma/mv-xor-v2.txt          |    2 ++
 arch/arm64/boot/dts/marvell/armada-ap806.dtsi      |    4 ++++
 arch/arm64/boot/dts/marvell/armada-cp110-1.dtsi    |    2 ++
 .../boot/dts/marvell/armada-cp110-master.dtsi      |    2 ++
 .../arm64/boot/dts/marvell/armada-cp110-slave.dtsi |    2 ++
 arch/arm64/boot/dts/marvell/armada-cp110.dtsi      |    2 ++
 drivers/dma/mv_xor_v2.c                            |   13 +++++++++++++
 7 files changed, 27 insertions(+)

diff --git a/Documentation/devicetree/bindings/dma/mv-xor-v2.txt b/Documentation/devicetree/bindings/dma/mv-xor-v2.txt
index 5b71867..0dec12e 100644
--- a/Documentation/devicetree/bindings/dma/mv-xor-v2.txt
+++ b/Documentation/devicetree/bindings/dma/mv-xor-v2.txt
@@ -7,6 +7,7 @@ Required properties:
 - reg: Should contain registers location and length (two sets)
     the first set is the DMA registers
     the second set is the global registers
+- dma-bus-width: DMA address bus width
 - msi-parent: Phandle to the MSI-capable interrupt controller used for
   interrupts.
 - clocks: One ore more clock gating clocks to be used to enable DMA engine
@@ -24,4 +25,5 @@ Example:
 		msi-parent = <&gic_v2m0>;
 		clocks = <&gateclk 14>;
 		dma-coherent;
+		dma-width = <40>;
 	};
diff --git a/arch/arm64/boot/dts/marvell/armada-ap806.dtsi b/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
index 941ad9a..1631884 100644
--- a/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
@@ -291,6 +291,7 @@
 				      <0x410000 0x1000>;
 				msi-parent = <&gic_v2m0>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				clocks = <&ap_syscon 3>;
 				status = "okay";
 			};
@@ -301,6 +302,7 @@
 				      <0x430000 0x1000>;
 				msi-parent = <&gic_v2m0>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				clocks = <&ap_syscon 3>;
 				status = "okay";
 			};
@@ -311,6 +313,7 @@
 				      <0x450000 0x1000>;
 				msi-parent = <&gic_v2m0>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				clocks = <&ap_syscon 3>;
 				status = "okay";
 			};
@@ -321,6 +324,7 @@
 				      <0x470000 0x1000>;
 				msi-parent = <&gic_v2m0>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				clocks = <&ap_syscon 3>;
 				status = "okay";
 			};
diff --git a/arch/arm64/boot/dts/marvell/armada-cp110-1.dtsi b/arch/arm64/boot/dts/marvell/armada-cp110-1.dtsi
index 6578f60..2d5374e5 100644
--- a/arch/arm64/boot/dts/marvell/armada-cp110-1.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-cp110-1.dtsi
@@ -177,6 +177,7 @@ dma_xor@6a0000 {
 	reg = <0x6a0000 0x1000>,
 	      <0x6b0000 0x1000>;
 	dma-coherent;
+	dma-bus-width = <40>;
 	msi-parent = <&gic_v2m0>;
 	clocks = <&cps_syscon0 1 8>;
 	status = "okay";
@@ -187,6 +188,7 @@ dma_xor@6c0000 {
 	reg = <0x6c0000 0x1000>,
 	      <0x6d0000 0x1000>;
 	dma-coherent;
+	dma-bus-width = <40>;
 	msi-parent = <&gic_v2m0>;
 	clocks = <&cps_syscon0 1 7>;
 	status = "okay";
diff --git a/arch/arm64/boot/dts/marvell/armada-cp110-master.dtsi b/arch/arm64/boot/dts/marvell/armada-cp110-master.dtsi
index 0b6b8904..603d286 100644
--- a/arch/arm64/boot/dts/marvell/armada-cp110-master.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-cp110-master.dtsi
@@ -161,6 +161,7 @@
 				reg = <0x6a0000 0x1000>,
 				      <0x6b0000 0x1000>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				msi-parent = <&gic_v2m0>;
 				clocks = <&cpm_syscon0 1 8>;
 			};
@@ -170,6 +171,7 @@
 				reg = <0x6c0000 0x1000>,
 				      <0x6d0000 0x1000>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				msi-parent = <&gic_v2m0>;
 				clocks = <&cpm_syscon0 1 7>;
 			};
diff --git a/arch/arm64/boot/dts/marvell/armada-cp110-slave.dtsi b/arch/arm64/boot/dts/marvell/armada-cp110-slave.dtsi
index 7e2d0fa..8fc42f8 100644
--- a/arch/arm64/boot/dts/marvell/armada-cp110-slave.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-cp110-slave.dtsi
@@ -135,6 +135,7 @@
 				reg = <0x6a0000 0x1000>,
 				      <0x6b0000 0x1000>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				msi-parent = <&gic_v2m0>;
 				clocks = <&cps_syscon0 1 8>;
 			};
@@ -144,6 +145,7 @@
 				reg = <0x6c0000 0x1000>,
 				      <0x6d0000 0x1000>;
 				dma-coherent;
+				dma-bus-width = <40>;
 				msi-parent = <&gic_v2m0>;
 				clocks = <&cps_syscon0 1 7>;
 			};
diff --git a/arch/arm64/boot/dts/marvell/armada-cp110.dtsi b/arch/arm64/boot/dts/marvell/armada-cp110.dtsi
index b302027..01ad82f 100644
--- a/arch/arm64/boot/dts/marvell/armada-cp110.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-cp110.dtsi
@@ -269,6 +269,7 @@ dma_xor@6a0000 {
 	reg = <0x6a0000 0x1000>,
 	      <0x6b0000 0x1000>;
 	dma-coherent;
+	dma-bus-width = <40>;
 	msi-parent = <&gic_v2m0>;
 	clocks = <&cpm_syscon0 1 8>;
 	status = "okay";
@@ -279,6 +280,7 @@ dma_xor@6c0000 {
 	reg = <0x6c0000 0x1000>,
 	      <0x6d0000 0x1000>;
 	dma-coherent;
+	dma-bus-width = <40>;
 	msi-parent = <&gic_v2m0>;
 	clocks = <&cpm_syscon0 1 7>;
 	status = "okay";
diff --git a/drivers/dma/mv_xor_v2.c b/drivers/dma/mv_xor_v2.c
index 9ff3c77b..8c72033 100644
--- a/drivers/dma/mv_xor_v2.c
+++ b/drivers/dma/mv_xor_v2.c
@@ -819,6 +819,7 @@ static int mv_xor_v2_probe(struct platform_device *pdev)
 	struct dma_device *dma_dev;
 	struct mv_xor_v2_sw_desc *sw_desc;
 	struct msi_desc *msi_desc;
+	u32 dma_bus_width;
 
 	BUILD_BUG_ON(sizeof(struct mv_xor_v2_descriptor) !=
 		     MV_XOR_V2_EXT_DESC_SIZE);
@@ -857,6 +858,18 @@ static int mv_xor_v2_probe(struct platform_device *pdev)
 	if (ret)
 		goto disable_clk;
 
+	/* Read the DMA bus width from the device-tree and configure it */
+	ret = of_property_read_u32(pdev->dev.of_node, "dma-bus-width",
+				   &dma_bus_width);
+	if (ret) {
+		dev_err(&pdev->dev, "Failed to read dma-bus-width property\n");
+		goto disable_clk;
+	}
+
+	ret = dma_set_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(dma_bus_width));
+	if (ret)
+		goto disable_clk;
+
 	msi_desc = first_msi_entry(&pdev->dev);
 	if (!msi_desc)
 		goto free_msi_irqs;
-- 
1.7.9.5

