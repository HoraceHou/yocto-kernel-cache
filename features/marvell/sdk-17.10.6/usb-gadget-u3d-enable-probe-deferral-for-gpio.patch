From 2e8c3a3736f00f1a37885db62274b266efa282d6 Mon Sep 17 00:00:00 2001
From: Grzegorz Jaszczyk <jaz@semihalf.com>
Date: Thu, 12 Jan 2017 16:02:18 +0100
Subject: [PATCH 0936/1345] usb: gadget: u3d: enable probe deferral for gpio

commit  187fbe623c646297f869604856cdef186231bba6 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Since the vbus-gpio can be a gpio from pca953x io-expander, it can be not
available during usb gadget probe, therefor enable probe deferral.

Change-Id: I4fc13bc5a3b672b0e72644a142461064d7360c7c
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/38534
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/usb/gadget/udc/mvebu_u3d.c |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/usb/gadget/udc/mvebu_u3d.c b/drivers/usb/gadget/udc/mvebu_u3d.c
index 680a7d5..bd2d26b 100644
--- a/drivers/usb/gadget/udc/mvebu_u3d.c
+++ b/drivers/usb/gadget/udc/mvebu_u3d.c
@@ -2339,6 +2339,11 @@ static int mvc2_probe(struct platform_device *pdev)
 
 	/* setup vbus gpio */
 	cp->vbus_pin = of_get_named_gpio(pdev->dev.of_node, "vbus-gpio", 0);
+	if ((cp->vbus_pin == -ENODEV) || (cp->vbus_pin == -EPROBE_DEFER)) {
+		ret = -EPROBE_DEFER;
+		goto err_clk;
+	}
+
 	if (cp->vbus_pin < 0)
 		cp->vbus_pin = -ENODEV;
 
-- 
1.7.9.5

