From c390bf1e51173af7a3e49594c2931ff8bfb493bf Mon Sep 17 00:00:00 2001
From: allen yan <yanwei@marvell.com>
Date: Fri, 30 Dec 2016 22:09:18 +0800
Subject: [PATCH 0732/1345] uart: a3700: add multiple uart port support

commit  a0bc4a30eaf4e41c2d5237867c5f9e93a7d1d363 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

- The uart driver can only support single uart port now.
  This patch updated the existing driver to extend the
  maximum port number up to 2. The driver is supposed to
  take the uart alias in device-tree as the port index.

Change-Id: If4d114a38d5bf6973494665dcec7dbfd6c41fc53
Signed-off-by: allen yan <yanwei@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/35173
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Wilson Ding <dingwei@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/tty/serial/mvebu-uart.c |   15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/tty/serial/mvebu-uart.c b/drivers/tty/serial/mvebu-uart.c
index 0db1b0f..e00e487 100644
--- a/drivers/tty/serial/mvebu-uart.c
+++ b/drivers/tty/serial/mvebu-uart.c
@@ -87,7 +87,7 @@
 
 #define UART_BRDV		0x10
 
-#define MVEBU_NR_UARTS		1
+#define MVEBU_NR_UARTS		2
 
 #define MVEBU_UART_TYPE		"mvebu-uart"
 #define DRIVER_NAME		"mvebu-serial"
@@ -560,7 +560,15 @@ static int mvebu_uart_probe(struct platform_device *pdev)
 		return -EINVAL;
 	}
 
-	port = &mvebu_uart_ports[0];
+	if (pdev->dev.of_node)
+		pdev->id = of_alias_get_id(pdev->dev.of_node, "serial");
+
+	if (pdev->id >= MVEBU_NR_UARTS) {
+		dev_err(&pdev->dev, "exceed max uart ports\n");
+		return -EINVAL;
+	}
+
+	port = &mvebu_uart_ports[pdev->id];
 
 	spin_lock_init(&port->lock);
 
@@ -572,7 +580,7 @@ static int mvebu_uart_probe(struct platform_device *pdev)
 	port->fifosize   = 32;
 	port->iotype     = UPIO_MEM32;
 	port->flags      = UPF_FIXED_PORT;
-	port->line       = 0; /* single port: force line number to  0 */
+	port->line       = pdev->id;
 
 	port->irq        = irq->start;
 	port->irqflags   = IRQF_SHARED;
@@ -595,6 +603,7 @@ static int mvebu_uart_probe(struct platform_device *pdev)
 	ret = uart_add_one_port(&mvebu_uart_driver, port);
 	if (ret)
 		return ret;
+
 	return 0;
 }
 
-- 
1.7.9.5

