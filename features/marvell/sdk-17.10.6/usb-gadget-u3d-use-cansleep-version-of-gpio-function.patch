From 7027862abafe5f894d65f010dab955cb6bf7edc5 Mon Sep 17 00:00:00 2001
From: Grzegorz Jaszczyk <jaz@semihalf.com>
Date: Tue, 17 Jan 2017 17:03:44 +0100
Subject: [PATCH 0937/1345] usb: gadget: u3d: use 'cansleep' version of gpio
 function

commit  addcb135894f3e6843d02d893030cf83d1349f95 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Because now the vbus_pin source can be gpio from PCA9555, reading the gpio
value is an i2c transaction which can sleep. Therefore use appropriate gpio
function from the gpio API (gpio_get_value_cansleep) to silence Linux WARN.

Change-Id: Ia17d780c046deef5670de3a2cefc3f1d3386fa10
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/38535
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/usb/gadget/udc/mvebu_u3d.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/usb/gadget/udc/mvebu_u3d.c b/drivers/usb/gadget/udc/mvebu_u3d.c
index bd2d26b..4b2b9e1 100644
--- a/drivers/usb/gadget/udc/mvebu_u3d.c
+++ b/drivers/usb/gadget/udc/mvebu_u3d.c
@@ -1519,7 +1519,7 @@ static void mvc2_vbus_work(struct work_struct *work)
 	cp = container_of(work, struct mvc2, vbus_work);
 
 	if (gpio_is_valid(cp->vbus_pin))
-		vbus = gpio_get_value(cp->vbus_pin);
+		vbus = gpio_get_value_cansleep(cp->vbus_pin);
 	else {
 		dev_err(cp->dev, "VBUS interrupt status is missing\n");
 		return;
-- 
1.7.9.5

