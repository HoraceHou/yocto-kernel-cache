From 7b0f90cc9acb98b6d7d5c3a101002547b9fb4310 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Thu, 26 Jan 2017 13:40:51 +0200
Subject: [PATCH 0762/1345] fix: net: mvpp2x: if dropped skb -> transmit all
 bulked descriptors

commit  33e2c3ee31d4f4b28facec4c9cc9df3fbabbe3a0 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Issue:
- In some scenarios skb's were bulked in aggregation queue and packets
  dropped due to lack of TXQ descriptors. This will cause traffic stuck
  and descriptors won't be released by CPU.

Fix:
- In case of dropped skb -> transmit all bulked descriptors.

Change-Id: I7c8cc961272f36fc6ca2c4a46313d555d16230d8
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/36071
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 5fe1a69..32f297d 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -3001,6 +3001,11 @@ static int mv_pp2x_tx(struct sk_buff *skb, struct net_device *dev)
 		stats->tx_bytes += skb->len;
 		u64_stats_update_end(&stats->syncp);
 	} else {
+		/* Transmit bulked descriptors*/
+		if (aggr_txq->xmit_bulk > 0) {
+			mv_pp2x_aggr_txq_pend_desc_add(port, aggr_txq->xmit_bulk);
+			aggr_txq->xmit_bulk = 0;
+		}
 		dev->stats.tx_dropped++;
 		dev_kfree_skb_any(skb);
 	}
-- 
1.7.9.5

