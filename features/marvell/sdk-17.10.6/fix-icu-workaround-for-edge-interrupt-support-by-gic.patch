From 94ccb36c9f03fc6c8e6e9898d2d34093f648cfaf Mon Sep 17 00:00:00 2001
From: nsamsono <nsamsono@marvell.com>
Date: Mon, 10 Jul 2017 16:07:51 +0300
Subject: [PATCH 1072/1345] fix: icu: workaround for edge interrupt support by
 gicp

commit  00764b909a2adce0479c1f0cfca3036213beed29 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Workaround for edge interrupts support by GICP:
Since GICP supports only level interrupts and don't clear
edge interrupts, we need to clear interrupt by ourselves.
Clear the interrupt only for interrupts configured as Edge.

Change-Id: I25bb039f759751cafde3e15ca7c1438fd4ab760d
Signed-off-by: nsamsono <nsamsono@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/41413
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/irqchip/irq-mvebu-icu.c |   21 ++++++++++++++++++++-
 1 file changed, 20 insertions(+), 1 deletion(-)

diff --git a/drivers/irqchip/irq-mvebu-icu.c b/drivers/irqchip/irq-mvebu-icu.c
index 91f9610..88eca01 100644
--- a/drivers/irqchip/irq-mvebu-icu.c
+++ b/drivers/irqchip/irq-mvebu-icu.c
@@ -82,11 +82,30 @@ struct mvebu_icu_irq_data {
 static DEFINE_SPINLOCK(icu_lock);
 static DECLARE_BITMAP(icu_irq_alloc, ICU_MAX_SPI_IRQ_IN_GIC);
 
+static void mvebu_icu_irq_chip_eoi(struct irq_data *data)
+{
+	struct mvebu_icu_irq_data *icu = data->domain->host_data;
+	struct irq_data *irq_parent = data->parent_data;
+	int irq_msg_num = ICU_GET_GIC_IDX(irqd_to_hwirq(irq_parent));
+
+	if (!irqd_is_level_type(data)) {
+		/*
+		 * Workaround for edge interrupts support by GICP:
+		 * Since GICP supports only level interrupts and don't clear
+		 * edge interrupts, we need to clear interrupt by ourselves.
+		 * Clear the interrupt only for interrupts configured as Edge.
+		 */
+		writel(irq_msg_num, icu->gicp_clr_spi_base);
+	}
+	/* Invoke the standard EOI on the parent interrupt function */
+	irq_chip_eoi_parent(data);
+}
+
 static struct irq_chip mvebu_icu_irq_chip = {
 	.name			= "ICU",
 	.irq_mask		= irq_chip_mask_parent,
 	.irq_unmask		= irq_chip_unmask_parent,
-	.irq_eoi		= irq_chip_eoi_parent,
+	.irq_eoi		= mvebu_icu_irq_chip_eoi,
 	.irq_set_type           = irq_chip_set_type_parent,
 #ifdef CONFIG_SMP
 	.irq_set_affinity       = irq_chip_set_affinity_parent,
-- 
1.7.9.5

