From 6d33e1b3d962a77113b8b5672cb7b0f5704fcd38 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Tue, 26 Jul 2016 14:27:29 +0300
Subject: [PATCH 0385/1345] fix: net: mvpp2x: Increase TX FIFO threshold to
 maximum.

commit  f3b64aa62ff5ca6c2c922649e279341d55d5f508 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: I6f49902aad1b3cedf15d52f2b6023c178c904966
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/31460
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x.h      |    6 ++++++
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c   |    9 ++++++++-
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h   |    4 +++-
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |   13 ++++++++++---
 4 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x.h b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x.h
index dcdf859..545fa57 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x.h
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x.h
@@ -164,6 +164,12 @@
 #define MVPP2_TX_FIFO_DATA_SIZE_10KB		0xa
 #define MVPP2_TX_FIFO_DATA_SIZE_3KB		0x3
 
+#define MVPP2_TX_FIFO_MINIMUM_THRESHOLD		256
+#define MVPP2_TX_FIFO_THRESHOLD_10KB	(MVPP2_TX_FIFO_DATA_SIZE_10KB * 1024 - \
+					MVPP2_TX_FIFO_MINIMUM_THRESHOLD)
+#define MVPP2_TX_FIFO_THRESHOLD_3KB	(MVPP2_TX_FIFO_DATA_SIZE_3KB * 1024 - \
+					MVPP2_TX_FIFO_MINIMUM_THRESHOLD)
+
 enum mvppv2_version {
 	PPV21 = 21,
 	PPV22
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
index f057b83..1c4eae5 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
@@ -6150,9 +6150,16 @@ void mv_pp22_rss_c2_enable(struct mv_pp2x_port *port, bool en)
 }
 
 /* Initialize Tx FIFO's */
-void mv_pp2x_tx_fifo_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val)
+void mv_pp2x_tx_fifo_size_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val)
 {
 	mv_pp2x_write(hw,
 		      MVPP22_TX_FIFO_SIZE_REG(port_id),
 		      val & MVPP22_TX_FIFO_SIZE_MASK);
 }
+
+void mv_pp2x_tx_fifo_threshold_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val)
+{
+	mv_pp2x_write(hw,
+		      MVPP22_TX_FIFO_THRESH_REG(port_id),
+		      val & MVPP22_TX_FIFO_THRESH_MASK);
+}
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
index cc33948..c7e6304 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
@@ -776,6 +776,8 @@ int mv_pp22_rss_tbl_entry_get(struct mv_pp2x_hw *hw,
 
 void mv_pp22_rss_c2_enable(struct mv_pp2x_port *port, bool en);
 
-void mv_pp2x_tx_fifo_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val);
+void mv_pp2x_tx_fifo_size_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val);
+
+void mv_pp2x_tx_fifo_threshold_set(struct mv_pp2x_hw *hw, u32 port_id, u32 val);
 
 #endif /* _MVPP2_HW_H_ */
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index bc9d630..a27c9b6 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -4468,14 +4468,21 @@ static void mv_pp2x_tx_fifo_init(struct mv_pp2x *priv)
 
 	/* Set FIFO according to l4_chksum_jumbo_port */
 	for (i = 0; i < priv->num_ports; i++) {
-		if (priv->port_list[i]->id != priv->l4_chksum_jumbo_port)
-			mv_pp2x_tx_fifo_set(&priv->hw,
+		if (priv->port_list[i]->id != priv->l4_chksum_jumbo_port) {
+			mv_pp2x_tx_fifo_size_set(&priv->hw,
 					    priv->port_list[i]->id,
 					    MVPP2_TX_FIFO_DATA_SIZE_3KB);
+			mv_pp2x_tx_fifo_threshold_set(&priv->hw,
+					    priv->port_list[i]->id,
+					    MVPP2_TX_FIFO_THRESHOLD_3KB);
+			}
 	}
-	mv_pp2x_tx_fifo_set(&priv->hw,
+	mv_pp2x_tx_fifo_size_set(&priv->hw,
 			    priv->l4_chksum_jumbo_port,
 			    MVPP2_TX_FIFO_DATA_SIZE_10KB);
+	mv_pp2x_tx_fifo_threshold_set(&priv->hw,
+			    priv->l4_chksum_jumbo_port,
+			    MVPP2_TX_FIFO_THRESHOLD_10KB);
 }
 
 static int mv_pp2x_probe(struct platform_device *pdev)
-- 
1.7.9.5

