From f4656c53c22552c7e7b753f1154bf87d55a6e37d Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Thu, 22 Dec 2016 12:04:21 +0200
Subject: [PATCH 0700/1345] fix: net: mvpp2x: fix wrong link state in
 auto-negotiation off mode

commit  e7801a304ec34bfc2ed55e559ba6ea95fa404c4d from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

- Fix ifconfig/ethtool wrong link state in auto-negotiation off mode.
  netif carrier and netif tx should be stopped/started during link event
  procedure.

Change-Id: Ie2ea48a9510b9ed82dd9a1091043338d454ab337
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/34909
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |    4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 32d807a..40db662 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -1728,6 +1728,8 @@ static void mv_pp22_link_event(struct net_device *dev)
 					      &port->mac_data);
 			mv_pp2x_egress_enable(port);
 			mv_pp2x_ingress_enable(port);
+			netif_carrier_on(dev);
+			netif_tx_wake_all_queues(dev);
 			mv_gop110_port_events_unmask(&port->priv->hw.gop,
 						     &port->mac_data);
 			port->mac_data.flags |= MV_EMAC_F_LINK_UP;
@@ -1739,6 +1741,8 @@ static void mv_pp22_link_event(struct net_device *dev)
 						   &port->mac_data);
 			mv_gop110_port_disable(&port->priv->hw.gop,
 					       &port->mac_data);
+			netif_carrier_off(dev);
+			netif_tx_stop_all_queues(dev);
 			port->mac_data.flags &= ~MV_EMAC_F_LINK_UP;
 			netdev_info(dev, "link down\n");
 		}
-- 
1.7.9.5

