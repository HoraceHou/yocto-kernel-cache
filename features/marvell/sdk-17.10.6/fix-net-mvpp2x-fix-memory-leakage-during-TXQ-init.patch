From adf43d8ab2d294b3a12ca51361495f2b522b3f80 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Wed, 28 Jun 2017 16:38:30 +0300
Subject: [PATCH 1074/1345] fix: net: mvpp2x: fix memory leakage during TXQ
 init

commit  96fc4f09cd9cecef09f40077ce259014a8ad4d0e from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Wrong memory size were released by dma_free_coherent in TXQ init
procedure.

Change-Id: I994c35da67601e9f5b8e8d84d82f22e2e5b6a69d
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/40963
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 01b7f26b4..94ece81 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -1447,7 +1447,7 @@ static int mv_pp2x_txq_init(struct mv_pp2x_port *port,
 	}
 
 	dma_free_coherent(port->dev->dev.parent,
-			  txq->size * MVPP2_DESC_ALIGNED_SIZE,
+			  MVPP2_DESCQ_MEM_SIZE(txq->size),
 			  txq->first_desc, txq->descs_phys);
 
 	return -ENOMEM;
-- 
1.7.9.5

