From 4b68c6213402442a0bcedb2e3fd47f7231a62d61 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Mon, 18 Jul 2016 19:10:10 +0300
Subject: [PATCH 0353/1345] net: mvpp2x: increment txq put index in case of
 error

commit  02be32c664266fe6cf5574468761b2bda50d0303 from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

Change-Id: I589279494793ff229590cd3e30aad18158a70c91
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/31223
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |   16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 880f049..02bf93b 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -199,6 +199,19 @@ static void mv_pp2x_txq_inc_get(struct mv_pp2x_txq_pcpu *txq_pcpu)
 		txq_pcpu->txq_get_index = 0;
 }
 
+void mv_pp2x_txq_inc_error(struct mv_pp2x_txq_pcpu *txq_pcpu, int num)
+{
+	for (; num > 0; num--) {
+		txq_pcpu->txq_put_index--;
+		if (txq_pcpu->txq_put_index < 0)
+			txq_pcpu->txq_put_index = txq_pcpu->size - 1;
+		txq_pcpu->tx_skb[txq_pcpu->txq_put_index] = 0;
+		txq_pcpu->data_size[txq_pcpu->txq_put_index] = 0;
+		txq_pcpu->tx_buffs[txq_pcpu->txq_put_index] = 0;
+	}
+}
+
+
 void mv_pp2x_txq_inc_put(enum mvppv2_version pp2_ver,
 			 struct mv_pp2x_txq_pcpu *txq_pcpu,
 			 struct sk_buff *skb,
@@ -2329,6 +2342,8 @@ static int mv_pp2x_tx_frag_process(struct mv_pp2x_port *port,
 	/* Release all descriptors that were used to map fragments of
 	 * this packet, as well as the corresponding DMA mappings
 	 */
+	 mv_pp2x_txq_inc_error(txq_pcpu, i);
+
 	for (i = i - 1; i >= 0; i--) {
 		tx_desc = txq->first_desc + i;
 		tx_desc_unmap_put(port->dev->dev.parent, txq, tx_desc);
@@ -2443,6 +2458,7 @@ static int mv_pp2x_tx(struct sk_buff *skb, struct net_device *dev)
 		/* Continue with other skb fragments */
 		if (mv_pp2x_tx_frag_process(port, skb, aggr_txq, txq)) {
 			MVPP2_PRINT_LINE();
+			mv_pp2x_txq_inc_error(txq_pcpu, 1);
 			tx_desc_unmap_put(port->dev->dev.parent, txq, tx_desc);
 			frags = 0;
 			goto out;
-- 
1.7.9.5

