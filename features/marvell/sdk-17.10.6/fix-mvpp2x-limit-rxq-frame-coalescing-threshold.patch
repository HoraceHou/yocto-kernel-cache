From bbd53fa85ff69a65b6d923e80a0a4945c1ddb4a3 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Tue, 16 Aug 2016 14:17:53 +0300
Subject: [PATCH 0414/1345] fix: mvpp2x: limit rxq frame coalescing threshold

commit  7b2e80dffa1a32c4ebdc99a44b38561f9a6d20dd from
https://github.com/MarvellEmbeddedProcessors/linux-marvell.git

- limit rxq frame coalescing threshold with 16K value

Change-Id: I9105a155558e47bfb14a37a903d80c8ba79fcd9f
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/31971
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 .../net/ethernet/marvell/mvpp2x/mv_pp2x_ethtool.c  |    2 +-
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c   |   10 ++++------
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h   |    2 +-
 .../net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h  |    3 ++-
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c |    2 +-
 5 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_ethtool.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_ethtool.c
index 6190dfa..506cc6b 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_ethtool.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_ethtool.c
@@ -531,7 +531,7 @@ static int mv_pp2x_ethtool_set_coalesce(struct net_device *dev,
 
 		rxq->time_coal = c->rx_coalesce_usecs;
 		rxq->pkts_coal = c->rx_max_coalesced_frames;
-		mv_pp2x_rx_pkts_coal_set(port, rxq, rxq->pkts_coal);
+		mv_pp2x_rx_pkts_coal_set(port, rxq);
 		mv_pp2x_rx_time_coal_set(port, rxq, rxq->time_coal);
 	}
 	port->tx_time_coal = c->tx_coalesce_usecs;
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
index c79ef38..aca7d5f 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.c
@@ -3464,15 +3464,13 @@ void mv_pp2x_rx_csum(struct mv_pp2x_port *port, u32 status,
  * will be generated by HW.
  */
 void mv_pp2x_rx_pkts_coal_set(struct mv_pp2x_port *port,
-			      struct mv_pp2x_rx_queue *rxq, u32 pkts)
+			      struct mv_pp2x_rx_queue *rxq)
 {
-	u32 val;
+	if (rxq->pkts_coal > MVPP2_MAX_OCCUPIED_THRESH)
+		rxq->pkts_coal = MVPP2_MAX_OCCUPIED_THRESH;
 
-	val = (pkts & MVPP2_OCCUPIED_THRESH_MASK);
 	mv_pp2x_write(&port->priv->hw, MVPP2_RXQ_NUM_REG, rxq->id);
-	mv_pp2x_write(&port->priv->hw, MVPP2_RXQ_THRESH_REG, val);
-
-	rxq->pkts_coal = pkts;
+	mv_pp2x_write(&port->priv->hw, MVPP2_RXQ_THRESH_REG, rxq->pkts_coal);
 }
 
 /* Set the time delay in usec before Rx interrupt */
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
index c7e6304..c451e55 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw.h
@@ -600,7 +600,7 @@ void mv_pp22_rxq_short_pool_set(struct mv_pp2x_hw *hw,
 void mv_pp21_port_reset(struct mv_pp2x_port *port);
 
 void mv_pp2x_rx_pkts_coal_set(struct mv_pp2x_port *port,
-			      struct mv_pp2x_rx_queue *rxq, u32 pkts);
+			      struct mv_pp2x_rx_queue *rxq);
 void mv_pp2x_rx_time_coal_set(struct mv_pp2x_port *port,
 			      struct mv_pp2x_rx_queue *rxq, u32 usec);
 void mv_pp2x_tx_done_pkts_coal_set(void *arg);
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
index e322711..c4663cd 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_hw_type.h
@@ -784,7 +784,8 @@
 #define MVPP2_RXQ_NON_OCCUPIED_MASK		0x3fff0000
 #define MVPP2_RXQ_THRESH_REG			0x204c
 #define MVPP2_OCCUPIED_THRESH_OFFSET		0
-#define MVPP2_OCCUPIED_THRESH_MASK		0x3fff
+#define MVPP2_MAX_OCCUPIED_THRESH		0x3fff
+#define MVPP2_OCCUPIED_THRESH_MASK		MVPP2_MAX_OCCUPIED_THRESH
 #define MVPP2_RXQ_INDEX_REG			0x2050
 #define MVPP2_TXQ_NUM_REG			0x2080
 #define MVPP2_TXQ_DESC_ADDR_LOW_REG		0x2084
diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 3fbbcf7..3e1cb79 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -1021,7 +1021,7 @@ static int mv_pp2x_rxq_init(struct mv_pp2x_port *port,
 	mv_pp2x_rxq_offset_set(port, rxq->id, NET_SKB_PAD);
 
 	/* Set coalescing pkts and time */
-	mv_pp2x_rx_pkts_coal_set(port, rxq, rxq->pkts_coal);
+	mv_pp2x_rx_pkts_coal_set(port, rxq);
 	mv_pp2x_rx_time_coal_set(port, rxq, rxq->time_coal);
 
 	/* Add number of descriptors ready for receiving packets */
-- 
1.7.9.5

