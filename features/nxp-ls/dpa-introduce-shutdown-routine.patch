From 473543104fe18e034a5eca5dddec11fadece4e61 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Sat, 24 Nov 2018 18:42:11 +0800
Subject: [PATCH 3/9] dpa:introduce shutdown routine

Introduce device shutdown routine for dpa ethernet driver.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth.c |    3 +++
 .../ethernet/freescale/sdk_dpaa/dpaa_eth_common.c  |   20 ++++++++++++++++++++
 .../ethernet/freescale/sdk_dpaa/dpaa_eth_common.h  |    3 +++
 3 files changed, 26 insertions(+)

diff --git a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth.c b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth.c
index 1f76aa3..05123a2 100644
--- a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth.c
@@ -1141,6 +1141,9 @@ static int dpa_new_loop_id(void)
 		.pm		= DPAA_PM_OPS,
 	},
 	.probe		= dpaa_eth_priv_probe,
+#if defined(CONFIG_KEXEC)
+	.shutdown       = dpa_shutdown,
+#endif
 	.remove		= dpa_remove
 };
 
diff --git a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.c b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.c
index e3510a1..624ee7f 100644
--- a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.c
+++ b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.c
@@ -546,6 +546,26 @@ int __cold dpa_remove(struct platform_device *of_dev)
 }
 EXPORT_SYMBOL(dpa_remove);
 
+#if defined(CONFIG_KEXEC)
+void __cold dpa_shutdown(struct platform_device *of_dev)
+{
+	struct device		*dev;
+	struct net_device	*net_dev;
+	struct dpa_priv_s	*priv;
+
+	dev = &of_dev->dev;
+	net_dev = dev_get_drvdata(dev);
+
+	priv = netdev_priv(net_dev);
+
+	dpa_fq_free(dev, &priv->dpa_fq_list);
+
+	dpa_bp_free(priv);
+
+	return;
+}
+#endif
+
 struct mac_device * __cold __must_check
 __attribute__((nonnull))
 dpa_mac_probe(struct platform_device *_of_dev)
diff --git a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.h b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.h
index b039328..8b4d88b 100644
--- a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.h
+++ b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_common.h
@@ -157,6 +157,9 @@ int dpa_get_ts(const struct dpa_priv_s *priv, enum port_type rx_tx,
 #endif /* CONFIG_FSL_DPAA_TS */
 int dpa_ioctl(struct net_device *dev, struct ifreq *rq, int cmd);
 int __cold dpa_remove(struct platform_device *of_dev);
+#if defined(CONFIG_KEXEC)
+void __cold dpa_shutdown(struct platform_device *of_dev);
+#endif
 struct mac_device * __cold __must_check
 __attribute__((nonnull)) dpa_mac_probe(struct platform_device *_of_dev);
 int dpa_set_mac_address(struct net_device *net_dev, void *addr);
-- 
1.7.9.5

