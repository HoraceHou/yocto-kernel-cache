From 3b502d609260487d10ac77d9a5f76602c2d70ec2 Mon Sep 17 00:00:00 2001
From: Yunhui Cui <yunhui.cui@nxp.com>
Date: Tue, 8 Mar 2016 11:08:15 +0800
Subject: [PATCH 303/666] mtd: spi-nor: add quad mode support for flash n25q128

As to the flash n25q128, WRITE NONVOLATILE CONFIGURATION REGISTER
Command execute successfully unless Status Register write enable bit
is cleared.
This patch is used support flash n25q128 quad mode, so we move the code
to function set_quad_mode{ }.

Signed-off-by: Yunhui Cui <yunhui.cui@nxp.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/spi-nor/spi-nor.c | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index 6ad0d03..418bf5f 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -1541,6 +1541,7 @@ static int set_ddr_quad_mode(struct spi_nor *nor, const struct flash_info *info)
 static int set_quad_mode(struct spi_nor *nor, const struct flash_info *info)
 {
 	int status;
+	u8 reg_sr;
 
 	switch (JEDEC_MFR(info)) {
 	case SNOR_MFR_MACRONIX:
@@ -1551,6 +1552,13 @@ static int set_quad_mode(struct spi_nor *nor, const struct flash_info *info)
 		}
 		return status;
 	case SNOR_MFR_MICRON:
+		reg_sr = read_sr(nor);
+		if (reg_sr & ~SPI_NOR_MICRON_WRITE_ENABLE) {
+			reg_sr &= SPI_NOR_MICRON_WRITE_ENABLE;
+
+			write_enable(nor);
+			write_sr(nor, reg_sr);
+		}
 		return 0;
 	default:
 		status = spansion_quad_enable(nor);
@@ -1693,14 +1701,6 @@ int spi_nor_scan(struct spi_nor *nor, const char *name, enum read_mode mode)
 	if (ret)
 		return ret;
 
-	if (JEDEC_MFR(info) == SNOR_MFR_MICRON) {
-		ret = read_sr(nor);
-		ret &= SPI_NOR_MICRON_WRITE_ENABLE;
-
-		write_enable(nor);
-		write_sr(nor, ret);
-	}
-
 	if (EXT_ID(info) == SPINOR_S25FS_FAMILY_ID) {
 		ret = spansion_s25fs_disable_4kb_erase(nor);
 		if (ret)
-- 
2.7.4

