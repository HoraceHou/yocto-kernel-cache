From e4ed7e7afb404e01e48a5b261aa668093ee58c6a Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 9 Jul 2013 16:03:23 +0800
Subject: [PATCH 457/666] book3e/kexec/kdump: create a 1:1 TLB mapping

From http://patchwork.ozlabs.org/patch/257655/

book3e have no real MMU mode so we have to create a 1:1 TLB
mapping to make sure we can access the real physical address.
And correct something to support this pseudo real mode on book3e.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/kernel/misc_64.S | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/arch/powerpc/kernel/misc_64.S b/arch/powerpc/kernel/misc_64.S
index 8ac0bd2..b0afd47 100644
--- a/arch/powerpc/kernel/misc_64.S
+++ b/arch/powerpc/kernel/misc_64.S
@@ -562,6 +562,10 @@ kexec_create_tlb:
  */
 _GLOBAL(kexec_smp_wait)
 	lhz	r3,PACAHWCPUID(r13)
+#ifdef CONFIG_PPC_BOOK3E
+	/* Create a 1:1 mapping. */
+	bl	kexec_create_tlb
+#endif
 	bl	real_mode
 
 	li	r4,KEXEC_STATE_REAL_MODE
@@ -651,6 +655,8 @@ END_FTR_SECTION_IFSET(CPU_FTR_ARCH_300)
 	/* disable interrupts, we are overwriting kernel data next */
 #ifdef CONFIG_PPC_BOOK3E
 	wrteei	0
+	/* Create a 1:1 mapping. */
+	bl	kexec_create_tlb
 #else
 	mfmsr	r3
 	rlwinm	r3,r3,0,17,15
-- 
2.7.4

